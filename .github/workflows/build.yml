name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git libssl-dev libgmp-dev

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Generate strongSwan source files
        run: |
          cd ss-full
          ./autogen.sh
          ./configure \
            --enable-openssl \
            --enable-eap-identity \
            --enable-eap-mschapv2 \
            --enable-eap-md5 \
            --enable-eap-gtc \
            --enable-eap-tls \
            --enable-eap-ttls \
            --enable-eap-tnc

          make -j$(nproc) 2>&1 | tail -30 || echo "Host make done (partial failures OK)"

          # Ensure oid.c exists
          if [ ! -f src/libstrongswan/asn1/oid.c ]; then
            cd src/libstrongswan/asn1
            perl oid.pl oid.txt oid.c oid.h
            cd ../../..
          fi

          # Ensure Android.common.mk exists
          if [ ! -f Android.common.mk ]; then
            VERSION=$(sed -n "s/^PACKAGE_VERSION='\(.*\)'/\1/p" configure | head -1)
            echo "strongswan_VERSION := ${VERSION}" > Android.common.mk
          fi

          echo "Generated files check:"
          for f in Android.common.mk src/libstrongswan/asn1/oid.c src/libstrongswan/asn1/oid.h; do
            [ -f "$f" ] && echo "OK   $f" || echo "MISS $f"
          done

      - name: Disable BYOD to avoid missing TPM dependencies
        run: |
          cd ss-full

          # Disable BYOD in Android.mk (removes libtpmtss, libtnccs, etc.)
          JNI_MK="src/frontends/android/app/src/main/jni/Android.mk"
          echo "=== Before: BYOD setting ==="
          grep "strongswan_USE_BYOD" "${JNI_MK}"

          sed -i 's/^strongswan_USE_BYOD := true/strongswan_USE_BYOD :=/' "${JNI_MK}"

          echo "=== After: BYOD setting ==="
          grep "strongswan_USE_BYOD" "${JNI_MK}"

          # Also disable in Java code
          JAVA_DIR="src/frontends/android/app/src/main/java/org/strongswan/android"
          find "${JAVA_DIR}" -name "*.java" -exec grep -l "USE_BYOD" {} \; | while read f; do
            echo "Patching $f"
            sed -i 's/USE_BYOD = true/USE_BYOD = false/g' "$f"
          done

          # Show what the BYOD-related build list looks like now
          echo ""
          echo "=== Build modules (should NOT include libtpmtss) ==="
          grep -A20 "strongswan_BUILD" "${JNI_MK}"

      - name: Show all Android.mk dependencies
        run: |
          cd ss-full
          echo "=== libtpmtss/Android.mk (the likely culprit) ==="
          cat src/libtpmtss/Android.mk 2>/dev/null || echo "File not found"
          echo ""
          echo "=== libstrongswan shared lib deps ==="
          grep "LOCAL_SHARED_LIBRARIES\|LOCAL_STATIC_LIBRARIES" src/libstrongswan/Android.mk || true
          echo ""
          echo "=== libcharon shared lib deps ==="
          grep "LOCAL_SHARED_LIBRARIES\|LOCAL_STATIC_LIBRARIES" src/libcharon/Android.mk || true
          echo ""
          echo "=== libandroidbridge shared lib deps ==="
          grep "LOCAL_SHARED_LIBRARIES\|LOCAL_STATIC_LIBRARIES" src/frontends/android/app/src/main/jni/libandroidbridge/Android.mk || true
          echo ""
          echo "=== libipsec shared lib deps ==="
          grep "LOCAL_SHARED_LIBRARIES\|LOCAL_STATIC_LIBRARIES" src/libipsec/Android.mk || true

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL for Android
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"

          build_ssl() {
            local ABI=$1 TARGET=$2
            echo "===== Building OpenSSL for ${ABI} ====="
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            rm -rf "${BUILD_DIR}" "${OUT_DIR}"
            cp -r "openssl-${{ env.OPENSSL_VERSION }}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" \
              -D__ANDROID_API__=21 \
              --prefix="${OUT_DIR}" \
              --openssldir="${OUT_DIR}" \
              --libdir=lib \
              no-tests no-ui-console
            make -j$(nproc)
            make install_sw
            cd "${GITHUB_WORKSPACE}"
          }

          build_ssl arm64-v8a android-arm64
          build_ssl armeabi-v7a android-arm
          build_ssl x86 android-x86
          build_ssl x86_64 android-x86_64

      - name: Setup OpenSSL in JNI directory
        run: |
          set -e
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          mkdir -p "${OSSL}/include"
          cp -r "${GITHUB_WORKSPACE}/openssl-out-arm64-v8a/include/openssl" "${OSSL}/include/"

          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            DEST="${OSSL}/${ABI}"
            mkdir -p "${DEST}"
            OUT="${GITHUB_WORKSPACE}/openssl-out-${ABI}/lib"
            for LIB in libcrypto libssl; do
              REAL=$(find "${OUT}" -name "${LIB}.so*" ! -type l 2>/dev/null | head -1)
              if [ -n "${REAL}" ]; then
                cp "${REAL}" "${DEST}/${LIB}.so"
              else
                cp -L "${OUT}/${LIB}.so" "${DEST}/${LIB}.so"
              fi
            done
            echo "${ABI}: $(ls ${DEST}/)"
          done

      - name: Create openssl Android.mk
        run: |
          TARGET="ss-full/src/frontends/android/app/src/main/jni/openssl/Android.mk"
          printf 'LOCAL_PATH := $(call my-dir)\n\n' > "${TARGET}"
          printf 'include $(CLEAR_VARS)\n' >> "${TARGET}"
          printf 'LOCAL_MODULE := libcrypto\n' >> "${TARGET}"
          printf 'LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so\n' >> "${TARGET}"
          printf 'LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include\n' >> "${TARGET}"
          printf 'include $(PREBUILT_SHARED_LIBRARY)\n\n' >> "${TARGET}"
          printf 'include $(CLEAR_VARS)\n' >> "${TARGET}"
          printf 'LOCAL_MODULE := libssl\n' >> "${TARGET}"
          printf 'LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so\n' >> "${TARGET}"
          printf 'LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include\n' >> "${TARGET}"
          printf 'include $(PREBUILT_SHARED_LIBRARY)\n' >> "${TARGET}"
          echo "=== openssl/Android.mk ==="
          cat "${TARGET}"

      - name: Diagnostic ndk-build dry run
        run: |
          cd ss-full/src/frontends/android/app/src/main/jni
          echo "=== Testing ndk-build (dry run) ==="
          ${ANDROID_NDK_HOME}/ndk-build \
            NDK_PROJECT_PATH=null \
            APP_BUILD_SCRIPT=$(pwd)/Android.mk \
            NDK_APPLICATION_MK=$(pwd)/Application.mk \
            APP_ABI=arm64-v8a \
            NDK_DEBUG=1 \
            APP_PLATFORM=android-21 \
            NDK_OUT=/tmp/ndk-out \
            NDK_LIBS_OUT=/tmp/ndk-libs \
            -n -B 2>&1 | tail -5
          echo ""
          echo "=== ndk-build dry run exit code: ${PIPESTATUS[0]} ==="
          echo ""
          # If it failed, show the error
          ${ANDROID_NDK_HOME}/ndk-build \
            NDK_PROJECT_PATH=null \
            APP_BUILD_SCRIPT=$(pwd)/Android.mk \
            NDK_APPLICATION_MK=$(pwd)/Application.mk \
            APP_ABI=arm64-v8a \
            NDK_DEBUG=1 \
            APP_PLATFORM=android-21 \
            NDK_OUT=/tmp/ndk-out \
            NDK_LIBS_OUT=/tmp/ndk-libs \
            -n -B 2>&1 | grep -i "undefined\|missing\|depends on\|error\|Stop\|cannot find" | head -20
          echo ""
          echo "Dry run complete"

      - name: Build APK
        run: |
          cd ss-full/src/frontends/android
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties

          set +e
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"
          RESULT=${PIPESTATUS[0]}
          set -e

          if [ ${RESULT} -ne 0 ]; then
            echo ""
            echo "##############################################"
            echo "# BUILD FAILED"
            echo "##############################################"
            echo ""
            echo "=== Missing module errors ==="
            grep -i "depends on undefined\|missing dep\|undefined modules" "${GITHUB_WORKSPACE}/build.log" | head -10
            echo ""
            echo "=== C/C++ compilation errors ==="
            grep "error:" "${GITHUB_WORKSPACE}/build.log" | grep -v "Exception\|ProcessException\|CXX1429\|error when building\|IssueReporter" | head -20
            echo ""
            echo "=== Make errors ==="
            grep -E "^make:|Stop\.|No rule to make|cannot find" "${GITHUB_WORKSPACE}/build.log" | head -10
            echo ""
            echo "=== Linker errors ==="
            grep "undefined reference\|cannot find -l" "${GITHUB_WORKSPACE}/build.log" | head -20
            echo ""
            echo "=== Last 40 lines before FAILED ==="
            FAIL_LINE=$(grep -n "FAILED" "${GITHUB_WORKSPACE}/build.log" | head -1 | cut -d: -f1)
            if [ -n "${FAIL_LINE}" ]; then
              START=$((FAIL_LINE - 40))
              [ $START -lt 1 ] && START=1
              sed -n "${START},${FAIL_LINE}p" "${GITHUB_WORKSPACE}/build.log"
            else
              tail -50 "${GITHUB_WORKSPACE}/build.log"
            fi
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strongswan-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
