name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"
  CUSTOM_APP_ID: "com.asadvpn.client"
  CUSTOM_APP_NAME: "AsadVPN"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git libssl-dev libgmp-dev

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Generate strongSwan source files
        run: |
          cd ss-full
          ./autogen.sh
          ./configure \
            --enable-openssl \
            --enable-eap-identity \
            --enable-eap-mschapv2 \
            --enable-eap-md5 \
            --enable-eap-gtc \
            --enable-eap-tls \
            --enable-eap-ttls \
            --enable-eap-tnc
          make -j$(nproc) 2>&1 | tail -20 || echo "Host make done"
          if [ ! -f src/libstrongswan/asn1/oid.c ]; then
            cd src/libstrongswan/asn1 && perl oid.pl oid.txt oid.c oid.h && cd ../../..
          fi
          if [ ! -f Android.common.mk ]; then
            VERSION=$(sed -n "s/^PACKAGE_VERSION='\(.*\)'/\1/p" configure | head -1)
            echo "strongswan_VERSION := ${VERSION}" > Android.common.mk
          fi

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL for Android
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"
          build_ssl() {
            local ABI=$1 TARGET=$2
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            rm -rf "${BUILD_DIR}" "${OUT_DIR}"
            cp -r "openssl-${{ env.OPENSSL_VERSION }}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" -D__ANDROID_API__=21 --prefix="${OUT_DIR}" --openssldir="${OUT_DIR}" --libdir=lib no-tests no-ui-console
            make -j$(nproc)
            make install_sw
            cd "${GITHUB_WORKSPACE}"
          }
          build_ssl arm64-v8a android-arm64
          build_ssl armeabi-v7a android-arm
          build_ssl x86 android-x86
          build_ssl x86_64 android-x86_64

      - name: Setup OpenSSL in JNI directory
        run: |
          set -e
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          mkdir -p "${OSSL}/include"
          cp -r "${GITHUB_WORKSPACE}/openssl-out-arm64-v8a/include/openssl" "${OSSL}/include/"
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            DEST="${OSSL}/${ABI}"
            mkdir -p "${DEST}"
            OUT="${GITHUB_WORKSPACE}/openssl-out-${ABI}/lib"
            for LIB in libcrypto libssl; do
              REAL=$(find "${OUT}" -name "${LIB}.so*" ! -type l 2>/dev/null | head -1)
              if [ -n "${REAL}" ]; then cp "${REAL}" "${DEST}/${LIB}.so"
              else cp -L "${OUT}/${LIB}.so" "${DEST}/${LIB}.so"; fi
            done
          done

      - name: Create openssl Android.mk
        run: |
          TARGET="ss-full/src/frontends/android/app/src/main/jni/openssl/Android.mk"
          cat > "${TARGET}" << 'ENDOFMK'
          LOCAL_PATH := $(call my-dir)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libcrypto
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := crypto_static
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libssl
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := ssl_static
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)
          ENDOFMK
          sed -i 's/^          //' "${TARGET}"

      - name: Patch strongSwan for build
        run: |
          cd ss-full
          JNI_MK="src/frontends/android/app/src/main/jni/Android.mk"
          JNI_DIR="src/frontends/android/app/src/main/jni"
          sed -i 's/^strongswan_USE_BYOD := true/strongswan_USE_BYOD :=/' "${JNI_MK}"
          sed -i 's/ eap-tls//' "${JNI_MK}"
          find src/frontends/android -name "*.java" -exec grep -l "USE_BYOD" {} \; | while read f; do
            sed -i 's/USE_BYOD = true/USE_BYOD = false/g' "$f"
          done
          find "${JNI_DIR}" -name "*.mk" -exec grep -l "crypto_static\|ssl_static" {} \; 2>/dev/null | while read mkfile; do
            sed -i '/LOCAL_STATIC_LIBRARIES.*crypto_static/{ s/crypto_static// }' "${mkfile}"
            sed -i '/LOCAL_STATIC_LIBRARIES.*ssl_static/{ s/ssl_static// }' "${mkfile}"
            if ! grep -q "LOCAL_SHARED_LIBRARIES.*crypto_static" "${mkfile}"; then
              if grep -q "LOCAL_SHARED_LIBRARIES" "${mkfile}"; then
                sed -i '0,/LOCAL_SHARED_LIBRARIES/{s/LOCAL_SHARED_LIBRARIES\(.*\)/LOCAL_SHARED_LIBRARIES\1 crypto_static ssl_static/}' "${mkfile}"
              else
                sed -i '/include \$(BUILD_SHARED_LIBRARY)/i LOCAL_SHARED_LIBRARIES += crypto_static ssl_static' "${mkfile}"
              fi
            fi
          done

      - name: Rebrand as AsadVPN
        run: |
          cd ss-full/src/frontends/android
          sed -i "s|applicationId \"org.strongswan.android\"|applicationId \"${CUSTOM_APP_ID}\"|g" app/build.gradle
          find . -name "strings.xml" | while read str; do
            sed -i "s|<string name=\"app_name\">strongSwan VPN Client</string>|<string name=\"app_name\">${CUSTOM_APP_NAME}</string>|g" "${str}"
          done
          sed -i 's|android:authorities="org.strongswan.android.content.log"|android:authorities="com.asadvpn.client.content.log"|g' app/src/main/AndroidManifest.xml
          find . -name "LogContentProvider.java" | while read f; do
            sed -i 's|org.strongswan.android.content.log|com.asadvpn.client.content.log|g' "$f"
          done
          grep -rl "org.strongswan.android.content.log" app/src/main/ 2>/dev/null | while read f; do
            sed -i 's|org.strongswan.android.content.log|com.asadvpn.client.content.log|g' "$f"
          done
          MANIFEST="app/src/main/AndroidManifest.xml"
          sed -i 's|org.strongswan.android.action.START_PROFILE|com.asadvpn.client.action.START_PROFILE|g' "${MANIFEST}"
          sed -i 's|org.strongswan.android.action.DISCONNECT|com.asadvpn.client.action.DISCONNECT|g' "${MANIFEST}"
          find . -name "VpnProfileControlActivity.java" | while read f; do
            sed -i 's|org.strongswan.android.action.START_PROFILE|com.asadvpn.client.action.START_PROFILE|g' "$f"
            sed -i 's|org.strongswan.android.action.DISCONNECT|com.asadvpn.client.action.DISCONNECT|g' "$f"
            sed -i 's|org.strongswan.android.VPN_PROFILE_UUID|com.asadvpn.client.VPN_PROFILE_UUID|g' "$f"
            sed -i 's|org.strongswan.android.VPN_PROFILE_ID|com.asadvpn.client.VPN_PROFILE_ID|g' "$f"
            sed -i 's|org.strongswan.android.VpnNotSupportedError|com.asadvpn.client.VpnNotSupportedError|g' "$f"
          done

      - name: Generate lioness app icon
        run: |
          cd ss-full/src/frontends/android
          RES_DIR="app/src/main/res"
          for DIR in drawable drawable-v24 mipmap-anydpi-v26; do mkdir -p "${RES_DIR}/${DIR}"; done
          cat > "${RES_DIR}/drawable/ic_launcher_foreground.xml" << 'ICON_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#1a1a2e" android:pathData="M54,54m-54,0a54,54 0,1 1,108 0a54,54 0,1 1,-108 0"/>
              <path android:fillColor="#C4954A" android:pathData="M54,22 C38,22 28,30 26,38 C24,44 24,50 26,54 C24,58 23,62 25,68 C27,74 32,80 38,83 C42,85 48,86 54,86 C60,86 66,85 70,83 C76,80 81,74 83,68 C85,62 84,58 82,54 C84,50 84,44 82,38 C80,30 70,22 54,22Z"/>
              <path android:fillColor="#E8C07A" android:pathData="M54,30 C42,30 34,36 32,42 C30,48 32,54 34,58 C36,64 42,72 48,76 C50,77 52,78 54,78 C56,78 58,77 60,76 C66,72 72,64 74,58 C76,54 78,48 76,42 C74,36 66,30 54,30Z"/>
              <path android:fillColor="#C4954A" android:pathData="M32,36 L26,24 L36,30Z"/>
              <path android:fillColor="#C4954A" android:pathData="M76,36 L82,24 L72,30Z"/>
              <path android:fillColor="#D4A574" android:pathData="M33,35 L29,27 L36,32Z"/>
              <path android:fillColor="#D4A574" android:pathData="M75,35 L79,27 L72,32Z"/>
              <path android:fillColor="#2D5A27" android:pathData="M42,48 C42,45 44,43 47,43 C50,43 52,45 52,48 C52,51 50,53 47,53 C44,53 42,51 42,48Z"/>
              <path android:fillColor="#2D5A27" android:pathData="M56,48 C56,45 58,43 61,43 C64,43 66,45 66,48 C66,51 64,53 61,53 C58,53 56,51 56,48Z"/>
              <path android:fillColor="#111111" android:pathData="M45,47 C45,46 46,45 47,45 C48,45 49,46 49,47 C49,48 48,49 47,49 C46,49 45,48 45,47Z"/>
              <path android:fillColor="#111111" android:pathData="M59,47 C59,46 60,45 61,45 C62,45 63,46 63,47 C63,48 62,49 61,49 C60,49 59,48 59,47Z"/>
              <path android:fillColor="#FFFFFF" android:pathData="M46,46 C46,45.5 46.5,45 47,45 C47.5,45 47.5,45.5 47,46Z"/>
              <path android:fillColor="#FFFFFF" android:pathData="M60,46 C60,45.5 60.5,45 61,45 C61.5,45 61.5,45.5 61,46Z"/>
              <path android:fillColor="#8B5E3C" android:pathData="M50,57 L54,54 L58,57 L56,60 L52,60Z"/>
              <path android:fillColor="#A0704D" android:pathData="M52,56 L54,54 L56,56 L54,58Z"/>
              <path android:strokeColor="#8B5E3C" android:strokeWidth="1" android:fillColor="#00000000" android:pathData="M54,60 L54,64"/>
              <path android:strokeColor="#8B5E3C" android:strokeWidth="1" android:fillColor="#00000000" android:pathData="M54,64 Q48,68 44,66"/>
              <path android:strokeColor="#8B5E3C" android:strokeWidth="1" android:fillColor="#00000000" android:pathData="M54,64 Q60,68 64,66"/>
              <path android:fillColor="#C4954A" android:pathData="M38,58 m-1,0 a1,1 0 1,1 2,0 a1,1 0 1,1 -2,0"/>
              <path android:fillColor="#C4954A" android:pathData="M36,62 m-1,0 a1,1 0 1,1 2,0 a1,1 0 1,1 -2,0"/>
              <path android:fillColor="#C4954A" android:pathData="M38,66 m-1,0 a1,1 0 1,1 2,0 a1,1 0 1,1 -2,0"/>
              <path android:fillColor="#C4954A" android:pathData="M70,58 m-1,0 a1,1 0 1,1 2,0 a1,1 0 1,1 -2,0"/>
              <path android:fillColor="#C4954A" android:pathData="M72,62 m-1,0 a1,1 0 1,1 2,0 a1,1 0 1,1 -2,0"/>
              <path android:fillColor="#C4954A" android:pathData="M70,66 m-1,0 a1,1 0 1,1 2,0 a1,1 0 1,1 -2,0"/>
              <path android:fillColor="#00d4aa" android:pathData="M78,70 L86,66 L86,76 C86,80 82,84 78,86 C74,84 70,80 70,76 L70,66Z"/>
              <path android:fillColor="#1a1a2e" android:pathData="M75,74 L81,74 L81,80 L75,80Z"/>
              <path android:fillColor="#00000000" android:strokeColor="#1a1a2e" android:strokeWidth="1.5" android:pathData="M76,74 L76,72 C76,70 77,69 78,69 C79,69 80,70 80,72 L80,74"/>
          </vector>
          ICON_EOF
          cat > "${RES_DIR}/drawable/ic_launcher_background.xml" << 'BG_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#1a1a2e" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          BG_EOF
          cat > "${RES_DIR}/mipmap-anydpi-v26/ic_launcher.xml" << 'ADP'
          <?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          ADP
          cp "${RES_DIR}/mipmap-anydpi-v26/ic_launcher.xml" "${RES_DIR}/mipmap-anydpi-v26/ic_launcher_round.xml"
          python3 << 'PYEOF'
          import struct, zlib, os
          def create_png(w,h,bg,fg):
              raw=[]
              cx,cy=w//2,h//2;r=min(w,h)//2-2
              for y in range(h):
                  row=[0]
                  for x in range(w):
                      dx,dy=x-cx,y-cy;row.extend(fg if dx*dx+dy*dy<=r*r else bg)
                  raw.append(bytes(row))
              raw_data=b''.join(raw)
              def chunk(ct,d):c=ct+d;return struct.pack('>I',len(d))+c+struct.pack('>I',zlib.crc32(c)&0xffffffff)
              return b'\x89PNG\r\n\x1a\n'+chunk(b'IHDR',struct.pack('>IIBBBBB',w,h,8,2,0,0,0))+chunk(b'IDAT',zlib.compress(raw_data))+chunk(b'IEND',b'')
          base='ss-full/src/frontends/android/app/src/main/res'
          for f,s in {'mipmap-mdpi':48,'mipmap-hdpi':72,'mipmap-xhdpi':96,'mipmap-xxhdpi':144,'mipmap-xxxhdpi':192}.items():
              p=os.path.join(base,f);os.makedirs(p,exist_ok=True);png=create_png(s,s,[26,26,46],[0,212,170])
              for n in['ic_launcher.png','ic_launcher_round.png']:
                  with open(os.path.join(p,n),'wb')as fh:fh.write(png)
          PYEOF

      - name: Create UI resources
        run: |
          cd ss-full/src/frontends/android
          RES_DIR="app/src/main/res"
          cat > "${RES_DIR}/layout/activity_asadvpn_main.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent"
              android:orientation="vertical" android:gravity="center_horizontal"
              android:background="#1a1a2e" android:padding="24dp">
              <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                  android:text="AsadVPN" android:textSize="32sp" android:textColor="#00d4aa"
                  android:textStyle="bold" android:layout_marginTop="40dp"/>
              <TextView android:id="@+id/status_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="Disconnected"
                  android:textSize="18sp" android:textColor="#ffffff" android:layout_marginTop="16dp"/>
              <TextView android:id="@+id/server_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="" android:textSize="14sp"
                  android:textColor="#aaaaaa" android:layout_marginTop="8dp"/>
              <TextView android:id="@+id/days_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="" android:textSize="16sp"
                  android:textColor="#ffcc00" android:layout_marginTop="16dp"/>
              <Button android:id="@+id/connect_button" android:layout_width="200dp"
                  android:layout_height="200dp" android:layout_marginTop="40dp"
                  android:background="@drawable/circle_button_connect" android:text="CONNECT"
                  android:textSize="20sp" android:textColor="#ffffff" android:textStyle="bold"/>
              <View android:layout_width="0dp" android:layout_height="0dp" android:layout_weight="1"/>
              <TextView android:id="@+id/update_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="" android:textSize="11sp"
                  android:textColor="#666666" android:layout_marginBottom="8dp"/>
              <Button android:id="@+id/import_button" android:layout_width="match_parent"
                  android:layout_height="48dp" android:text="Import Profile" android:textColor="#ffffff"
                  android:backgroundTint="#333355" android:layout_marginBottom="8dp"/>
              <Button android:id="@+id/scan_button" android:layout_width="match_parent"
                  android:layout_height="48dp" android:text="Scan QR Code" android:textColor="#ffffff"
                  android:backgroundTint="#333355" android:layout_marginBottom="16dp"/>
          </LinearLayout>
          XML_EOF
          cat > "${RES_DIR}/layout/dialog_import_profile.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="wrap_content"
              android:orientation="vertical" android:padding="24dp">
              <TextView android:layout_width="match_parent" android:layout_height="wrap_content"
                  android:text="Paste your encrypted profile code below:" android:textSize="14sp"
                  android:layout_marginBottom="12dp"/>
              <EditText android:id="@+id/profile_input" android:layout_width="match_parent"
                  android:layout_height="120dp" android:hint="Paste encrypted profile here..."
                  android:gravity="top" android:inputType="textMultiLine"
                  android:background="#f0f0f0" android:padding="8dp"/>
          </LinearLayout>
          XML_EOF
          mkdir -p "${RES_DIR}/drawable"
          cat > "${RES_DIR}/drawable/circle_button_connect.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <selector xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:state_pressed="true"><shape android:shape="oval"><solid android:color="#008866"/><stroke android:width="3dp" android:color="#00d4aa"/></shape></item>
              <item><shape android:shape="oval"><solid android:color="#00aa88"/><stroke android:width="3dp" android:color="#00d4aa"/></shape></item>
          </selector>
          XML_EOF
          cat > "${RES_DIR}/drawable/circle_button_disconnect.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <selector xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:state_pressed="true"><shape android:shape="oval"><solid android:color="#cc3333"/><stroke android:width="3dp" android:color="#ff4444"/></shape></item>
              <item><shape android:shape="oval"><solid android:color="#dd4444"/><stroke android:width="3dp" android:color="#ff4444"/></shape></item>
          </selector>
          XML_EOF

      - name: Create logic classes
        run: |
          cd ss-full/src/frontends/android
          JAVA_DIR="app/src/main/java/org/strongswan/android"
          mkdir -p "${JAVA_DIR}/logic"

          cat > "${JAVA_DIR}/logic/ProfileCrypto.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.util.Base64;
          import java.nio.charset.StandardCharsets;
          import java.security.MessageDigest;
          import javax.crypto.Cipher;
          import javax.crypto.spec.GCMParameterSpec;
          import javax.crypto.spec.SecretKeySpec;
          import org.json.JSONArray;
          import org.json.JSONObject;

          public class ProfileCrypto {
              private static final String MASTER_KEY = "As4dVPN-2024!SecretKey#Encrypted";

              public static class ServerInfo {
                  public String address;
                  public String name;
                  public String username;
                  public String password;
                  public String caCertPem;
                  public String remoteId;

                  public boolean hasCaCert() {
                      return caCertPem != null && !caCertPem.isEmpty();
                  }
              }

              public static class ProfileData {
                  public ServerInfo[] servers;
                  public long expiryTimestamp;
                  public String profileId;
                  public String updateUrl;
                  public String ikeProposal;
                  public String espProposal;
                  public Integer mtu;
                  public Integer splitTunneling;

                  public boolean isExpired() {
                      return System.currentTimeMillis() > expiryTimestamp;
                  }

                  public int remainingDays() {
                      long diff = expiryTimestamp - System.currentTimeMillis();
                      if (diff <= 0) return 0;
                      return (int)(diff / (1000L * 60 * 60 * 24));
                  }
              }

              public static ProfileData decryptProfile(String encryptedBase64) throws Exception {
                  byte[] encrypted = Base64.decode(encryptedBase64, Base64.DEFAULT | Base64.NO_WRAP);
                  byte[] iv = new byte[12];
                  byte[] ciphertext = new byte[encrypted.length - 12];
                  System.arraycopy(encrypted, 0, iv, 0, 12);
                  System.arraycopy(encrypted, 12, ciphertext, 0, ciphertext.length);
                  MessageDigest sha256 = MessageDigest.getInstance("SHA-256");
                  byte[] keyBytes = sha256.digest(MASTER_KEY.getBytes(StandardCharsets.UTF_8));
                  SecretKeySpec keySpec = new SecretKeySpec(keyBytes, "AES");
                  Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
                  cipher.init(Cipher.DECRYPT_MODE, keySpec, new GCMParameterSpec(128, iv));
                  byte[] plaintext = cipher.doFinal(ciphertext);
                  return parseProfile(new String(plaintext, StandardCharsets.UTF_8));
              }

              public static ProfileData parseProfile(String json) throws Exception {
                  JSONObject obj = new JSONObject(json);
                  ProfileData data = new ProfileData();
                  data.profileId = obj.getString("id");
                  data.expiryTimestamp = obj.getLong("expiry");
                  data.updateUrl = obj.optString("updateUrl", "");
                  data.ikeProposal = obj.optString("ikeProposal", null);
                  data.espProposal = obj.optString("espProposal", null);
                  if (obj.has("mtu")) data.mtu = obj.getInt("mtu");
                  if (obj.has("splitTunneling")) data.splitTunneling = obj.getInt("splitTunneling");

                  // Top-level fallback credentials (for backward compatibility)
                  String topUser = obj.optString("username", null);
                  String topPass = obj.optString("password", null);

                  JSONArray serversArr = obj.getJSONArray("servers");
                  data.servers = new ServerInfo[serversArr.length()];
                  for (int i = 0; i < serversArr.length(); i++) {
                      JSONObject s = serversArr.getJSONObject(i);
                      ServerInfo si = new ServerInfo();
                      si.address = s.getString("addr");
                      si.name = s.optString("name", si.address);
                      // Per-server credentials, fallback to top-level
                      si.username = s.optString("username", topUser);
                      si.password = s.optString("password", topPass);
                      si.caCertPem = s.optString("caCert", null);
                      si.remoteId = s.optString("remoteId", null);
                      data.servers[i] = si;
                  }
                  return data;
              }

              public static String encryptProfile(String json) throws Exception {
                  MessageDigest sha256 = MessageDigest.getInstance("SHA-256");
                  byte[] keyBytes = sha256.digest(MASTER_KEY.getBytes(StandardCharsets.UTF_8));
                  SecretKeySpec keySpec = new SecretKeySpec(keyBytes, "AES");
                  Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
                  cipher.init(Cipher.ENCRYPT_MODE, keySpec);
                  byte[] iv = cipher.getIV();
                  byte[] ciphertext = cipher.doFinal(json.getBytes(StandardCharsets.UTF_8));
                  byte[] combined = new byte[iv.length + ciphertext.length];
                  System.arraycopy(iv, 0, combined, 0, iv.length);
                  System.arraycopy(ciphertext, 0, combined, iv.length, ciphertext.length);
                  return Base64.encodeToString(combined, Base64.NO_WRAP);
              }
          }
          JAVA_EOF

          cat > "${JAVA_DIR}/logic/CertificateImporter.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.util.Log;
          import org.strongswan.android.security.LocalCertificateStore;
          import java.io.ByteArrayInputStream;
          import java.nio.charset.StandardCharsets;
          import java.security.cert.CertificateFactory;
          import java.security.cert.X509Certificate;

          public class CertificateImporter {
              private static final String TAG = "AsadVPN";

              public static String importCaCertificate(String pemData) {
                  try {
                      CertificateFactory cf = CertificateFactory.getInstance("X.509");
                      ByteArrayInputStream bis = new ByteArrayInputStream(pemData.getBytes(StandardCharsets.UTF_8));
                      X509Certificate cert = (X509Certificate) cf.generateCertificate(bis);
                      bis.close();
                      LocalCertificateStore store = new LocalCertificateStore();
                      boolean added = store.addCertificate(cert);
                      if (added) {
                          String alias = store.getCertificateAlias(cert);
                          Log.i(TAG, "CA cert imported: " + alias);
                          TrustedCertificateManager.getInstance().reset();
                          return alias;
                      }
                      return null;
                  } catch (Exception e) {
                      Log.e(TAG, "CA cert import failed", e);
                      return null;
                  }
              }
          }
          JAVA_EOF

          cat > "${JAVA_DIR}/logic/ProfileManager.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.content.Context;
          import android.content.SharedPreferences;
          import android.util.Log;
          import org.json.JSONObject;
          import org.json.JSONArray;
          import java.io.BufferedReader;
          import java.io.InputStreamReader;
          import java.net.HttpURLConnection;
          import java.net.URL;

          public class ProfileManager {
              private static final String TAG = "AsadVPN";
              private static final String PREFS = "asadvpn_profiles";
              private static final String KEY_PROFILE = "active_profile";
              private static final String KEY_LAST_UPDATE = "last_update_check";
              private static final long UPDATE_INTERVAL = 2 * 24 * 60 * 60 * 1000L;

              private final SharedPreferences prefs;

              public ProfileManager(Context ctx) {
                  this.prefs = ctx.getSharedPreferences(PREFS, Context.MODE_PRIVATE);
              }

              public ProfileCrypto.ProfileData importProfile(String encData) throws Exception {
                  ProfileCrypto.ProfileData data = ProfileCrypto.decryptProfile(encData);
                  prefs.edit()
                      .putString(KEY_PROFILE, dataToJson(data))
                      .putLong(KEY_LAST_UPDATE, System.currentTimeMillis())
                      .apply();
                  Log.i(TAG, "Imported: " + data.profileId + ", " + data.servers.length + " servers");
                  return data;
              }

              public ProfileCrypto.ProfileData getActiveProfile() {
                  String json = prefs.getString(KEY_PROFILE, null);
                  if (json == null) return null;
                  try { return ProfileCrypto.parseProfile(json); }
                  catch (Exception e) { Log.e(TAG, "Parse error", e); return null; }
              }

              public long getLastUpdateTime() { return prefs.getLong(KEY_LAST_UPDATE, 0); }

              public void forceUpdate(UpdateCallback cb) {
                  ProfileCrypto.ProfileData data = getActiveProfile();
                  if (data == null || data.updateUrl == null || data.updateUrl.isEmpty()) {
                      if (cb != null) cb.onError(new Exception("No update URL"));
                      return;
                  }
                  performUpdate(data, cb);
              }

              public void checkForUpdates(UpdateCallback cb) {
                  ProfileCrypto.ProfileData data = getActiveProfile();
                  if (data == null || data.updateUrl == null || data.updateUrl.isEmpty()) return;
                  if (System.currentTimeMillis() - prefs.getLong(KEY_LAST_UPDATE, 0) < UPDATE_INTERVAL) return;
                  performUpdate(data, cb);
              }

              private void performUpdate(ProfileCrypto.ProfileData data, UpdateCallback cb) {
                  new Thread(() -> {
                      try {
                          HttpURLConnection conn = (HttpURLConnection) new URL(data.updateUrl).openConnection();
                          conn.setConnectTimeout(15000);
                          conn.setReadTimeout(15000);
                          conn.setRequestProperty("User-Agent", "AsadVPN/1.0");
                          conn.setRequestProperty("Cache-Control", "no-cache");
                          if (conn.getResponseCode() != 200) throw new Exception("HTTP " + conn.getResponseCode());
                          BufferedReader r = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                          StringBuilder sb = new StringBuilder();
                          String line;
                          while ((line = r.readLine()) != null) sb.append(line);
                          r.close();
                          conn.disconnect();
                          String enc = sb.toString().trim();
                          if (enc.isEmpty()) throw new Exception("Empty");
                          ProfileCrypto.ProfileData nd = ProfileCrypto.decryptProfile(enc);
                          nd.expiryTimestamp = data.expiryTimestamp;
                          nd.updateUrl = data.updateUrl;
                          prefs.edit()
                              .putString(KEY_PROFILE, dataToJson(nd))
                              .putLong(KEY_LAST_UPDATE, System.currentTimeMillis())
                              .apply();
                          Log.i(TAG, "Updated: " + nd.servers.length + " servers");
                          if (cb != null) cb.onUpdated(nd);
                      } catch (Exception e) {
                          Log.w(TAG, "Update failed", e);
                          if (cb != null) cb.onError(e);
                      }
                  }).start();
              }

              private String dataToJson(ProfileCrypto.ProfileData data) {
                  try {
                      JSONObject obj = new JSONObject();
                      obj.put("id", data.profileId);
                      obj.put("expiry", data.expiryTimestamp);
                      obj.put("updateUrl", data.updateUrl != null ? data.updateUrl : "");
                      if (data.ikeProposal != null) obj.put("ikeProposal", data.ikeProposal);
                      if (data.espProposal != null) obj.put("espProposal", data.espProposal);
                      if (data.mtu != null) obj.put("mtu", data.mtu);
                      if (data.splitTunneling != null) obj.put("splitTunneling", data.splitTunneling);
                      JSONArray servers = new JSONArray();
                      for (ProfileCrypto.ServerInfo si : data.servers) {
                          JSONObject s = new JSONObject();
                          s.put("addr", si.address);
                          s.put("name", si.name);
                          s.put("username", si.username);
                          s.put("password", si.password);
                          if (si.caCertPem != null) s.put("caCert", si.caCertPem);
                          if (si.remoteId != null) s.put("remoteId", si.remoteId);
                          servers.put(s);
                      }
                      obj.put("servers", servers);
                      return obj.toString();
                  } catch (Exception e) { return "{}"; }
              }

              public interface UpdateCallback {
                  void onUpdated(ProfileCrypto.ProfileData newData);
                  void onError(Exception e);
              }
          }
          JAVA_EOF

          cat > "${JAVA_DIR}/logic/FastServerSelector.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.util.Log;
          import java.net.InetAddress;
          import java.util.ArrayList;
          import java.util.List;
          import java.util.concurrent.*;

          public class FastServerSelector {
              private static final String TAG = "AsadVPN";

              public static ProfileCrypto.ServerInfo findFastest(ProfileCrypto.ServerInfo[] servers) {
                  if (servers == null || servers.length == 0) return null;
                  if (servers.length == 1) return servers[0];
                  int count = Math.min(servers.length, 5);
                  ExecutorService exec = Executors.newFixedThreadPool(count);
                  List<Future<long[]>> futures = new ArrayList<>();
                  for (int i = 0; i < count; i++) {
                      final int idx = i;
                      futures.add(exec.submit(() -> {
                          long start = System.currentTimeMillis();
                          try {
                              boolean ok = InetAddress.getByName(servers[idx].address).isReachable(2000);
                              return new long[]{idx, ok ? System.currentTimeMillis() - start : Long.MAX_VALUE};
                          } catch (Exception e) { return new long[]{idx, Long.MAX_VALUE}; }
                      }));
                  }
                  int bestIdx = 0; long bestMs = Long.MAX_VALUE;
                  try {
                      exec.shutdown(); exec.awaitTermination(3, TimeUnit.SECONDS);
                      for (Future<long[]> f : futures) {
                          if (f.isDone()) { long[] r = f.get(); if (r[1] < bestMs) { bestMs = r[1]; bestIdx = (int) r[0]; } }
                      }
                  } catch (Exception e) { Log.w(TAG, "Select error", e); }
                  return servers[bestIdx];
              }
          }
          JAVA_EOF

      - name: Create AsadMainActivity
        run: |
          cd ss-full/src/frontends/android
          cat > "app/src/main/java/org/strongswan/android/ui/AsadMainActivity.java" << 'JAVAEOF'
          package org.strongswan.android.ui;

          import android.app.Activity;
          import android.app.AlertDialog;
          import android.content.ComponentName;
          import android.content.Intent;
          import android.content.ServiceConnection;
          import android.net.Uri;
          import android.net.VpnService;
          import android.os.Bundle;
          import android.os.IBinder;
          import android.util.Log;
          import android.view.View;
          import android.widget.Button;
          import android.widget.EditText;
          import android.widget.TextView;
          import android.widget.Toast;

          import org.strongswan.android.R;
          import org.strongswan.android.data.VpnProfile;
          import org.strongswan.android.data.VpnProfileDataSource;
          import org.strongswan.android.data.VpnProfileSource;
          import org.strongswan.android.data.VpnType;
          import org.strongswan.android.logic.CertificateImporter;
          import org.strongswan.android.logic.FastServerSelector;
          import org.strongswan.android.logic.ProfileCrypto;
          import org.strongswan.android.logic.ProfileManager;
          import org.strongswan.android.logic.VpnStateService;
          import org.strongswan.android.logic.VpnStateService.State;

          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;

          public class AsadMainActivity extends Activity implements VpnStateService.VpnStateListener {
              private static final String TAG = "AsadVPN";
              private static final int VPN_REQ = 100, QR_REQ = 200;
              private Button connectBtn, importBtn, scanBtn;
              private TextView statusTv, serverTv, daysTv, updateTv;
              private ProfileManager pm;
              private ProfileCrypto.ProfileData profile;
              private ProfileCrypto.ServerInfo pendingServer;
              private VpnStateService svc;
              private String pendingUuid;
              private boolean updatedThisSession = false;

              private final ServiceConnection svcConn = new ServiceConnection() {
                  public void onServiceConnected(ComponentName n, IBinder b) {
                      svc = ((VpnStateService.LocalBinder) b).getService();
                      svc.registerListener(AsadMainActivity.this);
                      refreshUI();
                  }
                  public void onServiceDisconnected(ComponentName n) { svc = null; }
              };

              @Override protected void onCreate(Bundle si) {
                  super.onCreate(si);
                  setContentView(R.layout.activity_asadvpn_main);
                  connectBtn = findViewById(R.id.connect_button);
                  importBtn = findViewById(R.id.import_button);
                  scanBtn = findViewById(R.id.scan_button);
                  statusTv = findViewById(R.id.status_text);
                  serverTv = findViewById(R.id.server_text);
                  daysTv = findViewById(R.id.days_text);
                  updateTv = findViewById(R.id.update_text);
                  pm = new ProfileManager(this);
                  connectBtn.setOnClickListener(v -> onConnect());
                  importBtn.setOnClickListener(v -> showImport());
                  scanBtn.setOnClickListener(v -> scanQr());
                  importBtn.setOnLongClickListener(v -> { forceUpdate(); return true; });
                  bindService(new Intent(this, VpnStateService.class), svcConn, BIND_AUTO_CREATE);
                  doUpdate();
              }

              @Override protected void onDestroy() {
                  super.onDestroy();
                  if (svc != null) svc.unregisterListener(this);
                  try { unbindService(svcConn); } catch (Exception ignored) {}
              }
              @Override protected void onResume() { super.onResume(); refreshUI(); }

              @Override public void stateChanged() {
                  runOnUiThread(() -> {
                      refreshUI();
                      if (svc != null && svc.getState() == State.CONNECTED && !updatedThisSession) {
                          updatedThisSession = true;
                          doUpdate();
                      }
                  });
              }

              private void doUpdate() {
                  pm.checkForUpdates(new ProfileManager.UpdateCallback() {
                      public void onUpdated(ProfileCrypto.ProfileData d) {
                          runOnUiThread(() -> { profile = d; refreshUI();
                              Toast.makeText(AsadMainActivity.this, "Profile updated!", Toast.LENGTH_SHORT).show(); });
                      }
                      public void onError(Exception e) { Log.w(TAG, "Update: " + e.getMessage()); }
                  });
              }

              private void refreshUI() {
                  profile = pm.getActiveProfile();
                  long lu = pm.getLastUpdateTime();
                  updateTv.setText(lu > 0 ? "Last sync: " + new SimpleDateFormat("MMM dd, HH:mm", Locale.getDefault()).format(new Date(lu)) : "");

                  if (profile == null) {
                      statusTv.setText("No Profile"); daysTv.setText("Import a profile to get started");
                      serverTv.setText(""); connectBtn.setText("IMPORT"); connectBtn.setEnabled(true);
                      connectBtn.setBackgroundResource(R.drawable.circle_button_connect); return;
                  }
                  if (profile.isExpired()) {
                      statusTv.setText("Profile Expired"); daysTv.setText("0 days remaining");
                      serverTv.setText(""); connectBtn.setText("EXPIRED"); connectBtn.setEnabled(false);
                      connectBtn.setBackgroundResource(R.drawable.circle_button_connect); return;
                  }
                  int d = profile.remainingDays();
                  daysTv.setText(d + " day" + (d != 1 ? "s" : "") + " remaining");
                  State st = svc != null ? svc.getState() : State.DISABLED;
                  switch (st) {
                      case CONNECTED:
                          statusTv.setText("Connected"); serverTv.setText("\uD83D\uDD12 Secure");
                          connectBtn.setText("DISCONNECT"); connectBtn.setBackgroundResource(R.drawable.circle_button_disconnect);
                          connectBtn.setEnabled(true); break;
                      case CONNECTING:
                          statusTv.setText("Connecting..."); serverTv.setText("");
                          connectBtn.setText("WAIT"); connectBtn.setEnabled(false); break;
                      case DISCONNECTING:
                          statusTv.setText("Disconnecting..."); serverTv.setText("");
                          connectBtn.setText("WAIT"); connectBtn.setEnabled(false); break;
                      default:
                          statusTv.setText("Disconnected"); serverTv.setText("Ready");
                          connectBtn.setText("CONNECT"); connectBtn.setBackgroundResource(R.drawable.circle_button_connect);
                          connectBtn.setEnabled(true); break;
                  }
              }

              private void onConnect() {
                  if (profile == null) { showImport(); return; }
                  if (profile.isExpired()) { showExpired(); return; }
                  State st = svc != null ? svc.getState() : State.DISABLED;
                  if (st == State.CONNECTED || st == State.CONNECTING) {
                      if (svc != null) svc.disconnect();
                  } else {
                      statusTv.setText("Connecting..."); connectBtn.setEnabled(false);
                      new Thread(() -> {
                          ProfileCrypto.ServerInfo best = FastServerSelector.findFastest(profile.servers);
                          if (best == null) {
                              runOnUiThread(() -> { refreshUI(); Toast.makeText(this, "No servers", Toast.LENGTH_SHORT).show(); });
                              return;
                          }
                          runOnUiThread(() -> startVpn(best));
                      }).start();
                  }
              }

              private void startVpn(ProfileCrypto.ServerInfo server) {
                  try {
                      String certAlias = null;
                      if (server.hasCaCert()) {
                          certAlias = CertificateImporter.importCaCertificate(server.caCertPem);
                          if (certAlias == null) {
                              Toast.makeText(this, "CA cert import failed", Toast.LENGTH_LONG).show();
                              refreshUI(); return;
                          }
                      }
                      VpnProfileDataSource ds = new VpnProfileSource(this);
                      ds.open();
                      VpnProfile vp = new VpnProfile();
                      vp.setName("AsadVPN");
                      vp.setGateway(server.address);
                      vp.setUsername(server.username);
                      vp.setPassword(server.password);
                      vp.setVpnType(VpnType.IKEV2_EAP);
                      if (certAlias != null) vp.setCertificateAlias(certAlias);
                      if (server.remoteId != null && !server.remoteId.isEmpty()) vp.setRemoteId(server.remoteId);
                      if (profile.ikeProposal != null) vp.setIkeProposal(profile.ikeProposal);
                      if (profile.espProposal != null) vp.setEspProposal(profile.espProposal);
                      if (profile.mtu != null) vp.setMTU(profile.mtu);
                      if (profile.splitTunneling != null) vp.setSplitTunneling(profile.splitTunneling);
                      VpnProfile saved = ds.insertProfile(vp);
                      ds.close();
                      if (saved == null) { Toast.makeText(this, "Save failed", Toast.LENGTH_LONG).show(); refreshUI(); return; }
                      pendingUuid = saved.getUUID().toString();
                      pendingServer = server;
                      Intent intent = VpnService.prepare(this);
                      if (intent != null) startActivityForResult(intent, VPN_REQ);
                      else launchVpn();
                  } catch (Exception e) {
                      Log.e(TAG, "VPN error", e);
                      Toast.makeText(this, "Failed: " + e.getMessage(), Toast.LENGTH_LONG).show();
                      refreshUI();
                  }
              }

              private void launchVpn() {
                  if (svc != null && pendingServer != null) {
                      Bundle b = new Bundle();
                      b.putString(VpnProfileDataSource.KEY_UUID, pendingUuid);
                      b.putString(VpnProfileDataSource.KEY_USERNAME, pendingServer.username);
                      b.putString(VpnProfileDataSource.KEY_PASSWORD, pendingServer.password);
                      svc.connect(b, true);
                  } else {
                      Intent i = new Intent(this, VpnProfileControlActivity.class);
                      i.setAction(VpnProfileControlActivity.START_PROFILE);
                      i.putExtra(VpnProfileControlActivity.EXTRA_VPN_PROFILE_UUID, pendingUuid);
                      startActivity(i);
                  }
              }

              @Override protected void onActivityResult(int req, int res, Intent data) {
                  super.onActivityResult(req, res, data);
                  if (req == VPN_REQ) {
                      if (res == RESULT_OK && pendingUuid != null) launchVpn();
                      else refreshUI();
                  } else if (req == QR_REQ && res == RESULT_OK && data != null) {
                      String s = data.getStringExtra("SCAN_RESULT");
                      if (s != null && !s.isEmpty()) doImport(s);
                  }
              }

              private void forceUpdate() {
                  if (profile == null) { Toast.makeText(this, "Import first", Toast.LENGTH_SHORT).show(); return; }
                  if (profile.updateUrl == null || profile.updateUrl.isEmpty()) {
                      Toast.makeText(this, "No update URL", Toast.LENGTH_SHORT).show(); return; }
                  Toast.makeText(this, "Checking...", Toast.LENGTH_SHORT).show();
                  pm.forceUpdate(new ProfileManager.UpdateCallback() {
                      public void onUpdated(ProfileCrypto.ProfileData d) {
                          runOnUiThread(() -> { profile = d; refreshUI();
                              Toast.makeText(AsadMainActivity.this, "Updated!", Toast.LENGTH_SHORT).show(); }); }
                      public void onError(Exception e) {
                          runOnUiThread(() -> Toast.makeText(AsadMainActivity.this, "Failed: " + e.getMessage(), Toast.LENGTH_LONG).show()); }
                  });
              }

              private void showImport() {
                  View v = getLayoutInflater().inflate(R.layout.dialog_import_profile, null);
                  EditText input = v.findViewById(R.id.profile_input);
                  new AlertDialog.Builder(this).setTitle("Import Profile").setView(v)
                      .setPositiveButton("Import", (d, w) -> {
                          String t = input.getText().toString().trim();
                          if (!t.isEmpty()) doImport(t);
                      }).setNegativeButton("Cancel", null).show();
              }

              private void doImport(String enc) {
                  try {
                      profile = pm.importProfile(enc);
                      if (profile.isExpired()) { showExpired(); return; }
                      Toast.makeText(this, "Imported! " + profile.remainingDays() + " days", Toast.LENGTH_LONG).show();
                      refreshUI();
                  } catch (Exception e) {
                      Log.e(TAG, "Import fail", e);
                      Toast.makeText(this, "Invalid: " + e.getMessage(), Toast.LENGTH_LONG).show();
                  }
              }

              private void scanQr() {
                  try {
                      Intent i = new Intent("com.google.zxing.client.android.SCAN");
                      i.putExtra("SCAN_MODE", "QR_CODE_MODE");
                      startActivityForResult(i, QR_REQ);
                  } catch (Exception e) { Toast.makeText(this, "Install QR scanner or paste manually", Toast.LENGTH_LONG).show(); }
              }

              private void showExpired() {
                  new AlertDialog.Builder(this).setTitle("Subscription Expired")
                      .setMessage("Contact support to renew.")
                      .setPositiveButton("Support", (d, w) -> startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse("https://t.me/vpnproxytestsupport"))))
                      .setNegativeButton("Close", null).setCancelable(false).show();
              }
          }
          JAVAEOF

      - name: Patch AndroidManifest
        run: |
          cd ss-full/src/frontends/android
          python3 << 'PYEOF'
          with open("app/src/main/AndroidManifest.xml", "r") as f: content = f.read()
          content = content.replace('<category android:name="android.intent.category.LAUNCHER" />', '<!-- moved -->')
          content = content.replace('</application>', '''
                  <activity android:name=".ui.AsadMainActivity" android:label="AsadVPN"
                      android:exported="true" android:theme="@style/ApplicationTheme">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>''')
          with open("app/src/main/AndroidManifest.xml", "w") as f: f.write(content)
          PYEOF

      - name: Pre-build check
        run: |
          cd ss-full/src/frontends/android
          grep "applicationId" app/build.gradle
          grep "authorities" app/src/main/AndroidManifest.xml
          grep -c "LAUNCHER" app/src/main/AndroidManifest.xml
          find app/src/main/java/org/strongswan/android -name "*.java" -newer app/build.gradle | sort

      - name: Build APK
        run: |
          cd ss-full/src/frontends/android
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          sed -i "s|arguments '-j'|arguments 'APP_ALLOW_MISSING_DEPS=true', '-j'|" app/build.gradle
          set +e
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"
          RESULT=${PIPESTATUS[0]}
          set -e
          if [ ${RESULT} -ne 0 ]; then
            echo "BUILD FAILED"
            grep -E "error:" "${GITHUB_WORKSPACE}/build.log" | grep -v "Exception\|ProcessException\|CXX1429\|error when building\|IssueReporter\|TaskExecution\|EventFiring\|DefaultBuild" | head -30
            grep -B2 "cannot find symbol\|incompatible types" "${GITHUB_WORKSPACE}/build.log" | head -20
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: asadvpn-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
