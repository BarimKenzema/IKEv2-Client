name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout our repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool pkg-config gettext \
            python3 bison flex gperf perl curl unzip git

      - name: Set environment variables
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: |
          git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Inspect strongSwan build files
        run: |
          set -e
          JNI_DIR="ss-full/src/frontends/android/app/src/main/jni"
          echo "========================================="
          echo "=== Full Android.mk ==="
          echo "========================================="
          cat "${JNI_DIR}/Android.mk"
          echo ""
          echo "========================================="
          echo "=== Application.mk ==="
          echo "========================================="
          cat "${JNI_DIR}/Application.mk"
          echo ""
          echo "========================================="
          echo "=== build.gradle ==="
          echo "========================================="
          cat ss-full/src/frontends/android/app/build.gradle* 2>/dev/null || echo "No build.gradle found"
          echo ""
          echo "========================================="
          echo "=== All files in jni/ (depth 2) ==="
          echo "========================================="
          find "${JNI_DIR}" -maxdepth 2 -ls
          echo ""
          echo "========================================="
          echo "=== crypto/ssl references in Android.mk ==="
          echo "========================================="
          grep -n "openssl\|libcrypto\|libssl\|crypto\|ssl\|OPENSSL\|STATIC_LIB\|SHARED_LIB" "${JNI_DIR}/Android.mk" || true

      - name: Run strongSwan autogen.sh
        run: |
          cd ss-full
          ./autogen.sh

      - name: Configure strongSwan
        run: |
          cd ss-full
          ./configure

      - name: Download OpenSSL
        run: |
          curl -L -o "openssl-${OPENSSL_VERSION}.tar.gz" \
            "https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz"
          tar xzf "openssl-${OPENSSL_VERSION}.tar.gz"

      - name: Cross-compile OpenSSL for Android
        run: |
          set -e
          NDK="${ANDROID_NDK_HOME}"
          TOOLCHAIN="${NDK}/toolchains/llvm/prebuilt/linux-x86_64"
          OPENSSL_SRC="${GITHUB_WORKSPACE}/openssl-${OPENSSL_VERSION}"

          export ANDROID_NDK_ROOT="${NDK}"
          export PATH="${TOOLCHAIN}/bin:${PATH}"

          build_openssl() {
            local ABI=$1
            local TARGET=$2
            echo "========================================="
            echo "Building OpenSSL for ${ABI} (${TARGET})"
            echo "========================================="
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local PREFIX="${GITHUB_WORKSPACE}/openssl-output-${ABI}"
            rm -rf "${BUILD_DIR}"
            cp -r "${OPENSSL_SRC}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" \
              -D__ANDROID_API__=21 \
              --prefix="${PREFIX}" \
              --openssldir="${PREFIX}" \
              no-shared no-tests no-ui-console no-stdio
            make -j$(nproc) build_libs
            make install_sw
            echo "Built for ${ABI}:"
            find "${PREFIX}" -name "*.a" -ls
            cd "${GITHUB_WORKSPACE}"
          }

          build_openssl "arm64-v8a" "android-arm64"
          build_openssl "armeabi-v7a" "android-arm"
          build_openssl "x86" "android-x86"
          build_openssl "x86_64" "android-x86_64"

      - name: Setup OpenSSL for strongSwan JNI
        run: |
          set -e
          JNI_DIR="${GITHUB_WORKSPACE}/ss-full/src/frontends/android/app/src/main/jni"
          OPENSSL_JNI="${JNI_DIR}/openssl"
          mkdir -p "${OPENSSL_JNI}"

          # Copy headers from arm64 build (arch-independent)
          find "${GITHUB_WORKSPACE}/openssl-output-arm64-v8a" -type d -name "include" | head -1 | xargs -I{} cp -r {} "${OPENSSL_JNI}/"

          # Copy per-ABI static libs
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            PREFIX="${GITHUB_WORKSPACE}/openssl-output-${ABI}"
            TARGET_DIR="${OPENSSL_JNI}/libs/${ABI}"
            mkdir -p "${TARGET_DIR}"
            find "${PREFIX}" -name "libcrypto.a" -exec cp {} "${TARGET_DIR}/" \;
            find "${PREFIX}" -name "libssl.a" -exec cp {} "${TARGET_DIR}/" \;
            echo "${ABI}: $(ls ${TARGET_DIR}/)"
          done

          # Create Android.mk
          cat > "${OPENSSL_JNI}/Android.mk" << 'MKEOF'
          LOCAL_PATH := $(call my-dir)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libcrypto_static
          LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libcrypto.a
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_STATIC_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libssl_static
          LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libssl.a
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_STATIC_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := crypto
          LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libcrypto.a
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_STATIC_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := ssl
          LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libssl.a
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_STATIC_LIBRARY)
          MKEOF

          echo "=== Created Android.mk ==="
          cat "${OPENSSL_JNI}/Android.mk"
          echo ""
          echo "=== Verify structure ==="
          find "${OPENSSL_JNI}" -name "*.a" -ls
          ls "${OPENSSL_JNI}/include/openssl/" | head -5

      - name: Build strongSwan APK
        run: |
          cd ss-full/src/frontends/android
          cat > local.properties << PROPEOF
          sdk.dir=${ANDROID_SDK_ROOT}
          ndk.dir=${ANDROID_NDK_HOME}
          PROPEOF
          chmod +x ./gradlew 2>/dev/null || true
          ./gradlew assembleDebug --no-daemon --stacktrace --info 2>&1 | tail -400

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strongswan-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Save failure logs
        if: failure()
        run: |
          mkdir -p failure-logs
          cp ss-full/src/frontends/android/app/src/main/jni/Android.mk failure-logs/ 2>/dev/null || true
          cp ss-full/src/frontends/android/app/src/main/jni/openssl/Android.mk failure-logs/openssl-Android.mk 2>/dev/null || true
          find ss-full/src/frontends/android/app/build/intermediates/cxx/ -name "*.log" -exec cp {} failure-logs/ \; 2>/dev/null || true

      - name: Upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: failure-logs/
