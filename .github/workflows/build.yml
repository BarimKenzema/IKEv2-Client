name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git libssl-dev

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Generate strongSwan source files
        run: |
          cd ss-full
          ./autogen.sh
          ./configure --enable-openssl --enable-eap-identity --enable-eap-mschapv2 --enable-eap-tls --enable-eap-ttls --enable-eap-tnc
          
          echo "=== Running make to generate source files ==="
          make -j$(nproc) || true
          
          echo ""
          echo "=== Verify generated files ==="
          for f in src/libstrongswan/asn1/oid.c src/libstrongswan/asn1/oid.h; do
            if [ -f "$f" ]; then
              echo "OK   $f ($(wc -l < $f) lines)"
            else
              echo "MISS $f - trying to generate manually"
            fi
          done

      - name: Generate any remaining missing files
        run: |
          cd ss-full

          # Generate oid.c and oid.h if make didn't create them
          if [ ! -f src/libstrongswan/asn1/oid.c ]; then
            echo "Generating oid.c and oid.h manually..."
            cd src/libstrongswan/asn1
            if [ -f oid.pl ] && [ -f oid.txt ]; then
              perl oid.pl oid.txt oid.c oid.h
              echo "Generated oid.c ($(wc -l < oid.c) lines)"
            else
              echo "ERROR: oid.pl or oid.txt not found"
              ls -la
              exit 1
            fi
            cd ../../..
          fi

          # Verify Android.common.mk exists
          if [ ! -f Android.common.mk ]; then
            if [ -f Android.common.mk.in ]; then
              echo "Generating Android.common.mk from template..."
              sed "s/@PACKAGE_VERSION@/$(grep PACKAGE_VERSION= configure | head -1 | sed "s/.*='\(.*\)'/\1/")/g" Android.common.mk.in > Android.common.mk
            else
              VERSION=$(grep PACKAGE_VERSION= configure | head -1 | sed "s/.*='\(.*\)'/\1/")
              echo "strongswan_VERSION := ${VERSION}" > Android.common.mk
            fi
            echo "Created Android.common.mk:"
            cat Android.common.mk
          fi

          echo ""
          echo "=== List all generated .c files that Android.mk references ==="
          # Check for other potentially generated files
          ANDROID_MK="src/frontends/android/app/src/main/jni/Android.mk"
          
          # Find all .mk files that list source files
          echo "Checking libstrongswan sources..."
          grep "\.c" src/libstrongswan/Android.mk | head -30
          
          echo ""
          echo "=== Verify all critical generated files ==="
          for f in \
            src/libstrongswan/asn1/oid.c \
            src/libstrongswan/asn1/oid.h \
            src/libstrongswan/plugins/openssl/openssl_plugin.c \
            src/libstrongswan/plugins/pkcs1/pkcs1_plugin.c \
            src/libstrongswan/plugins/pem/pem_plugin.c \
            src/libstrongswan/plugins/x509/x509_plugin.c \
            src/libstrongswan/plugins/xcbc/xcbc_plugin.c \
            src/libstrongswan/plugins/nonce/nonce_plugin.c \
            src/libstrongswan/plugins/kdf/kdf_plugin.c \
            src/libstrongswan/plugins/revocation/revocation_plugin.c \
            src/libcharon/plugins/eap_identity/eap_identity_plugin.c \
            src/libcharon/plugins/eap_mschapv2/eap_mschapv2_plugin.c \
            src/libcharon/plugins/eap_tls/eap_tls_plugin.c \
            src/libcharon/plugins/eap_ttls/eap_ttls_plugin.c \
            src/libcharon/plugins/eap_md5/eap_md5_plugin.c \
            src/libcharon/plugins/eap_gtc/eap_gtc_plugin.c \
            src/libcharon/plugins/eap_tnc/eap_tnc_plugin.c \
            Android.common.mk; do
            if [ -f "$f" ]; then
              echo "OK   $f"
            else
              echo "MISS $f"
            fi
          done

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL for Android
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"

          build_ssl() {
            local ABI=$1 TARGET=$2
            echo "===== Building OpenSSL for ${ABI} ====="
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            rm -rf "${BUILD_DIR}" "${OUT_DIR}"
            cp -r "openssl-${{ env.OPENSSL_VERSION }}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" \
              -D__ANDROID_API__=21 \
              --prefix="${OUT_DIR}" \
              --openssldir="${OUT_DIR}" \
              --libdir=lib \
              no-tests no-ui-console
            make -j$(nproc)
            make install_sw
            echo "Built:"
            find "${OUT_DIR}/lib" \( -name "*.so*" -o -name "*.a" \) -ls
            cd "${GITHUB_WORKSPACE}"
          }

          build_ssl arm64-v8a android-arm64
          build_ssl armeabi-v7a android-arm
          build_ssl x86 android-x86
          build_ssl x86_64 android-x86_64

      - name: Setup OpenSSL in JNI directory
        run: |
          set -e
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          mkdir -p "${OSSL}/include"
          cp -r "${GITHUB_WORKSPACE}/openssl-out-arm64-v8a/include/openssl" "${OSSL}/include/"

          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            DEST="${OSSL}/${ABI}"
            mkdir -p "${DEST}"
            OUT="${GITHUB_WORKSPACE}/openssl-out-${ABI}/lib"
            for LIB in libcrypto libssl; do
              REAL=$(find "${OUT}" -name "${LIB}.so*" ! -type l 2>/dev/null | head -1)
              if [ -n "${REAL}" ]; then
                cp "${REAL}" "${DEST}/${LIB}.so"
              else
                cp -L "${OUT}/${LIB}.so" "${DEST}/${LIB}.so"
              fi
            done
            echo "${ABI}: $(ls ${DEST}/)"
          done

      - name: Create openssl/Android.mk
        run: |
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          cat > "${OSSL}/Android.mk" << 'ENDMK'
          LOCAL_PATH := $(call my-dir)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libcrypto
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libssl
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)
          ENDMK

          echo "=== openssl/Android.mk ==="
          cat "${OSSL}/Android.mk"

      - name: Final verification
        run: |
          cd ss-full
          echo "=== Critical files check ==="
          FAIL=0
          for f in \
            Android.common.mk \
            src/libstrongswan/asn1/oid.c \
            src/libstrongswan/asn1/oid.h \
            src/frontends/android/app/src/main/jni/openssl/Android.mk \
            src/frontends/android/app/src/main/jni/Android.mk; do
            if [ -f "$f" ]; then
              echo "OK   $f"
            else
              echo "FAIL $f"
              FAIL=1
            fi
          done

          echo ""
          echo "=== OpenSSL .so files ==="
          find src/frontends/android/app/src/main/jni/openssl -name "*.so" -ls

          if [ $FAIL -eq 1 ]; then
            echo "ERROR: Missing critical files!"
            exit 1
          fi

      - name: Build APK
        run: |
          cd ss-full/src/frontends/android
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          echo "ndk.dir=${ANDROID_NDK_HOME}" >> local.properties
          set +e
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"
          RESULT=${PIPESTATUS[0]}
          set -e
          if [ ${RESULT} -ne 0 ]; then
            echo ""
            echo "============================================"
            echo "BUILD FAILED - Error details:"
            echo "============================================"
            grep -n "No rule to make\|No such file\|error:\|undefined reference\|cannot find\|Stop\." "${GITHUB_WORKSPACE}/build.log" | grep -iv "ProcessException\|ExecException\|stacktrace\|--info\|help.gradle" | head -30
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strongswan-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
