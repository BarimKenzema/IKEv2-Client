name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Autogen and configure
        run: |
          cd ss-full
          ./autogen.sh
          ./configure

      - name: Fix Android.common.mk
        run: |
          cd ss-full

          echo "=== Checking for Android.common.mk.in ==="
          if [ -f "Android.common.mk.in" ]; then
            echo "Template exists:"
            cat Android.common.mk.in
          else
            echo "No template found"
          fi

          echo ""
          echo "=== Checking for generated Android.common.mk ==="
          if [ -f "Android.common.mk" ]; then
            echo "Already exists:"
            cat Android.common.mk
          else
            echo "Missing! Creating it manually..."

            # Extract version from configure.ac
            VERSION=$(grep 'AC_INIT' configure.ac | sed -n 's/.*\[\([0-9][0-9.]*\)\].*/\1/p')
            if [ -z "$VERSION" ]; then
              VERSION=$(grep 'PACKAGE_VERSION=' configure | sed -n "s/.*PACKAGE_VERSION='\([^']*\)'.*/\1/p")
            fi
            if [ -z "$VERSION" ]; then
              VERSION="6.0.0"
            fi

            echo "Detected version: ${VERSION}"
            echo "strongswan_VERSION := ${VERSION}" > Android.common.mk
            echo ""
            echo "Created Android.common.mk:"
            cat Android.common.mk
          fi

          echo ""
          echo "=== Verify all required .mk files ==="
          for f in \
            Android.common.mk \
            src/libstrongswan/Android.mk \
            src/libcharon/Android.mk \
            src/libipsec/Android.mk \
            src/libtnccs/Android.mk \
            src/libtncif/Android.mk \
            src/libimcv/Android.mk \
            src/libtpmtss/Android.mk; do
            if [ -f "${f}" ]; then
              echo "OK   ${f}"
            else
              echo "MISS ${f}"
            fi
          done

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL for Android
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"

          build_ssl() {
            local ABI=$1 TARGET=$2
            echo "===== Building OpenSSL for ${ABI} ====="
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            rm -rf "${BUILD_DIR}" "${OUT_DIR}"
            cp -r "openssl-${{ env.OPENSSL_VERSION }}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" \
              -D__ANDROID_API__=21 \
              --prefix="${OUT_DIR}" \
              --openssldir="${OUT_DIR}" \
              --libdir=lib \
              no-tests no-ui-console
            make -j$(nproc)
            make install_sw
            echo "Built:"
            find "${OUT_DIR}/lib" \( -name "*.so*" -o -name "*.a" \) -ls
            cd "${GITHUB_WORKSPACE}"
          }

          build_ssl arm64-v8a android-arm64
          build_ssl armeabi-v7a android-arm
          build_ssl x86 android-x86
          build_ssl x86_64 android-x86_64

      - name: Setup OpenSSL in JNI directory
        run: |
          set -e
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          mkdir -p "${OSSL}/include"

          # Copy headers
          cp -r "${GITHUB_WORKSPACE}/openssl-out-arm64-v8a/include/openssl" "${OSSL}/include/"

          # Copy shared libs for each ABI
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            DEST="${OSSL}/${ABI}"
            mkdir -p "${DEST}"
            OUT="${GITHUB_WORKSPACE}/openssl-out-${ABI}/lib"

            for LIB in libcrypto libssl; do
              # Find the real .so file (not symlink)
              REAL=$(find "${OUT}" -name "${LIB}.so*" ! -type l 2>/dev/null | head -1)
              if [ -n "${REAL}" ]; then
                cp "${REAL}" "${DEST}/${LIB}.so"
              else
                # Follow symlink
                cp -L "${OUT}/${LIB}.so" "${DEST}/${LIB}.so"
              fi
            done
            echo "${ABI}: $(ls ${DEST}/)"
          done

      - name: Create openssl/Android.mk
        run: |
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          cat > "${OSSL}/Android.mk" << 'ENDMK'
          LOCAL_PATH := $(call my-dir)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libcrypto
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libssl
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)
          ENDMK

          echo "=== openssl/Android.mk ==="
          cat "${OSSL}/Android.mk"
          echo ""
          echo "=== Verify structure ==="
          find "${OSSL}" -type f -name "*.so" -o -name "*.mk" | sort

      - name: Inspect what libstrongswan expects from OpenSSL
        run: |
          echo "=== libstrongswan/Android.mk OpenSSL refs ==="
          grep -n "crypto\|ssl\|openssl\|SHARED_LIB\|STATIC_LIB" ss-full/src/libstrongswan/Android.mk | head -30
          echo ""
          echo "=== libcharon/Android.mk OpenSSL refs ==="
          grep -n "crypto\|ssl\|openssl\|SHARED_LIB\|STATIC_LIB" ss-full/src/libcharon/Android.mk | head -20
          echo ""
          echo "=== libandroidbridge/Android.mk ==="
          grep -n "crypto\|ssl\|openssl\|SHARED_LIB\|STATIC_LIB" ss-full/src/frontends/android/app/src/main/jni/libandroidbridge/Android.mk | head -20

      - name: Build APK
        run: |
          cd ss-full/src/frontends/android
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          echo "ndk.dir=${ANDROID_NDK_HOME}" >> local.properties
          set +e
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"
          RESULT=${PIPESTATUS[0]}
          set -e
          if [ ${RESULT} -ne 0 ]; then
            echo ""
            echo "============================================"
            echo "BUILD FAILED - Extracting error details"
            echo "============================================"
            echo ""
            echo "--- NDK/Make errors ---"
            grep -n "error:\|FAILED\|No such file\|Stop\.\|cannot find\|undefined reference\|fatal" "${GITHUB_WORKSPACE}/build.log" | grep -iv "stacktrace\|--info\|--debug\|--scan\|help.gradle\|compilerArgs\|ProcessException\|ExecException\|Xlint" | head -40
            echo ""
            echo "--- Context around first error ---"
            grep -n -B5 -A10 "error when building\|No such file\|No rule to make\|cannot find\|undefined reference" "${GITHUB_WORKSPACE}/build.log" | head -80
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strongswan-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
