name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git libssl-dev libgmp-dev

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Generate strongSwan source files
        run: |
          cd ss-full
          ./autogen.sh
          ./configure \
            --enable-openssl \
            --enable-eap-identity \
            --enable-eap-mschapv2 \
            --enable-eap-md5 \
            --enable-eap-gtc \
            --enable-eap-tls \
            --enable-eap-ttls \
            --enable-eap-tnc

          make -j$(nproc) 2>&1 | tail -20 || echo "Host make done"

          if [ ! -f src/libstrongswan/asn1/oid.c ]; then
            cd src/libstrongswan/asn1 && perl oid.pl oid.txt oid.c oid.h && cd ../../..
          fi
          if [ ! -f Android.common.mk ]; then
            VERSION=$(sed -n "s/^PACKAGE_VERSION='\(.*\)'/\1/p" configure | head -1)
            echo "strongswan_VERSION := ${VERSION}" > Android.common.mk
          fi

      - name: Analyze exact module dependencies
        run: |
          cd ss-full
          echo "=== libstrongswan/Android.mk - ALL library deps ==="
          grep -n "LOCAL_STATIC_LIBRARIES\|LOCAL_SHARED_LIBRARIES\|LOCAL_MODULE\b" src/libstrongswan/Android.mk
          echo ""
          echo "=== libcharon/Android.mk - ALL library deps ==="
          grep -n "LOCAL_STATIC_LIBRARIES\|LOCAL_SHARED_LIBRARIES\|LOCAL_MODULE\b" src/libcharon/Android.mk
          echo ""
          echo "=== libipsec/Android.mk - ALL library deps ==="
          grep -n "LOCAL_STATIC_LIBRARIES\|LOCAL_SHARED_LIBRARIES\|LOCAL_MODULE\b" src/libipsec/Android.mk
          echo ""
          echo "=== libandroidbridge/Android.mk - ALL library deps ==="
          grep -n "LOCAL_STATIC_LIBRARIES\|LOCAL_SHARED_LIBRARIES\|LOCAL_MODULE\b" src/frontends/android/app/src/main/jni/libandroidbridge/Android.mk
          echo ""
          echo "=== Does libtls/Android.mk exist? ==="
          ls -la src/libtls/Android.mk 2>/dev/null || echo "NO - libtls/Android.mk does NOT exist"
          echo ""
          echo "=== Full libstrongswan/Android.mk ==="
          cat src/libstrongswan/Android.mk

      - name: Patch Android.mk - disable BYOD, do NOT add libtls
        run: |
          cd ss-full
          JNI_MK="src/frontends/android/app/src/main/jni/Android.mk"

          echo "=== Disable BYOD ==="
          sed -i 's/^strongswan_USE_BYOD := true/strongswan_USE_BYOD :=/' "${JNI_MK}"

          echo "=== Remove eap-tls (needs libtls which has no Android.mk) ==="
          sed -i 's/eap-tls//' "${JNI_MK}"

          echo "=== Also disable BYOD in Java ==="
          find src/frontends/android -name "*.java" -exec grep -l "USE_BYOD" {} \; | while read f; do
            sed -i 's/USE_BYOD = true/USE_BYOD = false/g' "$f"
          done

          echo ""
          echo "=== Final Android.mk (relevant sections) ==="
          echo "--- Plugins ---"
          grep -A3 "strongswan_CHARON_PLUGINS" "${JNI_MK}"
          echo ""
          echo "--- BYOD ---"
          grep "strongswan_USE_BYOD" "${JNI_MK}"
          echo ""
          echo "--- Build list ---"
          grep -A10 "strongswan_BUILD :=" "${JNI_MK}"

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL for Android (shared + static)
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"

          build_ssl() {
            local ABI=$1 TARGET=$2
            echo "===== Building OpenSSL for ${ABI} ====="
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            
