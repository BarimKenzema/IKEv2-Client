name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"
  STRONGSWAN_VERSION: "6.0.0"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout our repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool pkg-config gettext \
            python3 bison flex gperf \
            perl curl unzip git

      - name: Set environment variables
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: |
          git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Inspect what strongSwan actually expects
        run: |
          set -e
          JNI_DIR="ss-full/src/frontends/android/app/src/main/jni"

          echo "========================================="
          echo "=== Full Android.mk ==="
          echo "========================================="
          cat "${JNI_DIR}/Android.mk"

          echo ""
          echo "========================================="
          echo "=== Application.mk ==="
          echo "========================================="
          cat "${JNI_DIR}/Application.mk"

          echo ""
          echo "========================================="
          echo "=== All .mk files in JNI dir ==="
          echo "========================================="
          find "${JNI_DIR}" -name "*.mk" -ls

          echo ""
          echo "========================================="
          echo "=== build.gradle or build.gradle.kts ==="
          echo "========================================="
          cat ss-full/src/frontends/android/app/build.gradle* 2>/dev/null || echo "No build.gradle found"

          echo ""
          echo "========================================="
          echo "=== settings.gradle ==="
          echo "========================================="
          cat ss-full/src/frontends/android/settings.gradle* 2>/dev/null || echo "No settings.gradle found"

          echo ""
          echo "========================================="
          echo "=== Any README or HACKING files ==="
          echo "========================================="
          cat ss-full/src/frontends/android/HACKING 2>/dev/null || echo "No HACKING file"
          cat ss-full/src/frontends/android/README* 2>/dev/null || echo "No README file"

          echo ""
          echo "========================================="
          echo "=== Top-level HACKING ==="
          echo "========================================="
          head -200 ss-full/HACKING 2>/dev/null || echo "No top-level HACKING"

          echo ""
          echo "========================================="
          echo "=== gradle.properties ==="
          echo "========================================="
          cat ss-full/src/frontends/android/gradle.properties 2>/dev/null || echo "None"

          echo ""
          echo "========================================="
          echo "=== List of all files in jni/ ==="
          echo "========================================="
          find "${JNI_DIR}" -maxdepth 2 -ls

      - name: Run strongSwan autogen.sh
        run: |
          cd ss-full
          ./autogen.sh

      - name: Configure strongSwan
        run: |
          cd ss-full
          ./configure

      - name: Download OpenSSL
        run: |
          curl -L -o "openssl-${OPENSSL_VERSION}.tar.gz" \
            "https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz"
          tar xzf "openssl-${OPENSSL_VERSION}.tar.gz"

      - name: Cross-compile OpenSSL for all Android ABIs
        run: |
          set -e

          NDK="${ANDROID_NDK_HOME}"
          TOOLCHAIN="${NDK}/toolchains/llvm/prebuilt/linux-x86_64"
          JNI_DIR="${GITHUB_WORKSPACE}/ss-full/src/frontends/android/app/src/main/jni"
          OPENSSL_SRC="${GITHUB_WORKSPACE}/openssl-${OPENSSL_VERSION}"

          declare -A ABI_TARGET
          ABI_TARGET[arm64-v8a]="android-arm64"
          ABI_TARGET[armeabi-v7a]="android-arm"
          ABI_TARGET[x86]="android-x86"
          ABI_TARGET[x86_64]="android-x86_64"

          export ANDROID_NDK_ROOT="${NDK}"
          export PATH="${TOOLCHAIN}/bin:${PATH}"

          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            echo "========================================="
            echo "Building OpenSSL for ${ABI}"
            echo "========================================="

            TARGET="${ABI_TARGET[$ABI]}"
            BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            PREFIX="${GITHUB_WORKSPACE}/openssl-output-${ABI}"

            # Fresh copy for each ABI
            rm -rf "${BUILD_DIR}"
            cp -r "${OPENSSL_SRC}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"

            ./Configure "${TARGET}" \
              -D__ANDROID_API__=21 \
              --prefix="${PREFIX}" \
              --openssldir="${PREFIX}" \
              no-shared \
              no-tests \
              no-ui-console \
              no-stdio

            make -j$(nproc) build_libs
            make install_sw

            echo "Built libs for ${ABI}:"
            ls -la "${PREFIX}/lib/"*.a 2>/dev/null || ls -la "${PREFIX}/lib64/"*.a 2>/dev/null || echo "Check lib paths"
            find "${PREFIX}" -name "*.a" -ls

            cd "${GITHUB_WORKSPACE}"
          done

      - name: Create OpenSSL Android.mk for strongSwan
        run: |
          set -e

          JNI_DIR="${GITHUB_WORKSPACE}/ss-full/src/frontends/android/app/src/main/jni"
          OPENSSL_JNI="${JNI_DIR}/openssl"

          mkdir -p "${OPENSSL_JNI}"

          # Copy headers from one build (they're arch-independent)
          HEADER_SOURCE=""
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            PREFIX="${GITHUB_WORKSPACE}/openssl-output-${ABI}"
            if [ -d "${PREFIX}/include" ]; then
              HEADER_SOURCE="${PREFIX}/include"
              break
            fi
          done
          cp -r "${HEADER_SOURCE}" "${OPENSSL_JNI}/"

          # Copy per-ABI static libraries
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            PREFIX="${GITHUB_WORKSPACE}/openssl-output-${ABI}"
            TARGET_LIB_DIR="${OPENSSL_JNI}/libs/${ABI}"
            mkdir -p "${TARGET_LIB_DIR}"

            # Find the .a files (could be in lib/ or lib64/)
            find "${PREFIX}" -name "libcrypto.a" -exec cp {} "${TARGET_LIB_DIR}/" \;
            find "${PREFIX}" -name "libssl.a" -exec cp {} "${TARGET_LIB_DIR}/" \;

            echo "Copied to ${TARGET_LIB_DIR}:"
            ls -la "${TARGET_LIB_DIR}/"
          done

          # Now read strongSwan's Android.mk to figure out exact module names
          echo ""
          echo "=== Analyzing strongSwan Android.mk for openssl references ==="
          grep -n "openssl\|libcrypto\|libssl\|OPENSSL\|crypto\b\|ssl\b" "${JNI_DIR}/Android.mk" || true

          # Read the exact include line
          INCLUDE_LINE=$(grep "openssl/Android.mk" "${JNI_DIR}/Android.mk" || true)
          echo "Include line: ${INCLUDE_LINE}"

          # Check what module names are referenced as dependencies
          echo ""
          echo "=== All LOCAL_SHARED_LIBRARIES and LOCAL_STATIC_LIBRARIES ==="
          grep -n "LOCAL_SHARED_LIBRARIES\|LOCAL_STATIC_LIBRARIES\|LOCAL_LDLIBS" "${JNI_DIR}/Android.mk" || true

          # Check all .mk files for crypto/ssl references
          echo ""
          echo "=== References in all .mk files ==="
          find "${JNI_DIR}" -name "*.mk" -exec grep -ln "crypto\|ssl\|openssl" {} \; 2>/dev/null || true

          for mkfile in $(find "${JNI_DIR}" -name "*.mk" ! -path "*/openssl/*"); do
            refs=$(grep -n "crypto\|libssl\|openssl" "$mkfile" 2>/dev/null || true)
            if [ -n "$refs" ]; then
              echo ""
              echo "--- $mkfile ---"
              echo "$refs"
            fi
          done

      - name: Generate correct openssl/Android.mk based on analysis
        run: |
          set -e

          JNI_DIR="${GITHUB_WORKSPACE}/ss-full/src/frontends/android/app/src/main/jni"
          OPENSSL_JNI="${JNI_DIR}/openssl"

          # The strongSwan Android.mk typically just does:
          #   include $(LOCAL_PATH)/openssl/Android.mk
          # And expects modules named "libcrypto_static" and "libssl_static"
          # OR "crypto" and "ssl" depending on the version.
          #
          # Let's provide ALL possible module names to be safe.

          cat > "${OPENSSL_JNI}/Android.mk" << 'EOF'
LOCAL_PATH := $(call my-dir)

# --- libcrypto prebuilt static ---
include $(CLEAR_VARS)
LOCAL_MODULE := libcrypto_static
LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libcrypto.a
LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
include $(PREBUILT_STATIC_LIBRARY)

# --- libssl prebuilt static ---
include $(CLEAR_VARS)
LOCAL_MODULE := libssl_static
LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libssl.a
LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
include $(PREBUILT_STATIC_LIBRARY)

# --- Alias: crypto ---
include $(CLEAR_VARS)
LOCAL_MODULE := crypto
LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libcrypto.a
LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
include $(PREBUILT_STATIC_LIBRARY)

# --- Alias: ssl ---
include $(CLEAR_VARS)
LOCAL_MODULE := ssl
LOCAL_SRC_FILES := libs/$(TARGET_ARCH_ABI)/libssl.a
LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
include $(PREBUILT_STATIC_LIBRARY)
EOF

          echo "=== Final openssl/Android.mk ==="
          cat "${OPENSSL_JNI}/Android.mk"

          echo ""
          echo "=== Complete openssl directory structure ==="
          find "${OPENSSL_JNI}" -type f | sort | head -30
          echo "..."
          find "${OPENSSL_JNI}" -name "*.a" -ls

      - name: Verify all build prerequisites
        run: |
          set -e

          JNI_DIR="${GITHUB_WORKSPACE}/ss-full/src/frontends/android/app/src/main/jni"

          echo "=== JNI root contents ==="
          ls -la "${JNI_DIR}/"

          echo ""
          echo "=== openssl/ contents ==="
          ls -la "${JNI_DIR}/openssl/"

          echo ""
          echo "=== Checking that openssl/Android.mk is readable ==="
          head -5 "${JNI_DIR}/openssl/Android.mk"

          echo ""
          echo "=== Verify .a files for all ABIs ==="
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            echo "  ${ABI}:"
            ls -la "${JNI_DIR}/openssl/libs/${ABI}/" 2>/dev/null || echo "    MISSING!"
          done

          echo ""
          echo "=== Verify headers ==="
          ls "${JNI_DIR}/openssl/include/openssl/" | head -10

          echo ""
          echo "=== NDK version ==="
          cat "${ANDROID_NDK_HOME}/source.properties"

      - name: Build strongSwan APK
        run: |
          cd ss-full/src/frontends/android

          cat > local.properties << EOF
          sdk.dir=${ANDROID_SDK_ROOT}
          ndk.dir=${ANDROID_NDK_HOME}
          EOF

          chmod +x ./gradlew 2>/dev/null || true

          # Build with full output
          ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            --info \
            2>&1 | tail -300

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strongswan-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: |
            ss-full/src/frontends/android/app/build/intermediates/cxx/
            ss-full/src/frontends/android/app/src/main/jni/openssl/Android.mk
            ss-full/src/frontends/android/app/src/main/jni/Android.mk
