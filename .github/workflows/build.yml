name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Autogen and configure
        run: |
          cd ss-full
          ./autogen.sh
          ./configure

      - name: Verify Android prerequisites
        run: |
          SS="ss-full"
          echo "=== Required files ==="
          for f in Android.common.mk src/libstrongswan/Android.mk src/libcharon/Android.mk src/libipsec/Android.mk src/libtnccs/Android.mk src/libtncif/Android.mk src/libimcv/Android.mk src/libtpmtss/Android.mk; do
            if [ -f "${SS}/${f}" ]; then
              echo "OK   ${f}"
            else
              echo "MISS ${f}"
            fi
          done
          echo ""
          echo "=== Android.common.mk ==="
          cat "${SS}/Android.common.mk"
          echo ""
          echo "=== libstrongswan deps ==="
          grep -n "SHARED_LIBRARIES\|STATIC_LIBRARIES\|crypto\|ssl" "${SS}/src/libstrongswan/Android.mk" | head -20

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL shared libs for Android
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"

          build_ssl() {
            local ABI=$1 TARGET=$2
            echo ""
            echo "===== Building OpenSSL for ${ABI} (${TARGET}) ====="
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            rm -rf "${BUILD_DIR}" "${OUT_DIR}"
            cp -r "openssl-${{ env.OPENSSL_VERSION }}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" \
              -D__ANDROID_API__=21 \
              --prefix="${OUT_DIR}" \
              --openssldir="${OUT_DIR}" \
              --libdir=lib \
              no-tests \
              no-ui-console
            make -j$(nproc)
            make install_sw
            echo "Installed:"
            find "${OUT_DIR}" \( -name "*.so*" -o -name "*.a" \) -ls
            cd "${GITHUB_WORKSPACE}"
          }

          build_ssl arm64-v8a android-arm64
          build_ssl armeabi-v7a android-arm
          build_ssl x86 android-x86
          build_ssl x86_64 android-x86_64

      - name: Setup OpenSSL in JNI directory
        run: |
          set -e
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          mkdir -p "${OSSL}/include"

          cp -r "${GITHUB_WORKSPACE}/openssl-out-arm64-v8a/include/openssl" "${OSSL}/include/"

          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            DEST="${OSSL}/${ABI}"
            mkdir -p "${DEST}"
            OUT="${GITHUB_WORKSPACE}/openssl-out-${ABI}"

            for LIB in libcrypto libssl; do
              REAL=$(find "${OUT}/lib" -name "${LIB}.so*" ! -type l 2>/dev/null | head -1)
              if [ -n "${REAL}" ]; then
                cp "${REAL}" "${DEST}/${LIB}.so"
              else
                LINK=$(find "${OUT}/lib" -name "${LIB}.so" -type l 2>/dev/null | head -1)
                if [ -n "${LINK}" ]; then
                  cp -L "${LINK}" "${DEST}/${LIB}.so"
                else
                  echo "ERROR: ${LIB}.so not found for ${ABI}"
                  find "${OUT}" -name "${LIB}*" -ls
                  exit 1
                fi
              fi
            done
            echo "${ABI}: $(ls -la ${DEST}/)"
          done

          echo ""
          echo "=== Verify all .so files ==="
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            for LIB in libcrypto libssl; do
              F="${OSSL}/${ABI}/${LIB}.so"
              if [ -f "${F}" ]; then
                echo "OK   ${F} ($(stat -c%s "${F}") bytes)"
              else
                echo "FAIL ${F} missing"
                exit 1
              fi
            done
          done

      - name: Create openssl Android.mk
        run: |
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          cat > "${OSSL}/Android.mk" << 'ENDMK'
          LOCAL_PATH := $(call my-dir)
          include $(CLEAR_VARS)
          LOCAL_MODULE := libcrypto
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)
          include $(CLEAR_VARS)
          LOCAL_MODULE := libssl
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)
          ENDMK
          echo "=== openssl/Android.mk ==="
          cat "${OSSL}/Android.mk"
          echo ""
          echo "=== Full openssl directory ==="
          find "${OSSL}" -type f | sort

      - name: Build APK
        run: |
          cd ss-full/src/frontends/android
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          echo "ndk.dir=${ANDROID_NDK_HOME}" >> local.properties
          set +e
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"
          RESULT=${PIPESTATUS[0]}
          set -e
          if [ ${RESULT} -ne 0 ]; then
            echo ""
            echo "============================================"
            echo "BUILD FAILED - Error details:"
            echo "============================================"
            echo ""
            echo "--- NDK/Make errors ---"
            grep -n "error:\|FAILED\|No such file\|Stop\.\|cannot find\|undefined reference\|fatal\|^make:" "${GITHUB_WORKSPACE}/build.log" | grep -iv "Xlint\|deprecation\|stacktrace\|--info\|--debug\|--scan\|help.gradle\|compilerArgs\|configureEach\|ProcessException\|ExecException" | head -40
            echo ""
            echo "--- Error context ---"
            grep -n -B5 -A10 "error when building\|No such file\|^make:\|Stop\." "${GITHUB_WORKSPACE}/build.log" | head -150
            echo ""
            echo "--- Last 30 lines before FAILED ---"
            grep -n -B30 "FAILED" "${GITHUB_WORKSPACE}/build.log" | head -60
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strongswan-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
