name: Build strongSwan APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.3.1"
  NDK_VERSION: "27.3.13750724"
  CUSTOM_APP_ID: "com.asadvpn.client"
  CUSTOM_APP_NAME: "AsadVPN"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config gettext python3 bison flex gperf perl curl unzip git libssl-dev libgmp-dev

      - name: Set environment
        run: |
          echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV

      - name: Clone strongSwan
        run: git clone --depth 1 https://github.com/strongswan/strongswan.git ss-full

      - name: Generate strongSwan source files
        run: |
          cd ss-full
          ./autogen.sh
          ./configure \
            --enable-openssl \
            --enable-eap-identity \
            --enable-eap-mschapv2 \
            --enable-eap-md5 \
            --enable-eap-gtc \
            --enable-eap-tls \
            --enable-eap-ttls \
            --enable-eap-tnc
          make -j$(nproc) 2>&1 | tail -20 || echo "Host make done"
          if [ ! -f src/libstrongswan/asn1/oid.c ]; then
            cd src/libstrongswan/asn1 && perl oid.pl oid.txt oid.c oid.h && cd ../../..
          fi
          if [ ! -f Android.common.mk ]; then
            VERSION=$(sed -n "s/^PACKAGE_VERSION='\(.*\)'/\1/p" configure | head -1)
            echo "strongswan_VERSION := ${VERSION}" > Android.common.mk
          fi

      - name: Download OpenSSL
        run: |
          curl -fL -o openssl.tar.gz "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar xzf openssl.tar.gz

      - name: Build OpenSSL for Android
        run: |
          set -e
          export ANDROID_NDK_ROOT="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"
          build_ssl() {
            local ABI=$1 TARGET=$2
            local BUILD_DIR="${GITHUB_WORKSPACE}/openssl-build-${ABI}"
            local OUT_DIR="${GITHUB_WORKSPACE}/openssl-out-${ABI}"
            rm -rf "${BUILD_DIR}" "${OUT_DIR}"
            cp -r "openssl-${{ env.OPENSSL_VERSION }}" "${BUILD_DIR}"
            cd "${BUILD_DIR}"
            ./Configure "${TARGET}" -D__ANDROID_API__=21 --prefix="${OUT_DIR}" --openssldir="${OUT_DIR}" --libdir=lib no-tests no-ui-console
            make -j$(nproc)
            make install_sw
            cd "${GITHUB_WORKSPACE}"
          }
          build_ssl arm64-v8a android-arm64
          build_ssl armeabi-v7a android-arm
          build_ssl x86 android-x86
          build_ssl x86_64 android-x86_64

      - name: Setup OpenSSL in JNI directory
        run: |
          set -e
          OSSL="ss-full/src/frontends/android/app/src/main/jni/openssl"
          mkdir -p "${OSSL}/include"
          cp -r "${GITHUB_WORKSPACE}/openssl-out-arm64-v8a/include/openssl" "${OSSL}/include/"
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            DEST="${OSSL}/${ABI}"
            mkdir -p "${DEST}"
            OUT="${GITHUB_WORKSPACE}/openssl-out-${ABI}/lib"
            for LIB in libcrypto libssl; do
              REAL=$(find "${OUT}" -name "${LIB}.so*" ! -type l 2>/dev/null | head -1)
              if [ -n "${REAL}" ]; then cp "${REAL}" "${DEST}/${LIB}.so"
              else cp -L "${OUT}/${LIB}.so" "${DEST}/${LIB}.so"; fi
            done
          done

      - name: Create openssl Android.mk
        run: |
          TARGET="ss-full/src/frontends/android/app/src/main/jni/openssl/Android.mk"
          cat > "${TARGET}" << 'ENDOFMK'
          LOCAL_PATH := $(call my-dir)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libcrypto
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := crypto_static
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libcrypto.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := libssl
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)

          include $(CLEAR_VARS)
          LOCAL_MODULE := ssl_static
          LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/libssl.so
          LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/include
          include $(PREBUILT_SHARED_LIBRARY)
          ENDOFMK
          sed -i 's/^          //' "${TARGET}"

      - name: Patch strongSwan for build
        run: |
          cd ss-full
          JNI_MK="src/frontends/android/app/src/main/jni/Android.mk"
          JNI_DIR="src/frontends/android/app/src/main/jni"
          sed -i 's/^strongswan_USE_BYOD := true/strongswan_USE_BYOD :=/' "${JNI_MK}"
          sed -i 's/ eap-tls//' "${JNI_MK}"
          find src/frontends/android -name "*.java" -exec grep -l "USE_BYOD" {} \; | while read f; do
            sed -i 's/USE_BYOD = true/USE_BYOD = false/g' "$f"
          done
          find "${JNI_DIR}" -name "*.mk" -exec grep -l "crypto_static\|ssl_static" {} \; 2>/dev/null | while read mkfile; do
            sed -i '/LOCAL_STATIC_LIBRARIES.*crypto_static/{ s/crypto_static// }' "${mkfile}"
            sed -i '/LOCAL_STATIC_LIBRARIES.*ssl_static/{ s/ssl_static// }' "${mkfile}"
            if ! grep -q "LOCAL_SHARED_LIBRARIES.*crypto_static" "${mkfile}"; then
              if grep -q "LOCAL_SHARED_LIBRARIES" "${mkfile}"; then
                sed -i '0,/LOCAL_SHARED_LIBRARIES/{s/LOCAL_SHARED_LIBRARIES\(.*\)/LOCAL_SHARED_LIBRARIES\1 crypto_static ssl_static/}' "${mkfile}"
              else
                sed -i '/include \$(BUILD_SHARED_LIBRARY)/i LOCAL_SHARED_LIBRARIES += crypto_static ssl_static' "${mkfile}"
              fi
            fi
          done

      - name: Rebrand as AsadVPN
        run: |
          cd ss-full/src/frontends/android
          sed -i "s|applicationId \"org.strongswan.android\"|applicationId \"${CUSTOM_APP_ID}\"|g" app/build.gradle
          find . -name "strings.xml" | while read str; do
            sed -i "s|<string name=\"app_name\">strongSwan VPN Client</string>|<string name=\"app_name\">${CUSTOM_APP_NAME}</string>|g" "${str}"
          done
          sed -i 's|android:authorities="org.strongswan.android.content.log"|android:authorities="com.asadvpn.client.content.log"|g' app/src/main/AndroidManifest.xml
          find . -name "LogContentProvider.java" | while read f; do
            sed -i 's|org.strongswan.android.content.log|com.asadvpn.client.content.log|g' "$f"
          done
          grep -rl "org.strongswan.android.content.log" app/src/main/ 2>/dev/null | while read f; do
            sed -i 's|org.strongswan.android.content.log|com.asadvpn.client.content.log|g' "$f"
          done
          MANIFEST="app/src/main/AndroidManifest.xml"
          sed -i 's|org.strongswan.android.action.START_PROFILE|com.asadvpn.client.action.START_PROFILE|g' "${MANIFEST}"
          sed -i 's|org.strongswan.android.action.DISCONNECT|com.asadvpn.client.action.DISCONNECT|g' "${MANIFEST}"
          find . -name "VpnProfileControlActivity.java" | while read f; do
            sed -i 's|org.strongswan.android.action.START_PROFILE|com.asadvpn.client.action.START_PROFILE|g' "$f"
            sed -i 's|org.strongswan.android.action.DISCONNECT|com.asadvpn.client.action.DISCONNECT|g' "$f"
            sed -i 's|org.strongswan.android.VPN_PROFILE_UUID|com.asadvpn.client.VPN_PROFILE_UUID|g' "$f"
            sed -i 's|org.strongswan.android.VPN_PROFILE_ID|com.asadvpn.client.VPN_PROFILE_ID|g' "$f"
            sed -i 's|org.strongswan.android.VpnNotSupportedError|com.asadvpn.client.VpnNotSupportedError|g' "$f"
          done

      - name: Generate lion app icon
        run: |
          cd ss-full/src/frontends/android
          RES_DIR="app/src/main/res"
          for DIR in drawable drawable-v24 mipmap-anydpi-v26; do mkdir -p "${RES_DIR}/${DIR}"; done
          cat > "${RES_DIR}/drawable/ic_launcher_foreground.xml" << 'ICON_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#1a1a2e"
                  android:pathData="M54,54m-54,0a54,54 0,1 1,108 0a54,54 0,1 1,-108 0"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M54,18 C36,18 24,28 22,38 C20,46 22,52 24,56 C22,60 20,66 22,72 C24,78 30,84 38,88 C44,90 49,91 54,91 C59,91 64,90 70,88 C78,84 84,78 86,72 C88,66 86,60 84,56 C86,52 88,46 86,38 C84,28 72,18 54,18Z"/>
              <path android:fillColor="#B8862D" android:pathData="M54,16 L58,24 L50,24Z"/>
              <path android:fillColor="#B8862D" android:pathData="M40,20 L46,28 L38,26Z"/>
              <path android:fillColor="#B8862D" android:pathData="M68,20 L70,26 L62,28Z"/>
              <path android:fillColor="#B8862D" android:pathData="M28,30 L34,34 L28,38Z"/>
              <path android:fillColor="#B8862D" android:pathData="M80,30 L80,38 L74,34Z"/>
              <path android:fillColor="#B8862D" android:pathData="M22,44 L28,46 L24,52Z"/>
              <path android:fillColor="#B8862D" android:pathData="M86,44 L84,52 L80,46Z"/>
              <path android:fillColor="#E8C07A"
                  android:pathData="M54,28 C40,28 32,36 30,44 C28,50 30,56 34,62 C38,68 44,76 50,80 C52,81 53,81 54,81 C55,81 56,81 58,80 C64,76 70,68 74,62 C78,56 80,50 78,44 C76,36 68,28 54,28Z"/>
              <path android:fillColor="#F0D090"
                  android:pathData="M54,34 C44,34 38,40 36,46 C34,52 36,58 40,64 C44,68 48,72 54,74 C60,72 64,68 68,64 C72,58 74,52 72,46 C70,40 64,34 54,34Z"/>
              <path android:fillColor="#C4954A" android:pathData="M30,32 L24,20 L38,28Z"/>
              <path android:fillColor="#E8A0A0" android:pathData="M31,31 L27,24 L36,29Z"/>
              <path android:fillColor="#C4954A" android:pathData="M78,32 L84,20 L70,28Z"/>
              <path android:fillColor="#E8A0A0" android:pathData="M77,31 L81,24 L72,29Z"/>
              <path android:fillColor="#FFFFFF"
                  android:pathData="M42,48 C42,45 44,43 47,43 C50,43 52,45 52,48 C52,51 50,53 47,53 C44,53 42,51 42,48Z"/>
              <path android:fillColor="#2D5A27"
                  android:pathData="M44,47 C44,45.5 45.3,44.5 47,44.5 C48.7,44.5 50,45.5 50,47 C50,48.5 48.7,49.5 47,49.5 C45.3,49.5 44,48.5 44,47Z"/>
              <path android:fillColor="#111111"
                  android:pathData="M45.5,46.5 C45.5,45.8 46.2,45.2 47,45.2 C47.8,45.2 48.5,45.8 48.5,46.5 C48.5,47.2 47.8,47.8 47,47.8 C46.2,47.8 45.5,47.2 45.5,46.5Z"/>
              <path android:fillColor="#FFFFFF"
                  android:pathData="M56,48 C56,45 58,43 61,43 C64,43 66,45 66,48 C66,51 64,53 61,53 C58,53 56,51 56,48Z"/>
              <path android:fillColor="#2D5A27"
                  android:pathData="M58,47 C58,45.5 59.3,44.5 61,44.5 C62.7,44.5 64,45.5 64,47 C64,48.5 62.7,49.5 61,49.5 C59.3,49.5 58,48.5 58,47Z"/>
              <path android:fillColor="#111111"
                  android:pathData="M59.5,46.5 C59.5,45.8 60.2,45.2 61,45.2 C61.8,45.2 62.5,45.8 62.5,46.5 C62.5,47.2 61.8,47.8 61,47.8 C60.2,47.8 59.5,47.2 59.5,46.5Z"/>
              <path android:fillColor="#8B5E3C"
                  android:pathData="M50,58 L54,55 L58,58 L56,61 L52,61Z"/>
              <path android:fillColor="#6B4226"
                  android:pathData="M52,57 L54,55 L56,57 L54,59Z"/>
              <path android:strokeColor="#8B5E3C" android:strokeWidth="1.2" android:fillColor="#00000000"
                  android:pathData="M54,61 L54,65"/>
              <path android:strokeColor="#8B5E3C" android:strokeWidth="1.2" android:fillColor="#00000000"
                  android:pathData="M54,65 Q48,69 44,67"/>
              <path android:strokeColor="#8B5E3C" android:strokeWidth="1.2" android:fillColor="#00000000"
                  android:pathData="M54,65 Q60,69 64,67"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M36,58 m-1.2,0 a1.2,1.2 0 1,1 2.4,0 a1.2,1.2 0 1,1 -2.4,0"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M34,62 m-1.2,0 a1.2,1.2 0 1,1 2.4,0 a1.2,1.2 0 1,1 -2.4,0"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M36,66 m-1.2,0 a1.2,1.2 0 1,1 2.4,0 a1.2,1.2 0 1,1 -2.4,0"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M72,58 m-1.2,0 a1.2,1.2 0 1,1 2.4,0 a1.2,1.2 0 1,1 -2.4,0"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M74,62 m-1.2,0 a1.2,1.2 0 1,1 2.4,0 a1.2,1.2 0 1,1 -2.4,0"/>
              <path android:fillColor="#C4954A"
                  android:pathData="M72,66 m-1.2,0 a1.2,1.2 0 1,1 2.4,0 a1.2,1.2 0 1,1 -2.4,0"/>
              <path android:fillColor="#00d4aa"
                  android:pathData="M80,72 L88,68 L88,78 C88,82 84,86 80,88 C76,86 72,82 72,78 L72,68Z"/>
              <path android:fillColor="#1a1a2e"
                  android:pathData="M77,76 L83,76 L83,82 L77,82Z"/>
              <path android:fillColor="#00000000" android:strokeColor="#1a1a2e" android:strokeWidth="1.5"
                  android:pathData="M78,76 L78,74 C78,72 79,71 80,71 C81,71 82,72 82,74 L82,76"/>
          </vector>
          ICON_EOF
          cat > "${RES_DIR}/drawable/ic_launcher_background.xml" << 'BG_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#1a1a2e" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          BG_EOF
          cat > "${RES_DIR}/mipmap-anydpi-v26/ic_launcher.xml" << 'ADP'
          <?xml version="1.0" encoding="utf-8"?>
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          ADP
          cp "${RES_DIR}/mipmap-anydpi-v26/ic_launcher.xml" "${RES_DIR}/mipmap-anydpi-v26/ic_launcher_round.xml"
          python3 << 'PYEOF'
          import struct, zlib, os
          def create_png(w, h, bg, mane, face, accent):
              raw = []
              cx, cy = w // 2, h // 2
              r_out = min(w, h) // 2 - 2
              r_mane = int(r_out * 0.85)
              r_face = int(r_out * 0.6)
              for y in range(h):
                  row = [0]
                  for x in range(w):
                      dx, dy = x - cx, y - cy
                      d = dx * dx + dy * dy
                      if d <= r_face * r_face: row.extend(face)
                      elif d <= r_mane * r_mane: row.extend(mane)
                      elif d <= r_out * r_out: row.extend(accent)
                      else: row.extend(bg)
                  raw.append(bytes(row))
              raw_data = b''.join(raw)
              def chunk(ct, d):
                  c = ct + d
                  return struct.pack('>I', len(d)) + c + struct.pack('>I', zlib.crc32(c) & 0xffffffff)
              return (b'\x89PNG\r\n\x1a\n' +
                      chunk(b'IHDR', struct.pack('>IIBBBBB', w, h, 8, 2, 0, 0, 0)) +
                      chunk(b'IDAT', zlib.compress(raw_data)) +
                      chunk(b'IEND', b''))
          base = 'ss-full/src/frontends/android/app/src/main/res'
          for f, s in {'mipmap-mdpi': 48, 'mipmap-hdpi': 72, 'mipmap-xhdpi': 96,
                       'mipmap-xxhdpi': 144, 'mipmap-xxxhdpi': 192}.items():
              p = os.path.join(base, f); os.makedirs(p, exist_ok=True)
              png = create_png(s, s, [26,26,46], [196,149,74], [232,192,122], [0,212,170])
              for n in ['ic_launcher.png', 'ic_launcher_round.png']:
                  with open(os.path.join(p, n), 'wb') as fh: fh.write(png)
          PYEOF

      - name: Create UI resources
        run: |
          cd ss-full/src/frontends/android
          RES_DIR="app/src/main/res"
          cat > "${RES_DIR}/layout/activity_asadvpn_main.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent"
              android:orientation="vertical" android:gravity="center_horizontal"
              android:background="#1a1a2e" android:padding="24dp">
              <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                  android:text="AsadVPN" android:textSize="32sp" android:textColor="#00d4aa"
                  android:textStyle="bold" android:layout_marginTop="40dp"/>
              <TextView android:id="@+id/status_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="Disconnected"
                  android:textSize="18sp" android:textColor="#ffffff" android:layout_marginTop="16dp"/>
              <TextView android:id="@+id/server_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="" android:textSize="14sp"
                  android:textColor="#aaaaaa" android:layout_marginTop="8dp"/>
              <TextView android:id="@+id/days_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="" android:textSize="16sp"
                  android:textColor="#ffcc00" android:layout_marginTop="16dp"/>
              <Button android:id="@+id/connect_button" android:layout_width="200dp"
                  android:layout_height="200dp" android:layout_marginTop="40dp"
                  android:background="@drawable/circle_button_connect" android:text="CONNECT"
                  android:textSize="20sp" android:textColor="#ffffff" android:textStyle="bold"/>
              <View android:layout_width="0dp" android:layout_height="0dp" android:layout_weight="1"/>
              <TextView android:id="@+id/update_text" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:text="" android:textSize="11sp"
                  android:textColor="#666666" android:layout_marginBottom="8dp"/>
              <Button android:id="@+id/import_button" android:layout_width="match_parent"
                  android:layout_height="48dp" android:text="Import Profile" android:textColor="#ffffff"
                  android:backgroundTint="#333355" android:layout_marginBottom="8dp"/>
              <Button android:id="@+id/scan_button" android:layout_width="match_parent"
                  android:layout_height="48dp" android:text="Scan QR Code" android:textColor="#ffffff"
                  android:backgroundTint="#333355" android:layout_marginBottom="16dp"/>
          </LinearLayout>
          XML_EOF
          cat > "${RES_DIR}/layout/dialog_import_profile.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="wrap_content"
              android:orientation="vertical" android:padding="24dp">
              <TextView android:layout_width="match_parent" android:layout_height="wrap_content"
                  android:text="Paste your encrypted profile code below:" android:textSize="14sp"
                  android:layout_marginBottom="12dp"/>
              <EditText android:id="@+id/profile_input" android:layout_width="match_parent"
                  android:layout_height="120dp" android:hint="Paste encrypted profile here..."
                  android:gravity="top" android:inputType="textMultiLine"
                  android:background="#f0f0f0" android:padding="8dp"/>
          </LinearLayout>
          XML_EOF
          cat > "${RES_DIR}/layout/activity_qr_scanner.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent"
              android:background="#000000">
              <SurfaceView android:id="@+id/camera_preview"
                  android:layout_width="match_parent" android:layout_height="match_parent"/>
              <LinearLayout android:layout_width="match_parent" android:layout_height="wrap_content"
                  android:layout_gravity="top" android:orientation="vertical"
                  android:background="#88000000" android:padding="16dp">
                  <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                      android:text="Scan QR Code" android:textColor="#00d4aa"
                      android:textSize="20sp" android:textStyle="bold"/>
                  <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                      android:text="Point camera at your AsadVPN QR code" android:textColor="#aaaaaa"
                      android:textSize="13sp" android:layout_marginTop="4dp"/>
              </LinearLayout>
              <View android:layout_width="220dp" android:layout_height="220dp"
                  android:layout_gravity="center" android:background="@drawable/qr_frame"/>
              <Button android:id="@+id/cancel_scan" android:layout_width="wrap_content"
                  android:layout_height="wrap_content" android:layout_gravity="bottom|center_horizontal"
                  android:layout_marginBottom="40dp" android:text="Cancel"
                  android:textColor="#ffffff" android:backgroundTint="#ff4444"
                  android:paddingLeft="32dp" android:paddingRight="32dp"/>
          </FrameLayout>
          XML_EOF
          mkdir -p "${RES_DIR}/drawable"
          cat > "${RES_DIR}/drawable/circle_button_connect.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <selector xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:state_pressed="true"><shape android:shape="oval"><solid android:color="#008866"/><stroke android:width="3dp" android:color="#00d4aa"/></shape></item>
              <item><shape android:shape="oval"><solid android:color="#00aa88"/><stroke android:width="3dp" android:color="#00d4aa"/></shape></item>
          </selector>
          XML_EOF
          cat > "${RES_DIR}/drawable/circle_button_disconnect.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <selector xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:state_pressed="true"><shape android:shape="oval"><solid android:color="#cc3333"/><stroke android:width="3dp" android:color="#ff4444"/></shape></item>
              <item><shape android:shape="oval"><solid android:color="#dd4444"/><stroke android:width="3dp" android:color="#ff4444"/></shape></item>
          </selector>
          XML_EOF
          cat > "${RES_DIR}/drawable/qr_frame.xml" << 'XML_EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="rectangle">
              <stroke android:width="2dp" android:color="#00d4aa" android:dashWidth="8dp" android:dashGap="4dp"/>
              <corners android:radius="12dp"/>
          </shape>
          XML_EOF

      - name: Create logic classes
        run: |
          cd ss-full/src/frontends/android
          JAVA_DIR="app/src/main/java/org/strongswan/android"
          mkdir -p "${JAVA_DIR}/logic"

          cat > "${JAVA_DIR}/logic/ProfileCrypto.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.util.Base64;
          import java.nio.charset.StandardCharsets;
          import java.security.MessageDigest;
          import javax.crypto.Cipher;
          import javax.crypto.spec.GCMParameterSpec;
          import javax.crypto.spec.SecretKeySpec;
          import org.json.JSONArray;
          import org.json.JSONObject;

          public class ProfileCrypto {
              private static final String MASTER_KEY = "As4dVPN-2024!SecretKey#Encrypted";

              public static class ServerInfo {
                  public String address;
                  public String name;
                  public String username;
                  public String password;
                  public String caCertPem;
                  public String remoteId;
                  public boolean hasCaCert() {
                      return caCertPem != null && !caCertPem.isEmpty();
                  }
              }

              public static class ProfileData {
                  public ServerInfo[] servers;
                  public long expiryTimestamp;
                  public String profileId;
                  public String updateUrl;
                  public String ikeProposal;
                  public String espProposal;
                  public Integer mtu;
                  public Integer splitTunneling;
                  public boolean isExpired() {
                      return System.currentTimeMillis() > expiryTimestamp;
                  }
                  public int remainingDays() {
                      long diff = expiryTimestamp - System.currentTimeMillis();
                      if (diff <= 0) return 0;
                      return (int)(diff / (1000L * 60 * 60 * 24));
                  }
              }

              public static ProfileData decryptProfile(String encryptedBase64) throws Exception {
                  byte[] encrypted = Base64.decode(encryptedBase64.trim(), Base64.DEFAULT | Base64.NO_WRAP);
                  if (encrypted.length < 13) throw new Exception("Data too short");
                  byte[] iv = new byte[12];
                  byte[] ciphertext = new byte[encrypted.length - 12];
                  System.arraycopy(encrypted, 0, iv, 0, 12);
                  System.arraycopy(encrypted, 12, ciphertext, 0, ciphertext.length);
                  MessageDigest sha256 = MessageDigest.getInstance("SHA-256");
                  byte[] keyBytes = sha256.digest(MASTER_KEY.getBytes(StandardCharsets.UTF_8));
                  SecretKeySpec keySpec = new SecretKeySpec(keyBytes, "AES");
                  Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
                  cipher.init(Cipher.DECRYPT_MODE, keySpec, new GCMParameterSpec(128, iv));
                  byte[] plaintext = cipher.doFinal(ciphertext);
                  return parseProfile(new String(plaintext, StandardCharsets.UTF_8));
              }

              public static ProfileData parseProfile(String json) throws Exception {
                  JSONObject obj = new JSONObject(json);
                  ProfileData data = new ProfileData();
                  data.profileId = obj.getString("id");
                  data.expiryTimestamp = obj.getLong("expiry");
                  data.updateUrl = obj.optString("updateUrl", "");
                  data.ikeProposal = obj.optString("ikeProposal", null);
                  data.espProposal = obj.optString("espProposal", null);
                  if (obj.has("mtu")) data.mtu = obj.getInt("mtu");
                  if (obj.has("splitTunneling")) data.splitTunneling = obj.getInt("splitTunneling");
                  String topUser = obj.optString("username", null);
                  String topPass = obj.optString("password", null);
                  JSONArray serversArr = obj.getJSONArray("servers");
                  data.servers = new ServerInfo[serversArr.length()];
                  for (int i = 0; i < serversArr.length(); i++) {
                      JSONObject s = serversArr.getJSONObject(i);
                      ServerInfo si = new ServerInfo();
                      si.address = s.getString("addr");
                      si.name = s.optString("name", si.address);
                      si.username = s.optString("username", topUser);
                      si.password = s.optString("password", topPass);
                      si.caCertPem = s.optString("caCert", null);
                      si.remoteId = s.optString("remoteId", null);
                      data.servers[i] = si;
                  }
                  return data;
              }
          }
          JAVA_EOF

          cat > "${JAVA_DIR}/logic/CertificateImporter.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.content.Context;
          import android.util.Log;
          import java.io.ByteArrayInputStream;
          import java.io.File;
          import java.io.FileOutputStream;
          import java.nio.charset.StandardCharsets;
          import java.security.MessageDigest;
          import java.security.cert.CertificateFactory;
          import java.security.cert.X509Certificate;

          public class CertificateImporter {
              private static final String TAG = "AsadVPN.CertImport";

              public static String importCaCertificate(Context context, String pemData) {
                  try {
                      CertificateFactory cf = CertificateFactory.getInstance("X.509");
                      ByteArrayInputStream bis = new ByteArrayInputStream(
                          pemData.getBytes(StandardCharsets.UTF_8));
                      X509Certificate cert = (X509Certificate) cf.generateCertificate(bis);
                      bis.close();
                      cert.checkValidity();
                      byte[] encoded = cert.getEncoded();
                      MessageDigest md = MessageDigest.getInstance("SHA-256");
                      byte[] digest = md.digest(encoded);
                      StringBuilder sb = new StringBuilder();
                      for (int i = 0; i < Math.min(8, digest.length); i++) {
                          sb.append(String.format("%02x", digest[i]));
                      }
                      String alias = sb.toString();
                      File certDir = new File(context.getFilesDir(), "keychain");
                      if (!certDir.exists()) certDir.mkdirs();
                      File certFile = new File(certDir, alias + ".pem");
                      FileOutputStream fos = new FileOutputStream(certFile);
                      fos.write(pemData.getBytes(StandardCharsets.UTF_8));
                      fos.close();
                      Log.i(TAG, "CA cert saved: " + certFile.getAbsolutePath()
                          + " subject=" + cert.getSubjectX500Principal().getName());
                      try {
                          TrustedCertificateManager.getInstance().reset();
                      } catch (Exception e) {
                          Log.w(TAG, "TCM reset: " + e.getMessage());
                      }
                      return alias;
                  } catch (Exception e) {
                      Log.e(TAG, "CA cert import failed", e);
                      return null;
                  }
              }
          }
          JAVA_EOF

          cat > "${JAVA_DIR}/logic/ProfileManager.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.content.Context;
          import android.content.SharedPreferences;
          import android.util.Log;
          import org.json.JSONObject;
          import org.json.JSONArray;
          import java.io.BufferedReader;
          import java.io.InputStreamReader;
          import java.net.HttpURLConnection;
          import java.net.URL;

          public class ProfileManager {
              private static final String TAG = "AsadVPN.ProfileMgr";
              private static final String PREFS = "asadvpn_profiles";
              private static final String KEY_PROFILE = "active_profile";
              private static final String KEY_LAST_UPDATE = "last_update_check";
              private static final long UPDATE_INTERVAL = 2 * 24 * 60 * 60 * 1000L;
              private final SharedPreferences prefs;

              public ProfileManager(Context ctx) {
                  this.prefs = ctx.getSharedPreferences(PREFS, Context.MODE_PRIVATE);
              }

              public ProfileCrypto.ProfileData importProfile(String encData) throws Exception {
                  ProfileCrypto.ProfileData data = ProfileCrypto.decryptProfile(encData);
                  prefs.edit()
                      .putString(KEY_PROFILE, dataToJson(data))
                      .putLong(KEY_LAST_UPDATE, System.currentTimeMillis())
                      .apply();
                  Log.i(TAG, "Imported: " + data.profileId + ", " + data.servers.length + " servers");
                  return data;
              }

              public ProfileCrypto.ProfileData getActiveProfile() {
                  String json = prefs.getString(KEY_PROFILE, null);
                  if (json == null) return null;
                  try { return ProfileCrypto.parseProfile(json); }
                  catch (Exception e) { Log.e(TAG, "Parse error", e); return null; }
              }

              public long getLastUpdateTime() { return prefs.getLong(KEY_LAST_UPDATE, 0); }

              public void forceUpdate(UpdateCallback cb) {
                  ProfileCrypto.ProfileData data = getActiveProfile();
                  if (data == null || data.updateUrl == null || data.updateUrl.isEmpty()) {
                      if (cb != null) cb.onError(new Exception("No update URL"));
                      return;
                  }
                  performUpdate(data, cb);
              }

              public void checkForUpdates(UpdateCallback cb) {
                  ProfileCrypto.ProfileData data = getActiveProfile();
                  if (data == null || data.updateUrl == null || data.updateUrl.isEmpty()) return;
                  if (System.currentTimeMillis() - prefs.getLong(KEY_LAST_UPDATE, 0) < UPDATE_INTERVAL) return;
                  performUpdate(data, cb);
              }

              private void performUpdate(ProfileCrypto.ProfileData data, UpdateCallback cb) {
                  new Thread(() -> {
                      try {
                          HttpURLConnection conn = (HttpURLConnection) new URL(data.updateUrl).openConnection();
                          conn.setConnectTimeout(15000);
                          conn.setReadTimeout(15000);
                          conn.setRequestProperty("User-Agent", "AsadVPN/1.0");
                          if (conn.getResponseCode() != 200) throw new Exception("HTTP " + conn.getResponseCode());
                          BufferedReader r = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                          StringBuilder sb = new StringBuilder();
                          String line;
                          while ((line = r.readLine()) != null) sb.append(line);
                          r.close();
                          conn.disconnect();
                          String enc = sb.toString().trim();
                          if (enc.isEmpty()) throw new Exception("Empty response");
                          ProfileCrypto.ProfileData nd = ProfileCrypto.decryptProfile(enc);
                          nd.expiryTimestamp = data.expiryTimestamp;
                          nd.updateUrl = data.updateUrl;
                          prefs.edit()
                              .putString(KEY_PROFILE, dataToJson(nd))
                              .putLong(KEY_LAST_UPDATE, System.currentTimeMillis())
                              .apply();
                          if (cb != null) cb.onUpdated(nd);
                      } catch (Exception e) {
                          Log.w(TAG, "Update failed", e);
                          if (cb != null) cb.onError(e);
                      }
                  }).start();
              }

              private String dataToJson(ProfileCrypto.ProfileData data) {
                  try {
                      JSONObject obj = new JSONObject();
                      obj.put("id", data.profileId);
                      obj.put("expiry", data.expiryTimestamp);
                      obj.put("updateUrl", data.updateUrl != null ? data.updateUrl : "");
                      if (data.ikeProposal != null) obj.put("ikeProposal", data.ikeProposal);
                      if (data.espProposal != null) obj.put("espProposal", data.espProposal);
                      if (data.mtu != null) obj.put("mtu", data.mtu);
                      if (data.splitTunneling != null) obj.put("splitTunneling", data.splitTunneling);
                      JSONArray servers = new JSONArray();
                      for (ProfileCrypto.ServerInfo si : data.servers) {
                          JSONObject s = new JSONObject();
                          s.put("addr", si.address);
                          s.put("name", si.name);
                          if (si.username != null) s.put("username", si.username);
                          if (si.password != null) s.put("password", si.password);
                          if (si.caCertPem != null) s.put("caCert", si.caCertPem);
                          if (si.remoteId != null) s.put("remoteId", si.remoteId);
                          servers.put(s);
                      }
                      obj.put("servers", servers);
                      return obj.toString();
                  } catch (Exception e) { return "{}"; }
              }

              public interface UpdateCallback {
                  void onUpdated(ProfileCrypto.ProfileData newData);
                  void onError(Exception e);
              }
          }
          JAVA_EOF

          cat > "${JAVA_DIR}/logic/FastServerSelector.java" << 'JAVA_EOF'
          package org.strongswan.android.logic;

          import android.util.Log;
          import java.net.InetAddress;
          import java.util.ArrayList;
          import java.util.List;
          import java.util.concurrent.*;

          public class FastServerSelector {
              private static final String TAG = "AsadVPN.ServerSelect";

              public static ProfileCrypto.ServerInfo findFastest(ProfileCrypto.ServerInfo[] servers) {
                  if (servers == null || servers.length == 0) return null;
                  if (servers.length == 1) return servers[0];
                  int count = Math.min(servers.length, 5);
                  ExecutorService exec = Executors.newFixedThreadPool(count);
                  List<Future<long[]>> futures = new ArrayList<>();
                  for (int i = 0; i < count; i++) {
                      final int idx = i;
                      futures.add(exec.submit(() -> {
                          long start = System.currentTimeMillis();
                          try {
                              InetAddress addr = InetAddress.getByName(servers[idx].address);
                              boolean ok = addr.isReachable(2000);
                              long elapsed = System.currentTimeMillis() - start;
                              Log.d(TAG, servers[idx].address + " reachable=" + ok + " ms=" + elapsed);
                              return new long[]{idx, ok ? elapsed : Long.MAX_VALUE};
                          } catch (Exception e) {
                              return new long[]{idx, Long.MAX_VALUE};
                          }
                      }));
                  }
                  int bestIdx = 0;
                  long bestMs = Long.MAX_VALUE;
                  try {
                      exec.shutdown();
                      exec.awaitTermination(3, TimeUnit.SECONDS);
                      for (Future<long[]> f : futures) {
                          if (f.isDone()) {
                              long[] r = f.get();
                              if (r[1] < bestMs) { bestMs = r[1]; bestIdx = (int) r[0]; }
                          }
                      }
                  } catch (Exception e) { Log.w(TAG, "Select error", e); }
                  if (bestMs == Long.MAX_VALUE) bestIdx = 0;
                  Log.i(TAG, "Selected: " + servers[bestIdx].address);
                  return servers[bestIdx];
              }
          }
          JAVA_EOF

      - name: Create QR Scanner Activity
        run: |
          cd ss-full/src/frontends/android
          cat > "app/src/main/java/org/strongswan/android/ui/QrScannerActivity.java" << 'JAVA_EOF'
          package org.strongswan.android.ui;

          import android.Manifest;
          import android.app.Activity;
          import android.content.Intent;
          import android.content.pm.PackageManager;
          import android.os.Build;
          import android.os.Bundle;
          import android.util.Log;
          import android.util.SparseArray;
          import android.view.SurfaceHolder;
          import android.view.SurfaceView;
          import android.widget.Button;
          import android.widget.Toast;

          import com.google.android.gms.vision.CameraSource;
          import com.google.android.gms.vision.Detector;
          import com.google.android.gms.vision.barcode.Barcode;
          import com.google.android.gms.vision.barcode.BarcodeDetector;

          import org.strongswan.android.R;

          import java.io.IOException;

          public class QrScannerActivity extends Activity {
              private static final String TAG = "AsadVPN.QR";
              private static final int CAMERA_PERM = 1001;
              private CameraSource cameraSource;
              private SurfaceView surfaceView;
              private boolean detected = false;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_qr_scanner);
                  surfaceView = findViewById(R.id.camera_preview);
                  Button cancelBtn = findViewById(R.id.cancel_scan);
                  cancelBtn.setOnClickListener(v -> { setResult(RESULT_CANCELED); finish(); });
                  if (Build.VERSION.SDK_INT >= 23 &&
                      checkSelfPermission(Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) {
                      requestPermissions(new String[]{Manifest.permission.CAMERA}, CAMERA_PERM);
                  } else {
                      setupScanner();
                  }
              }

              @Override
              public void onRequestPermissionsResult(int req, String[] perms, int[] results) {
                  if (req == CAMERA_PERM) {
                      if (results.length > 0 && results[0] == PackageManager.PERMISSION_GRANTED) {
                          setupScanner();
                      } else {
                          Toast.makeText(this, "Camera permission required", Toast.LENGTH_LONG).show();
                          setResult(RESULT_CANCELED);
                          finish();
                      }
                  }
              }

              private void setupScanner() {
                  BarcodeDetector detector = new BarcodeDetector.Builder(this)
                      .setBarcodeFormats(Barcode.QR_CODE).build();
                  if (!detector.isOperational()) {
                      Toast.makeText(this, "QR detector not available. Update Google Play Services.", Toast.LENGTH_LONG).show();
                      setResult(RESULT_CANCELED);
                      finish();
                      return;
                  }
                  cameraSource = new CameraSource.Builder(this, detector)
                      .setAutoFocusEnabled(true).setRequestedPreviewSize(1024, 768).build();
                  surfaceView.getHolder().addCallback(new SurfaceHolder.Callback() {
                      public void surfaceCreated(SurfaceHolder h) { startCamera(); }
                      public void surfaceChanged(SurfaceHolder h, int f, int w, int ht) {}
                      public void surfaceDestroyed(SurfaceHolder h) { if (cameraSource != null) cameraSource.stop(); }
                  });
                  detector.setProcessor(new Detector.Processor<Barcode>() {
                      public void release() {}
                      public void receiveDetections(Detector.Detections<Barcode> d) {
                          SparseArray<Barcode> items = d.getDetectedItems();
                          if (items.size() > 0 && !detected) {
                              detected = true;
                              Intent result = new Intent();
                              result.putExtra("SCAN_RESULT", items.valueAt(0).rawValue);
                              setResult(RESULT_OK, result);
                              finish();
                          }
                      }
                  });
              }

              @SuppressWarnings("MissingPermission")
              private void startCamera() {
                  try {
                      if (cameraSource != null) cameraSource.start(surfaceView.getHolder());
                  } catch (IOException | SecurityException e) {
                      Log.e(TAG, "Camera error", e);
                      Toast.makeText(this, "Camera error", Toast.LENGTH_LONG).show();
                  }
              }

              @Override
              protected void onDestroy() {
                  super.onDestroy();
                  if (cameraSource != null) { cameraSource.stop(); cameraSource.release(); }
              }
          }
          JAVA_EOF

      - name: Create AsadMainActivity
        run: |
          cd ss-full/src/frontends/android
          cat > "app/src/main/java/org/strongswan/android/ui/AsadMainActivity.java" << 'JAVAEOF'
          package org.strongswan.android.ui;

          import android.app.Activity;
          import android.app.AlertDialog;
          import android.content.ComponentName;
          import android.content.Intent;
          import android.content.ServiceConnection;
          import android.net.Uri;
          import android.net.VpnService;
          import android.os.Bundle;
          import android.os.IBinder;
          import android.util.Log;
          import android.view.View;
          import android.widget.Button;
          import android.widget.EditText;
          import android.widget.TextView;
          import android.widget.Toast;

          import org.strongswan.android.R;
          import org.strongswan.android.data.VpnProfile;
          import org.strongswan.android.data.VpnProfileDataSource;
          import org.strongswan.android.data.VpnProfileSqlDataSource;
          import org.strongswan.android.data.VpnType;
          import org.strongswan.android.logic.CertificateImporter;
          import org.strongswan.android.logic.FastServerSelector;
          import org.strongswan.android.logic.ProfileCrypto;
          import org.strongswan.android.logic.ProfileManager;
          import org.strongswan.android.logic.VpnStateService;
          import org.strongswan.android.logic.VpnStateService.State;

          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.List;
          import java.util.Locale;

          public class AsadMainActivity extends Activity implements VpnStateService.VpnStateListener {
              private static final String TAG = "AsadVPN";
              private static final int VPN_REQ = 100;
              private static final int QR_REQ = 200;
              private Button connectBtn, importBtn, scanBtn;
              private TextView statusTv, serverTv, daysTv, updateTv;
              private ProfileManager pm;
              private ProfileCrypto.ProfileData profile;
              private ProfileCrypto.ServerInfo pendingServer;
              private VpnStateService svc;
              private String pendingUuid;
              private boolean updatedThisSession = false;

              private final ServiceConnection svcConn = new ServiceConnection() {
                  @Override
                  public void onServiceConnected(ComponentName name, IBinder binder) {
                      svc = ((VpnStateService.LocalBinder) binder).getService();
                      svc.registerListener(AsadMainActivity.this);
                      refreshUI();
                  }
                  @Override
                  public void onServiceDisconnected(ComponentName name) { svc = null; }
              };

              @Override
              protected void onCreate(Bundle si) {
                  super.onCreate(si);
                  setContentView(R.layout.activity_asadvpn_main);
                  connectBtn = findViewById(R.id.connect_button);
                  importBtn = findViewById(R.id.import_button);
                  scanBtn = findViewById(R.id.scan_button);
                  statusTv = findViewById(R.id.status_text);
                  serverTv = findViewById(R.id.server_text);
                  daysTv = findViewById(R.id.days_text);
                  updateTv = findViewById(R.id.update_text);
                  pm = new ProfileManager(this);
                  connectBtn.setOnClickListener(v -> onConnect());
                  importBtn.setOnClickListener(v -> showImport());
                  scanBtn.setOnClickListener(v -> launchQrScanner());
                  importBtn.setOnLongClickListener(v -> { forceUpdate(); return true; });
                  bindService(new Intent(this, VpnStateService.class), svcConn, BIND_AUTO_CREATE);
                  doUpdate();
              }

              @Override
              protected void onDestroy() {
                  super.onDestroy();
                  if (svc != null) svc.unregisterListener(this);
                  try { unbindService(svcConn); } catch (Exception ignored) {}
              }

              @Override
              protected void onResume() { super.onResume(); refreshUI(); }

              @Override
              public void stateChanged() {
                  runOnUiThread(() -> {
                      refreshUI();
                      if (svc != null && svc.getState() == State.CONNECTED && !updatedThisSession) {
                          updatedThisSession = true;
                          doUpdate();
                      }
                  });
              }

              private void doUpdate() {
                  pm.checkForUpdates(new ProfileManager.UpdateCallback() {
                      public void onUpdated(ProfileCrypto.ProfileData d) {
                          runOnUiThread(() -> {
                              profile = d;
                              refreshUI();
                              Toast.makeText(AsadMainActivity.this, "Profile updated!", Toast.LENGTH_SHORT).show();
                          });
                      }
                      public void onError(Exception e) {
                          Log.w(TAG, "Update: " + e.getMessage());
                      }
                  });
              }

              private void refreshUI() {
                  profile = pm.getActiveProfile();
                  long lu = pm.getLastUpdateTime();
                  updateTv.setText(lu > 0
                      ? "Last sync: " + new SimpleDateFormat("MMM dd, HH:mm", Locale.getDefault()).format(new Date(lu))
                      : "");

                  if (profile == null) {
                      statusTv.setText("No Profile");
                      daysTv.setText("Import a profile to get started");
                      serverTv.setText("");
                      connectBtn.setText("IMPORT");
                      connectBtn.setEnabled(true);
                      connectBtn.setBackgroundResource(R.drawable.circle_button_connect);
                      return;
                  }
                  if (profile.isExpired()) {
                      statusTv.setText("Profile Expired");
                      daysTv.setText("0 days remaining");
                      serverTv.setText("");
                      connectBtn.setText("EXPIRED");
                      connectBtn.setEnabled(false);
                      connectBtn.setBackgroundResource(R.drawable.circle_button_connect);
                      return;
                  }

                  int d = profile.remainingDays();
                  daysTv.setText(d + " day" + (d != 1 ? "s" : "") + " remaining");

                  State st = svc != null ? svc.getState() : State.DISABLED;
                  switch (st) {
                      case CONNECTED:
                          statusTv.setText("Connected");
                          serverTv.setText("\uD83D\uDD12 Secure");
                          connectBtn.setText("DISCONNECT");
                          connectBtn.setBackgroundResource(R.drawable.circle_button_disconnect);
                          connectBtn.setEnabled(true);
                          break;
                      case CONNECTING:
                          statusTv.setText("Connecting...");
                          serverTv.setText("");
                          connectBtn.setText("CANCEL");
                          connectBtn.setEnabled(true);
                          break;
                      case DISCONNECTING:
                          statusTv.setText("Disconnecting...");
                          serverTv.setText("");
                          connectBtn.setText("WAIT");
                          connectBtn.setEnabled(false);
                          break;
                      default:
                          statusTv.setText("Disconnected");
                          serverTv.setText("Ready");
                          connectBtn.setText("CONNECT");
                          connectBtn.setBackgroundResource(R.drawable.circle_button_connect);
                          connectBtn.setEnabled(true);
                          break;
                  }
              }

              private void onConnect() {
                  if (profile == null) { showImport(); return; }
                  if (profile.isExpired()) { showExpired(); return; }

                  State st = svc != null ? svc.getState() : State.DISABLED;
                  if (st == State.CONNECTED || st == State.CONNECTING) {
                      if (svc != null) svc.disconnect();
                      return;
                  }

                  statusTv.setText("Selecting server...");
                  connectBtn.setEnabled(false);
                  new Thread(() -> {
                      ProfileCrypto.ServerInfo best = FastServerSelector.findFastest(profile.servers);
                      if (best == null) {
                          runOnUiThread(() -> {
                              refreshUI();
                              Toast.makeText(this, "No servers available", Toast.LENGTH_SHORT).show();
                          });
                          return;
                      }
                      runOnUiThread(() -> startVpn(best));
                  }).start();
              }

              private void startVpn(ProfileCrypto.ServerInfo server) {
                  try {
                      /* Import CA certificate if provided */
                      String certAlias = null;
                      if (server.hasCaCert()) {
                          certAlias = CertificateImporter.importCaCertificate(this, server.caCertPem);
                          Log.i(TAG, "Cert import result: " + certAlias);
                      }

                      /* VpnProfileSqlDataSource() uses no-arg constructor,
                       * gets DB via StrongSwanApplication.getInstance().getDatabaseHelper() */
                      VpnProfileSqlDataSource ds = new VpnProfileSqlDataSource();
                      ds.open();

                      /* Clean old AsadVPN profiles to avoid accumulation */
                      try {
                          List<VpnProfile> all = ds.getAllVpnProfiles();
                          for (VpnProfile p : all) {
                              if (p.getName() != null && p.getName().startsWith("AsadVPN")) {
                                  ds.deleteVpnProfile(p);
                                  Log.d(TAG, "Cleaned old profile: " + p.getName());
                              }
                          }
                      } catch (Exception e) {
                          Log.w(TAG, "Clean profiles: " + e.getMessage());
                      }

                      /* Create the VPN profile */
                      VpnProfile vp = new VpnProfile();
                      vp.setName("AsadVPN - " + server.name);
                      vp.setGateway(server.address);
                      vp.setUsername(server.username);
                      vp.setPassword(server.password);
                      vp.setVpnType(VpnType.IKEV2_EAP);

                      if (certAlias != null) {
                          vp.setCertificateAlias(certAlias);
                      }
                      if (server.remoteId != null && !server.remoteId.isEmpty()) {
                          vp.setRemoteId(server.remoteId);
                      }
                      if (profile.ikeProposal != null && !profile.ikeProposal.isEmpty()) {
                          vp.setIkeProposal(profile.ikeProposal);
                      }
                      if (profile.espProposal != null && !profile.espProposal.isEmpty()) {
                          vp.setEspProposal(profile.espProposal);
                      }
                      if (profile.mtu != null && profile.mtu > 0) {
                          vp.setMTU(profile.mtu);
                      }
                      if (profile.splitTunneling != null) {
                          vp.setSplitTunneling(profile.splitTunneling);
                      }

                      VpnProfile saved = ds.insertProfile(vp);
                      ds.close();

                      if (saved == null) {
                          Toast.makeText(this, "Failed to save VPN profile", Toast.LENGTH_LONG).show();
                          refreshUI();
                          return;
                      }

                      Log.i(TAG, "Profile saved: uuid=" + saved.getUUID()
                          + " gw=" + saved.getGateway()
                          + " user=" + saved.getUsername()
                          + " type=" + saved.getVpnType().getIdentifier());

                      pendingUuid = saved.getUUID().toString();
                      pendingServer = server;

                      /* Request VPN permission if needed */
                      Intent intent = VpnService.prepare(this);
                      if (intent != null) {
                          startActivityForResult(intent, VPN_REQ);
                      } else {
                          launchVpn();
                      }
                  } catch (Exception e) {
                      Log.e(TAG, "VPN setup error", e);
                      Toast.makeText(this, "Failed: " + e.getMessage(), Toast.LENGTH_LONG).show();
                      refreshUI();
                  }
              }

              private void launchVpn() {
                  if (pendingUuid == null || svc == null) {
                      Log.e(TAG, "Cannot launch: uuid=" + pendingUuid + " svc=" + svc);
                      refreshUI();
                      return;
                  }
                  Log.i(TAG, "Launching VPN: uuid=" + pendingUuid);

                  /* Bundle with KEY_UUID and KEY_PASSWORD as expected by
                   * VpnStateService.connect() -> CharonVpnService */
                  Bundle profileInfo = new Bundle();
                  profileInfo.putString(VpnProfileDataSource.KEY_UUID, pendingUuid);
                  profileInfo.putString(VpnProfileDataSource.KEY_PASSWORD, pendingServer.password);
                  svc.connect(profileInfo, true);
              }

              @Override
              protected void onActivityResult(int req, int res, Intent data) {
                  super.onActivityResult(req, res, data);
                  if (req == VPN_REQ) {
                      if (res == RESULT_OK) {
                          launchVpn();
                      } else {
                          Toast.makeText(this, "VPN permission required", Toast.LENGTH_SHORT).show();
                          refreshUI();
                      }
                  } else if (req == QR_REQ && res == RESULT_OK && data != null) {
                      String s = data.getStringExtra("SCAN_RESULT");
                      if (s != null && !s.isEmpty()) doImport(s);
                  }
              }

              private void forceUpdate() {
                  if (profile == null) {
                      Toast.makeText(this, "Import a profile first", Toast.LENGTH_SHORT).show();
                      return;
                  }
                  if (profile.updateUrl == null || profile.updateUrl.isEmpty()) {
                      Toast.makeText(this, "No update URL configured", Toast.LENGTH_SHORT).show();
                      return;
                  }
                  Toast.makeText(this, "Checking for updates...", Toast.LENGTH_SHORT).show();
                  pm.forceUpdate(new ProfileManager.UpdateCallback() {
                      public void onUpdated(ProfileCrypto.ProfileData d) {
                          runOnUiThread(() -> {
                              profile = d;
                              refreshUI();
                              Toast.makeText(AsadMainActivity.this, "Updated!", Toast.LENGTH_SHORT).show();
                          });
                      }
                      public void onError(Exception e) {
                          runOnUiThread(() ->
                              Toast.makeText(AsadMainActivity.this, "Failed: " + e.getMessage(), Toast.LENGTH_LONG).show());
                      }
                  });
              }

              private void showImport() {
                  View v = getLayoutInflater().inflate(R.layout.dialog_import_profile, null);
                  EditText input = v.findViewById(R.id.profile_input);
                  new AlertDialog.Builder(this)
                      .setTitle("Import Profile")
                      .setView(v)
                      .setPositiveButton("Import", (d, w) -> {
                          String t = input.getText().toString().trim();
                          if (!t.isEmpty()) doImport(t);
                      })
                      .setNegativeButton("Cancel", null)
                      .show();
              }

              private void doImport(String enc) {
                  try {
                      profile = pm.importProfile(enc);
                      if (profile.isExpired()) { showExpired(); return; }
                      Toast.makeText(this, "Imported! " + profile.remainingDays() + " days remaining",
                          Toast.LENGTH_LONG).show();
                      refreshUI();
                  } catch (Exception e) {
                      Log.e(TAG, "Import fail", e);
                      Toast.makeText(this, "Invalid profile: " + e.getMessage(), Toast.LENGTH_LONG).show();
                  }
              }

              private void launchQrScanner() {
                  try {
                      startActivityForResult(new Intent(this, QrScannerActivity.class), QR_REQ);
                  } catch (Exception e) {
                      Toast.makeText(this, "QR scanner not available. Use paste instead.", Toast.LENGTH_LONG).show();
                  }
              }

              private void showExpired() {
                  new AlertDialog.Builder(this)
                      .setTitle("Subscription Expired")
                      .setMessage("Your VPN subscription has expired. Contact support to renew.")
                      .setPositiveButton("Support", (d, w) ->
                          startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse("https://t.me/vpnproxytestsupport"))))
                      .setNegativeButton("Close", null)
                      .setCancelable(false)
                      .show();
              }
          }
          JAVAEOF

      - name: Patch AndroidManifest
        run: |
          cd ss-full/src/frontends/android
          python3 << 'PYEOF'
          with open("app/src/main/AndroidManifest.xml", "r") as f:
              content = f.read()

          content = content.replace(
              '<category android:name="android.intent.category.LAUNCHER" />',
              '<!-- launcher moved to AsadMainActivity -->')

          if 'android.permission.CAMERA' not in content:
              content = content.replace(
                  '<application',
                  '<uses-permission android:name="android.permission.CAMERA" />\n    <uses-feature android:name="android.hardware.camera" android:required="false" />\n\n    <application')

          content = content.replace('</application>', '''
                  <activity android:name=".ui.AsadMainActivity"
                      android:label="AsadVPN" android:exported="true"
                      android:theme="@style/ApplicationTheme">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <activity android:name=".ui.QrScannerActivity"
                      android:label="Scan QR" android:exported="false"
                      android:theme="@style/ApplicationTheme"
                      android:screenOrientation="portrait" />
                  <meta-data android:name="com.google.android.gms.vision.DEPENDENCIES"
                      android:value="barcode" />
              </application>''')

          with open("app/src/main/AndroidManifest.xml", "w") as f:
              f.write(content)
          PYEOF

      - name: Add play-services-vision dependency
        run: |
          cd ss-full/src/frontends/android
          python3 << 'PYEOF'
          with open("app/build.gradle", "r") as f:
              content = f.read()
          if 'play-services-vision' not in content:
              content = content.replace(
                  'dependencies {',
                  "dependencies {\n    implementation 'com.google.android.gms:play-services-vision:20.1.3'")
          with open("app/build.gradle", "w") as f:
              f.write(content)
          PYEOF

      - name: Pre-build validation
        run: |
          cd ss-full/src/frontends/android
          echo "=== Verify key compilation points ==="
          echo "--- applicationId ---"
          grep "applicationId" app/build.gradle
          echo "--- LAUNCHER count (should be 1) ---"
          grep -c "android.intent.category.LAUNCHER" app/src/main/AndroidManifest.xml
          echo "--- play-services-vision ---"
          grep "play-services-vision" app/build.gradle
          echo "--- AsadMainActivity imports VpnProfileSqlDataSource ---"
          grep "VpnProfileSqlDataSource" app/src/main/java/org/strongswan/android/ui/AsadMainActivity.java
          echo "--- DataSource instantiation (should be no-arg) ---"
          grep "new VpnProfileSqlDataSource" app/src/main/java/org/strongswan/android/ui/AsadMainActivity.java
          echo "--- Bundle keys ---"
          grep "KEY_UUID\|KEY_PASSWORD" app/src/main/java/org/strongswan/android/ui/AsadMainActivity.java
          echo "--- Custom files exist ---"
          for f in \
            app/src/main/java/org/strongswan/android/logic/ProfileCrypto.java \
            app/src/main/java/org/strongswan/android/logic/CertificateImporter.java \
            app/src/main/java/org/strongswan/android/logic/ProfileManager.java \
            app/src/main/java/org/strongswan/android/logic/FastServerSelector.java \
            app/src/main/java/org/strongswan/android/ui/AsadMainActivity.java \
            app/src/main/java/org/strongswan/android/ui/QrScannerActivity.java \
            app/src/main/res/layout/activity_asadvpn_main.xml \
            app/src/main/res/layout/activity_qr_scanner.xml \
            app/src/main/res/layout/dialog_import_profile.xml \
            app/src/main/res/drawable/circle_button_connect.xml \
            app/src/main/res/drawable/circle_button_disconnect.xml \
            app/src/main/res/drawable/qr_frame.xml; do
            if [ -f "$f" ]; then echo "OK: $f"; else echo "MISSING: $f"; exit 1; fi
          done

      - name: Build APK
        run: |
          cd ss-full/src/frontends/android
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          sed -i "s|arguments '-j'|arguments 'APP_ALLOW_MISSING_DEPS=true', '-j'|" app/build.gradle
          set +e
          ./gradlew assembleDebug --no-daemon --stacktrace 2>&1 | tee "${GITHUB_WORKSPACE}/build.log"
          RESULT=${PIPESTATUS[0]}
          set -e
          if [ ${RESULT} -ne 0 ]; then
            echo "========================================"
            echo "BUILD FAILED - Error analysis"
            echo "========================================"
            grep -E "error:" "${GITHUB_WORKSPACE}/build.log" | grep -v "Exception\|ProcessException\|CXX1429\|error when building\|IssueReporter\|TaskExecution\|EventFiring\|DefaultBuild" | head -30
            grep -B2 -A2 "cannot find symbol\|incompatible types\|method.*not found\|is abstract\|does not exist" "${GITHUB_WORKSPACE}/build.log" | head -40
            exit 1
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: asadvpn-debug-apk
          path: ss-full/src/frontends/android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: error

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
