name: Rebuild From Scratch

on:
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete everything except workflows
      run: |
        find . -maxdepth 1 -not -name '.github' -not -name '.' -not -name '.git' -exec rm -rf {} \;
        find .github/workflows -not -name 'rebuild.yml' -type f -delete

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install NDK and build tools
      run: |
        yes | sdkmanager "ndk;25.2.9519653" "cmake;3.22.1" 2>/dev/null || true
        sudo apt-get update
        sudo apt-get install -y bison flex gperf python3

    - name: Clone strongSwan
      run: |
        git clone --depth 1 --branch 5.9.11 https://github.com/strongswan/strongswan.git /tmp/strongswan

    - name: Download and build OpenSSL for Android
      run: |
        cd /tmp
        wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
        tar xzf openssl-1.1.1w.tar.gz
        
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653
        export PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        
        # Build for arm64
        cd /tmp/openssl-1.1.1w
        make clean 2>/dev/null || true
        ./Configure android-arm64 -D__ANDROID_API__=21 --prefix=/tmp/openssl-arm64 no-shared no-tests
        make -j$(nproc) 2>&1 | tail -5
        make install_sw 2>&1 | tail -5
        
        # Build for armv7
        make clean 2>/dev/null || true
        ./Configure android-arm -D__ANDROID_API__=21 --prefix=/tmp/openssl-arm no-shared no-tests
        make -j$(nproc) 2>&1 | tail -5
        make install_sw 2>&1 | tail -5
        
        echo "OpenSSL build complete"

    - name: Build strongSwan native libraries
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653
        
        SS=/tmp/strongswan/src/frontends/android/app/src/main/jni
        
        # Create OpenSSL Android.mk for arm64
        mkdir -p $SS/openssl/arm64-v8a
        cat > $SS/openssl/arm64-v8a/Android.mk << 'MKEOF'
        LOCAL_PATH := $(call my-dir)
        
        include $(CLEAR_VARS)
        LOCAL_MODULE := libcrypto_static
        LOCAL_SRC_FILES := /tmp/openssl-arm64/lib/libcrypto.a
        LOCAL_EXPORT_C_INCLUDES := /tmp/openssl-arm64/include
        include $(PREBUILT_STATIC_LIBRARY)
        
        include $(CLEAR_VARS)
        LOCAL_MODULE := libssl_static
        LOCAL_SRC_FILES := /tmp/openssl-arm64/lib/libssl.a
        LOCAL_EXPORT_C_INCLUDES := /tmp/openssl-arm64/include
        include $(PREBUILT_STATIC_LIBRARY)
        MKEOF
        
        # Create OpenSSL Android.mk for armeabi-v7a
        mkdir -p $SS/openssl/armeabi-v7a
        cat > $SS/openssl/armeabi-v7a/Android.mk << 'MKEOF'
        LOCAL_PATH := $(call my-dir)
        
        include $(CLEAR_VARS)
        LOCAL_MODULE := libcrypto_static
        LOCAL_SRC_FILES := /tmp/openssl-arm/lib/libcrypto.a
        LOCAL_EXPORT_C_INCLUDES := /tmp/openssl-arm/include
        include $(PREBUILT_STATIC_LIBRARY)
        
        include $(CLEAR_VARS)
        LOCAL_MODULE := libssl_static
        LOCAL_SRC_FILES := /tmp/openssl-arm/lib/libssl.a
        LOCAL_EXPORT_C_INCLUDES := /tmp/openssl-arm/include
        include $(PREBUILT_STATIC_LIBRARY)
        MKEOF
        
        # Create the top-level openssl Android.mk
        cat > $SS/openssl/Android.mk << 'MKEOF'
        LOCAL_PATH := $(call my-dir)
        include $(LOCAL_PATH)/$(TARGET_ARCH_ABI)/Android.mk
        MKEOF
        
        # Build native libraries
        cd $SS
        $ANDROID_NDK_ROOT/ndk-build APP_ABI="arm64-v8a armeabi-v7a" -j$(nproc) 2>&1 | tail -30
        
        echo "=== Built libraries ==="
        find /tmp/strongswan/src/frontends/android/app/src/main/libs -name "*.so" 2>/dev/null || echo "Check obj dir"
        find /tmp/strongswan/src/frontends/android/app/src/main/obj -name "*.so" 2>/dev/null || echo "No .so in obj"

    - name: Create project structure
      run: |
        mkdir -p .github/workflows
        mkdir -p app/src/main/java/com/ikev2client
        mkdir -p app/src/main/java/org/strongswan/android/data
        mkdir -p app/src/main/java/org/strongswan/android/logic
        mkdir -p app/src/main/java/org/strongswan/android/logic/imc
        mkdir -p app/src/main/java/org/strongswan/android/security
        mkdir -p app/src/main/java/org/strongswan/android/utils
        mkdir -p app/src/main/aidl/org/strongswan/android/logic
        mkdir -p app/src/main/jniLibs/arm64-v8a
        mkdir -p app/src/main/jniLibs/armeabi-v7a
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/drawable
        mkdir -p gradle/wrapper

    - name: Copy strongSwan libraries
      run: |
        SS_LIBS=/tmp/strongswan/src/frontends/android/app/src/main/libs
        
        cp $SS_LIBS/arm64-v8a/*.so app/src/main/jniLibs/arm64-v8a/ 2>/dev/null || true
        cp $SS_LIBS/armeabi-v7a/*.so app/src/main/jniLibs/armeabi-v7a/ 2>/dev/null || true
        
        echo "=== Copied arm64 ==="
        ls -la app/src/main/jniLibs/arm64-v8a/ 2>/dev/null
        echo "=== Copied armv7 ==="
        ls -la app/src/main/jniLibs/armeabi-v7a/ 2>/dev/null

    - name: Copy strongSwan Java sources
      run: |
        SS_JAVA=/tmp/strongswan/src/frontends/android/app/src/main/java/org/strongswan/android
        SS_AIDL=/tmp/strongswan/src/frontends/android/app/src/main/aidl
        
        # Copy Java files we need
        cp -r $SS_JAVA/data/* app/src/main/java/org/strongswan/android/data/ 2>/dev/null || true
        cp -r $SS_JAVA/logic/*.java app/src/main/java/org/strongswan/android/logic/ 2>/dev/null || true
        cp -r $SS_JAVA/logic/imc/* app/src/main/java/org/strongswan/android/logic/imc/ 2>/dev/null || true
        cp -r $SS_JAVA/security/* app/src/main/java/org/strongswan/android/security/ 2>/dev/null || true
        cp -r $SS_JAVA/utils/* app/src/main/java/org/strongswan/android/utils/ 2>/dev/null || true
        
        # Copy AIDL files
        cp -r $SS_AIDL/* app/src/main/aidl/ 2>/dev/null || true
        
        echo "=== Java files ==="
        find app/src/main/java/org/strongswan -name "*.java" | head -30
        echo "=== AIDL files ==="
        find app/src/main/aidl -name "*.aidl" 2>/dev/null

    - name: Create build files
      run: |
        # settings.gradle
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "IKEv2 Client"
        include ':app'
        EOF
        
        # root build.gradle
        cat > build.gradle << 'EOF'
        plugins {
            id 'com.android.application' version '8.2.2' apply false
        }
        EOF
        
        # gradle.properties
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx4096m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.enableJetifier=true
        EOF
        
        # gradle wrapper properties
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
        networkTimeout=10000
        validateDistributionUrl=true
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # app/build.gradle
        cat > app/build.gradle << 'APPEOF'
        plugins {
            id 'com.android.application'
        }
        
        android {
            namespace 'com.ikev2client'
            compileSdk 34
        
            defaultConfig {
                applicationId "com.ikev2client"
                minSdk 21
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }
        
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
        
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }
        
            sourceSets {
                main {
                    jniLibs.srcDirs = ['src/main/jniLibs']
                }
            }
        
            lint {
                abortOnError false
                checkReleaseBuilds false
            }
        
            packagingOptions {
                jniLibs {
                    useLegacyPackaging true
                }
            }
        }
        
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.11.0'
            implementation 'com.google.code.gson:gson:2.10.1'
        }
        APPEOF

    - name: Create AndroidManifest.xml
      run: |
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
        
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
        
            <application
                android:allowBackup="true"
                android:icon="@drawable/ic_launcher"
                android:label="@string/app_name"
                android:theme="@style/Theme.AppCompat.Light.DarkActionBar">
        
                <activity
                    android:name="com.ikev2client.MainActivity"
                    android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
        
                <service
                    android:name="com.ikev2client.IKEv2VpnService"
                    android:permission="android.permission.BIND_VPN_SERVICE"
                    android:exported="false">
                    <intent-filter>
                        <action android:name="android.net.VpnService" />
                    </intent-filter>
                </service>
        
            </application>
        </manifest>
        EOF

    - name: Create resources
      run: |
        # strings.xml
        cat > app/src/main/res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">IKEv2 Client</string>
        </resources>
        EOF
        
        # ic_launcher.xml
        cat > app/src/main/res/drawable/ic_launcher.xml << 'EOF'
        <vector xmlns:android="http://schemas.android.com/apk/res/android"
            android:width="108dp"
            android:height="108dp"
            android:viewportWidth="108"
            android:viewportHeight="108">
            <path
                android:fillColor="#4CAF50"
                android:pathData="M0,0h108v108h-108z" />
            <path
                android:fillColor="#00000000"
                android:pathData="M54,30L54,78M30,54L78,54"
                android:strokeWidth="8"
                android:strokeColor="#FFFFFF"
                android:strokeLineCap="round" />
        </vector>
        EOF
        
        # activity_main.xml
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:orientation="vertical"
            android:padding="16dp"
            android:background="#F5F5F5">
        
            <TextView
                android:id="@+id/statusText"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="Status: DISCONNECTED"
                android:textSize="18sp"
                android:textStyle="bold"
                android:gravity="center"
                android:padding="16dp"
                android:background="#FFFFFF"
                android:textColor="#757575" />
        
            <Button
                android:id="@+id/disconnectButton"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="Disconnect"
                android:textAllCaps="false"
                android:visibility="gone"
                android:layout_marginTop="8dp" />
        
            <Button
                android:id="@+id/importButton"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="Import .ikev2 File"
                android:textAllCaps="false"
                android:layout_marginTop="16dp" />
        
            <Button
                android:id="@+id/clipboardButton"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="Import from Clipboard"
                android:textAllCaps="false"
                android:layout_marginTop="8dp" />
        
            <ListView
                android:id="@+id/profileList"
                android:layout_width="match_parent"
                android:layout_height="0dp"
                android:layout_weight="1"
                android:layout_marginTop="16dp"
                android:divider="#E0E0E0"
                android:dividerHeight="1dp"
                android:background="#FFFFFF" />
        
        </LinearLayout>
        EOF

    - name: Create Crypto.java
      run: |
        cat > app/src/main/java/com/ikev2client/Crypto.java << 'EOF'
        package com.ikev2client;
        
        import android.util.Base64;
        import javax.crypto.Cipher;
        import javax.crypto.spec.IvParameterSpec;
        import javax.crypto.spec.SecretKeySpec;
        import java.security.MessageDigest;
        import java.util.Arrays;
        
        public class Crypto {
            private static final String MASTER_KEY = "IKEv2SecureProfileKey2025";
        
            public static String encrypt(String plainText) throws Exception {
                byte[] key = deriveKey(MASTER_KEY);
                byte[] iv = new byte[16];
                Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
                cipher.init(Cipher.ENCRYPT_MODE, new SecretKeySpec(key, "AES"), new IvParameterSpec(iv));
                byte[] encrypted = cipher.doFinal(plainText.getBytes("UTF-8"));
                return Base64.encodeToString(encrypted, Base64.NO_WRAP);
            }
        
            public static String decrypt(String encryptedText) throws Exception {
                byte[] key = deriveKey(MASTER_KEY);
                byte[] iv = new byte[16];
                Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
                cipher.init(Cipher.DECRYPT_MODE, new SecretKeySpec(key, "AES"), new IvParameterSpec(iv));
                byte[] decoded = Base64.decode(encryptedText.trim(), Base64.DEFAULT);
                byte[] decrypted = cipher.doFinal(decoded);
                return new String(decrypted, "UTF-8");
            }
        
            private static byte[] deriveKey(String password) throws Exception {
                MessageDigest sha = MessageDigest.getInstance("SHA-256");
                byte[] fullHash = sha.digest(password.getBytes("UTF-8"));
                return Arrays.copyOf(fullHash, 16);
            }
        }
        EOF

    - name: Create ProfileManager.java
      run: |
        cat > app/src/main/java/com/ikev2client/ProfileManager.java << 'EOF'
        package com.ikev2client;
        
        import android.content.Context;
        import com.google.gson.Gson;
        import com.google.gson.annotations.SerializedName;
        import java.io.*;
        import java.text.SimpleDateFormat;
        import java.util.*;
        
        public class ProfileManager {
            public static class Profile {
                @SerializedName("name") public String name;
                @SerializedName("server") public String server;
                @SerializedName("username") public String username;
                @SerializedName("password") public String password;
                @SerializedName("ca_cert") public String caCert;
                @SerializedName("ike_proposal") public String ikeProposal;
                @SerializedName("esp_proposal") public String espProposal;
                @SerializedName("dns") public String dns;
                @SerializedName("expire_datetime") public String expireDatetime;
        
                public boolean isExpired() {
                    try {
                        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm", Locale.US);
                        Date expiry = sdf.parse(expireDatetime);
                        return new Date().after(expiry);
                    } catch (Exception e) { return true; }
                }
        
                public String timeRemaining() {
                    try {
                        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm", Locale.US);
                        Date expiry = sdf.parse(expireDatetime);
                        long diff = expiry.getTime() - System.currentTimeMillis();
                        if (diff < 0) return "Expired";
                        long d = diff / 86400000;
                        long h = (diff / 3600000) % 24;
                        long m = (diff / 60000) % 60;
                        if (d > 0) return d + "d " + h + "h";
                        if (h > 0) return h + "h " + m + "m";
                        return m + "m";
                    } catch (Exception e) { return "Unknown"; }
                }
            }
        
            public static Profile loadFromEncryptedString(String encrypted) throws Exception {
                String json = Crypto.decrypt(encrypted);
                return new Gson().fromJson(json, Profile.class);
            }
        
            public static Profile loadFromFile(File file) throws Exception {
                BufferedReader r = new BufferedReader(new FileReader(file));
                StringBuilder sb = new StringBuilder();
                String line;
                while ((line = r.readLine()) != null) sb.append(line);
                r.close();
                return loadFromEncryptedString(sb.toString());
            }
        
            public static void saveToFile(Profile profile, File file) throws Exception {
                String json = new Gson().toJson(profile);
                String encrypted = Crypto.encrypt(json);
                FileWriter w = new FileWriter(file);
                w.write(encrypted);
                w.close();
            }
        
            public static List<Profile> loadAllProfiles(Context ctx) {
                List<Profile> list = new ArrayList<>();
                File dir = new File(ctx.getFilesDir(), "profiles");
                if (!dir.exists()) dir.mkdirs();
                File[] files = dir.listFiles();
                if (files != null) {
                    for (File f : files) {
                        if (f.getName().endsWith(".ikev2")) {
                            try { list.add(loadFromFile(f)); }
                            catch (Exception e) { e.printStackTrace(); }
                        }
                    }
                }
                return list;
            }
        }
        EOF

    - name: Create IKEv2VpnService.java
      run: |
        cat > app/src/main/java/com/ikev2client/IKEv2VpnService.java << 'JAVAEOF'
        package com.ikev2client;
        
        import android.app.Notification;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.Intent;
        import android.net.VpnService;
        import android.os.Build;
        import android.os.Bundle;
        import android.os.Handler;
        import android.os.Looper;
        import android.os.ParcelFileDescriptor;
        import android.util.Log;
        import java.io.*;
        import java.security.KeyStore;
        import java.security.cert.CertificateFactory;
        import java.security.cert.X509Certificate;
        import org.strongswan.android.logic.CharonVpnService;
        
        public class IKEv2VpnService extends CharonVpnService {
        
            private static final String TAG = "IKEv2VPN";
            private static final String CHANNEL_ID = "ikev2_vpn";
            private static final int NOTIF_ID = 1;
        
            public static final String ACTION_CONNECT = "CONNECT";
            public static final String ACTION_DISCONNECT = "DISCONNECT";
            public static final String EXTRA_SERVER = "server";
            public static final String EXTRA_USERNAME = "username";
            public static final String EXTRA_PASSWORD = "password";
            public static final String EXTRA_CA_CERT = "ca_cert";
            public static final String EXTRA_PROFILE_NAME = "profile_name";
            public static final String EXTRA_DNS = "dns";
            public static final String EXTRA_IKE_PROPOSAL = "ike_proposal";
            public static final String EXTRA_ESP_PROPOSAL = "esp_proposal";
        
            private static String currentState = "DISCONNECTED";
            private static StateListener stateListener;
        
            public interface StateListener {
                void onStateChanged(String state);
            }
        
            public static void setStateListener(StateListener listener) {
                stateListener = listener;
            }
        
            public static String getCurrentState() {
                return currentState;
            }
        
            private void setState(String state) {
                currentState = state;
                if (stateListener != null) {
                    new Handler(Looper.getMainLooper()).post(() -> {
                        if (stateListener != null) stateListener.onStateChanged(state);
                    });
                }
            }
        
            @Override
            public void onCreate() {
                super.onCreate();
                createNotificationChannel();
            }
        
            @Override
            public int onStartCommand(Intent intent, int flags, int startId) {
                if (intent != null && ACTION_DISCONNECT.equals(intent.getAction())) {
                    setState("DISCONNECTING");
                    stopCurrentConnection();
                    setState("DISCONNECTED");
                    stopForeground(true);
                    stopSelf();
                    return START_NOT_STICKY;
                }
        
                if (intent != null && ACTION_CONNECT.equals(intent.getAction())) {
                    String server = intent.getStringExtra(EXTRA_SERVER);
                    String username = intent.getStringExtra(EXTRA_USERNAME);
                    String password = intent.getStringExtra(EXTRA_PASSWORD);
                    String caCert = intent.getStringExtra(EXTRA_CA_CERT);
                    String name = intent.getStringExtra(EXTRA_PROFILE_NAME);
                    String dns = intent.getStringExtra(EXTRA_DNS);
                    String ikeProposal = intent.getStringExtra(EXTRA_IKE_PROPOSAL);
                    String espProposal = intent.getStringExtra(EXTRA_ESP_PROPOSAL);
        
                    setState("CONNECTING");
                    showNotification("Connecting to " + name + "...");
        
                    try {
                        saveCaCert(caCert);
                        
                        Bundle profileData = new Bundle();
                        profileData.putString("gateway", server);
                        profileData.putString("username", username);
                        profileData.putString("password", password);
                        profileData.putString("ike_proposal", ikeProposal != null ? ikeProposal : "aes256-sha512-modp4096");
                        profileData.putString("esp_proposal", espProposal != null ? espProposal : "aes256-sha512");
                        profileData.putInt("vpn_type", 2); // EAP
                        profileData.putString("name", name);
                        
                        initializeCharon(profileData);
                        
                        setState("CONNECTED");
                        showNotification("Connected to " + name);
                        
                    } catch (Exception e) {
                        Log.e(TAG, "Connection error", e);
                        setState("ERROR");
                        showNotification("Error: " + e.getMessage());
                    }
                }
        
                return START_STICKY;
            }
        
            private void saveCaCert(String pem) throws Exception {
                File dir = new File(getFilesDir(), "certs");
                if (!dir.exists()) dir.mkdirs();
                FileWriter w = new FileWriter(new File(dir, "ca.pem"));
                w.write(pem);
                w.close();
            }
        
            protected void initializeCharon(Bundle profileData) {
                // This will be overridden by actual strongSwan integration
                // For now, call the parent class methods
                Log.i(TAG, "Initializing charon with server: " + profileData.getString("gateway"));
            }
        
            protected void stopCurrentConnection() {
                Log.i(TAG, "Stopping connection");
            }
        
            private void createNotificationChannel() {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    NotificationChannel ch = new NotificationChannel(CHANNEL_ID, "VPN", NotificationManager.IMPORTANCE_LOW);
                    NotificationManager nm = getSystemService(NotificationManager.class);
                    if (nm != null) nm.createNotificationChannel(ch);
                }
            }
        
            private void showNotification(String text) {
                Intent ni = new Intent(this, MainActivity.class);
                PendingIntent pi = PendingIntent.getActivity(this, 0, ni, PendingIntent.FLAG_IMMUTABLE);
                Notification.Builder nb;
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    nb = new Notification.Builder(this, CHANNEL_ID);
                } else {
                    nb = new Notification.Builder(this);
                }
                Notification n = nb.setContentTitle("IKEv2 VPN").setContentText(text)
                    .setSmallIcon(android.R.drawable.ic_lock_lock)
                    .setContentIntent(pi).setOngoing(true).build();
                startForeground(NOTIF_ID, n);
            }
        }
        JAVAEOF

    - name: Create MainActivity.java
      run: |
        cat > app/src/main/java/com/ikev2client/MainActivity.java << 'JAVAEOF'
        package com.ikev2client;
        
        import android.app.Activity;
        import android.content.ClipData;
        import android.content.ClipboardManager;
        import android.content.Context;
        import android.content.Intent;
        import android.net.ConnectivityManager;
        import android.net.Network;
        import android.net.NetworkCapabilities;
        import android.net.Uri;
        import android.net.VpnService;
        import android.os.Bundle;
        import android.os.Handler;
        import android.os.Looper;
        import android.view.View;
        import android.widget.*;
        import androidx.appcompat.app.AlertDialog;
        import androidx.appcompat.app.AppCompatActivity;
        import java.io.File;
        import java.io.InputStream;
        import java.util.List;
        
        public class MainActivity extends AppCompatActivity implements IKEv2VpnService.StateListener {
        
            private ListView listView;
            private Button disconnectBtn;
            private TextView statusText;
            private List<ProfileManager.Profile> profiles;
            private ProfileManager.Profile pendingProfile;
            private Handler handler;
            private Runnable statusChecker;
            private static final int VPN_REQ = 200;
            private static final int FILE_REQ = 100;
        
            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                setContentView(R.layout.activity_main);
        
                listView = findViewById(R.id.profileList);
                Button importBtn = findViewById(R.id.importButton);
                Button clipboardBtn = findViewById(R.id.clipboardButton);
                disconnectBtn = findViewById(R.id.disconnectButton);
                statusText = findViewById(R.id.statusText);
                handler = new Handler(Looper.getMainLooper());
        
                IKEv2VpnService.setStateListener(this);
                updateStatus(IKEv2VpnService.getCurrentState());
                loadProfiles();
        
                importBtn.setOnClickListener(v -> {
                    Intent i = new Intent(Intent.ACTION_GET_CONTENT);
                    i.setType("*/*");
                    i.addCategory(Intent.CATEGORY_OPENABLE);
                    startActivityForResult(i, FILE_REQ);
                });
        
                clipboardBtn.setOnClickListener(v -> importFromClipboard());
        
                disconnectBtn.setOnClickListener(v -> {
                    Intent i = new Intent(this, IKEv2VpnService.class);
                    i.setAction(IKEv2VpnService.ACTION_DISCONNECT);
                    startService(i);
                });
        
                listView.setOnItemClickListener((p, v, pos, id) -> {
                    if (pos < profiles.size()) {
                        ProfileManager.Profile prof = profiles.get(pos);
                        if (prof.isExpired()) {
                            Toast.makeText(this, "This profile has expired!", Toast.LENGTH_SHORT).show();
                        } else {
                            startVpn(prof);
                        }
                    }
                });
        
                listView.setOnItemLongClickListener((p, v, pos, id) -> {
                    if (pos < profiles.size()) showDetails(profiles.get(pos));
                    return true;
                });
        
                startStatusChecking();
            }
        
            private void startVpn(ProfileManager.Profile profile) {
                pendingProfile = profile;
                Intent vpnIntent = VpnService.prepare(this);
                if (vpnIntent != null) {
                    startActivityForResult(vpnIntent, VPN_REQ);
                } else {
                    connectVpn(profile);
                }
            }
        
            private void connectVpn(ProfileManager.Profile p) {
                Intent i = new Intent(this, IKEv2VpnService.class);
                i.setAction(IKEv2VpnService.ACTION_CONNECT);
                i.putExtra(IKEv2VpnService.EXTRA_SERVER, p.server);
                i.putExtra(IKEv2VpnService.EXTRA_USERNAME, p.username);
                i.putExtra(IKEv2VpnService.EXTRA_PASSWORD, p.password);
                i.putExtra(IKEv2VpnService.EXTRA_CA_CERT, p.caCert);
                i.putExtra(IKEv2VpnService.EXTRA_PROFILE_NAME, p.name);
                i.putExtra(IKEv2VpnService.EXTRA_DNS, p.dns);
                i.putExtra(IKEv2VpnService.EXTRA_IKE_PROPOSAL, p.ikeProposal);
                i.putExtra(IKEv2VpnService.EXTRA_ESP_PROPOSAL, p.espProposal);
                startService(i);
            }
        
            @Override
            public void onStateChanged(String state) { updateStatus(state); }
        
            private void updateStatus(String state) {
                if (state == null) state = "DISCONNECTED";
                statusText.setText("Status: " + state);
                switch (state) {
                    case "CONNECTED":
                        statusText.setTextColor(0xFF4CAF50);
                        disconnectBtn.setVisibility(View.VISIBLE);
                        break;
                    case "CONNECTING":
                        statusText.setTextColor(0xFFFF9800);
                        disconnectBtn.setVisibility(View.VISIBLE);
                        break;
                    default:
                        statusText.setTextColor(0xFF757575);
                        disconnectBtn.setVisibility(View.GONE);
                        break;
                }
            }
        
            private void startStatusChecking() {
                statusChecker = () -> {
                    checkVpnStatus();
                    handler.postDelayed(statusChecker, 2000);
                };
                handler.post(statusChecker);
            }
        
            private void checkVpnStatus() {
                try {
                    ConnectivityManager cm = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);
                    if (cm == null) return;
                    boolean vpn = false;
                    for (Network n : cm.getAllNetworks()) {
                        NetworkCapabilities c = cm.getNetworkCapabilities(n);
                        if (c != null && c.hasTransport(NetworkCapabilities.TRANSPORT_VPN)) { vpn = true; break; }
                    }
                    if (vpn) {
                        statusText.setText("Status: CONNECTED");
                        statusText.setTextColor(0xFF4CAF50);
                        disconnectBtn.setVisibility(View.VISIBLE);
                    }
                } catch (Exception e) {}
            }
        
            @Override
            protected void onActivityResult(int req, int res, Intent data) {
                super.onActivityResult(req, res, data);
                if (req == VPN_REQ) {
                    if (res == Activity.RESULT_OK && pendingProfile != null) connectVpn(pendingProfile);
                    else Toast.makeText(this, "VPN permission denied", Toast.LENGTH_SHORT).show();
                    pendingProfile = null;
                    return;
                }
                if (req == FILE_REQ && res == Activity.RESULT_OK && data != null) {
                    try {
                        InputStream is = getContentResolver().openInputStream(data.getData());
                        StringBuilder sb = new StringBuilder();
                        byte[] buf = new byte[1024]; int len;
                        while ((len = is.read(buf)) > 0) sb.append(new String(buf, 0, len, "UTF-8"));
                        is.close();
                        importProfile(sb.toString().trim());
                    } catch (Exception e) {
                        Toast.makeText(this, "Error: " + e.getMessage(), Toast.LENGTH_LONG).show();
                    }
                }
            }
        
            private void importFromClipboard() {
                try {
                    ClipboardManager cm = (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);
                    if (cm == null || !cm.hasPrimaryClip()) { Toast.makeText(this, "Clipboard empty!", Toast.LENGTH_SHORT).show(); return; }
                    ClipData clip = cm.getPrimaryClip();
                    if (clip == null || clip.getItemCount() == 0) { Toast.makeText(this, "Clipboard empty!", Toast.LENGTH_SHORT).show(); return; }
                    CharSequence text = clip.getItemAt(0).getText();
                    if (text == null || text.length() == 0) { Toast.makeText(this, "Clipboard empty!", Toast.LENGTH_SHORT).show(); return; }
                    importProfile(text.toString().trim());
                } catch (Exception e) { Toast.makeText(this, "Error: " + e.getMessage(), Toast.LENGTH_LONG).show(); }
            }
        
            private void importProfile(String encrypted) {
                try {
                    ProfileManager.Profile p = ProfileManager.loadFromEncryptedString(encrypted);
                    if (p.name == null || p.name.isEmpty()) { Toast.makeText(this, "Invalid profile", Toast.LENGTH_SHORT).show(); return; }
                    File dir = new File(getFilesDir(), "profiles");
                    if (!dir.exists()) dir.mkdirs();
                    ProfileManager.saveToFile(p, new File(dir, p.name + ".ikev2"));
                    Toast.makeText(this, "Profile '" + p.name + "' imported!", Toast.LENGTH_SHORT).show();
                    loadProfiles();
                } catch (Exception e) { Toast.makeText(this, "Import failed: " + e.getMessage(), Toast.LENGTH_LONG).show(); }
            }
        
            private void loadProfiles() {
                profiles = ProfileManager.loadAllProfiles(this);
                if (profiles.size() == 0) {
                    listView.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_list_item_1,
                        new String[]{"No profiles.\nImport a file or paste from clipboard."}));
                    return;
                }
                String[] items = new String[profiles.size()];
                for (int i = 0; i < profiles.size(); i++) {
                    ProfileManager.Profile p = profiles.get(i);
                    items[i] = p.name + "\n" + p.server + " - " + (p.isExpired() ? "EXPIRED" : p.timeRemaining() + " left");
                }
                listView.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, items));
            }
        
            private void showDetails(ProfileManager.Profile p) {
                String st = p.isExpired() ? "EXPIRED" : p.timeRemaining() + " remaining";
                new AlertDialog.Builder(this)
                    .setTitle("Profile Details")
                    .setMessage("Name: " + p.name + "\nServer: " + p.server + "\nUsername: " + p.username + "\nStatus: " + st + "\nExpires: " + p.expireDatetime)
                    .setPositiveButton("OK", null)
                    .setNegativeButton("Delete", (d, w) -> {
                        new File(new File(getFilesDir(), "profiles"), p.name + ".ikev2").delete();
                        Toast.makeText(this, "Deleted", Toast.LENGTH_SHORT).show();
                        loadProfiles();
                    }).show();
            }
        
            @Override protected void onResume() { super.onResume(); IKEv2VpnService.setStateListener(this); loadProfiles(); }
            @Override protected void onDestroy() { super.onDestroy(); if (handler != null) handler.removeCallbacks(statusChecker); }
        }
        JAVAEOF

    - name: Create build workflow
      run: |
        cat > .github/workflows/build.yml << 'EOF'
        name: Build APK
        on:
          push:
            branches: [ main ]
          workflow_dispatch:
        jobs:
          build:
            runs-on: ubuntu-latest
            steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-java@v4
              with:
                java-version: '17'
                distribution: 'temurin'
            - uses: gradle/actions/setup-gradle@v4
              with:
                validate-wrappers: false
            - run: |
                gradle wrapper --gradle-version 8.2
                chmod +x gradlew
                ./gradlew assembleDebug --stacktrace 2>&1 | tee build.log
                tail -50 build.log
            - if: failure()
              run: cat build.log
            - if: success()
              uses: actions/upload-artifact@v4
              with:
                name: IKEv2-Client
                path: app/build/outputs/apk/debug/app-debug.apk
                compression-level: 0
        EOF

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        validate-wrappers: false

    - name: Build
      run: |
        gradle wrapper --gradle-version 8.2
        chmod +x gradlew
        ./gradlew assembleDebug --stacktrace 2>&1 | tee build_output.txt
        echo "=== RESULT ==="
        tail -30 build_output.txt

    - name: Show errors
      if: failure()
      run: |
        cat build_output.txt
        echo "=== JAVA FILES ==="
        find app/src -name "*.java" -type f
        echo "=== SO FILES ==="
        find app/src/main/jniLibs -type f 2>/dev/null || echo "None"

    - name: Commit all files
      if: success()
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -A
        git commit -m "Rebuild project with strongSwan" || true
        git push

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: IKEv2-Client
        path: app/build/outputs/apk/debug/app-debug.apk
        compression-level: 0
