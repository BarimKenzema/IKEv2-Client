name: Rebuild With StrongSwan

on:
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean repo
      run: |
        find . -maxdepth 1 -not -name '.git' -not -name '.github' -not -name '.' -exec rm -rf {} \;

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bison flex gperf build-essential
        yes | sdkmanager "ndk;27.3.13750724" 2>/dev/null || true
        yes | sdkmanager "platforms;android-36" 2>/dev/null || true
        yes | sdkmanager "platforms;android-34" 2>/dev/null || true
        yes | sdkmanager "build-tools;36.0.0" 2>/dev/null || true
        yes | sdkmanager "build-tools;34.0.0" 2>/dev/null || true

    - name: Clone full strongSwan source
      run: |
        git clone --depth 1 https://github.com/strongswan/strongswan.git /tmp/ss-full

    - name: Build OpenSSL for Android
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/27.3.13750724
        export PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

        cd /tmp
        wget -q https://github.com/openssl/openssl/releases/download/openssl-3.4.1/openssl-3.4.1.tar.gz
        tar xzf openssl-3.4.1.tar.gz

        OPENSSL_SRC=/tmp/openssl-3.4.1

        # Build for arm64-v8a
        echo "=== Building OpenSSL for arm64-v8a ==="
        cd $OPENSSL_SRC
        make clean 2>/dev/null || true
        ./Configure android-arm64 -D__ANDROID_API__=21 --prefix=/tmp/openssl-out/arm64-v8a no-shared no-tests no-ui-console 2>&1 | tail -3
        make -j$(nproc) 2>&1 | tail -3
        make install_sw 2>&1 | tail -3

        # Build for armeabi-v7a
        echo "=== Building OpenSSL for armeabi-v7a ==="
        make clean 2>/dev/null || true
        ./Configure android-arm -D__ANDROID_API__=21 --prefix=/tmp/openssl-out/armeabi-v7a no-shared no-tests no-ui-console 2>&1 | tail -3
        make -j$(nproc) 2>&1 | tail -3
        make install_sw 2>&1 | tail -3

        echo "=== OpenSSL build complete ==="
        ls /tmp/openssl-out/arm64-v8a/lib/
        ls /tmp/openssl-out/armeabi-v7a/lib/

    - name: Setup OpenSSL for strongSwan JNI
      run: |
        JNI_OPENSSL=/tmp/ss-full/src/frontends/android/app/src/main/jni/openssl

        mkdir -p $JNI_OPENSSL/arm64-v8a/lib
        mkdir -p $JNI_OPENSSL/arm64-v8a/include
        mkdir -p $JNI_OPENSSL/armeabi-v7a/lib
        mkdir -p $JNI_OPENSSL/armeabi-v7a/include

        cp /tmp/openssl-out/arm64-v8a/lib/libcrypto.a $JNI_OPENSSL/arm64-v8a/lib/
        cp /tmp/openssl-out/arm64-v8a/lib/libssl.a $JNI_OPENSSL/arm64-v8a/lib/
        cp -r /tmp/openssl-out/arm64-v8a/include/openssl $JNI_OPENSSL/arm64-v8a/include/

        cp /tmp/openssl-out/armeabi-v7a/lib/libcrypto.a $JNI_OPENSSL/armeabi-v7a/lib/
        cp /tmp/openssl-out/armeabi-v7a/lib/libssl.a $JNI_OPENSSL/armeabi-v7a/lib/
        cp -r /tmp/openssl-out/armeabi-v7a/include/openssl $JNI_OPENSSL/armeabi-v7a/include/

        # Create the openssl Android.mk
        cat > $JNI_OPENSSL/Android.mk << 'MKEOF'
        LOCAL_PATH := $(call my-dir)

        include $(CLEAR_VARS)
        LOCAL_MODULE := libcrypto_static
        LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/lib/libcrypto.a
        LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/$(TARGET_ARCH_ABI)/include
        include $(PREBUILT_STATIC_LIBRARY)

        include $(CLEAR_VARS)
        LOCAL_MODULE := libssl_static
        LOCAL_SRC_FILES := $(TARGET_ARCH_ABI)/lib/libssl.a
        LOCAL_EXPORT_C_INCLUDES := $(LOCAL_PATH)/$(TARGET_ARCH_ABI)/include
        include $(PREBUILT_STATIC_LIBRARY)
        MKEOF

        echo "=== OpenSSL JNI setup complete ==="
        find $JNI_OPENSSL -type f | head -20

    - name: Run strongSwan configure to generate headers
      run: |
        cd /tmp/ss-full

        # Generate config.h and other required headers
        autoreconf -i 2>&1 | tail -5 || true

        if [ ! -f configure ]; then
          echo "autoreconf failed, creating minimal config.h"
        fi

        # Create Android.common.mk if it doesn't exist
        if [ ! -f Android.common.mk ]; then
          echo "Creating minimal Android.common.mk"
          cat > Android.common.mk << 'EOF'
        strongswan_VERSION := 6.0.0
        EOF
        fi

        # Create config.h for Android
        cat > config.h << 'EOF'
        #define CONFIG_H_INCLUDED
        #define HAVE___BOOL 1
        #define HAVE_STDBOOL_H 1
        #define HAVE_ALLOCA_H 1
        #define HAVE_ALLOCA 1
        #define HAVE_CLOCK_GETTIME 1
        #define HAVE_DLADDR 1
        #define HAVE_PRCTL 1
        #define HAVE_LINUX_UDP_H 1
        #define HAVE_STRUCT_SADB_X_POLICY_SADB_X_POLICY_PRIORITY 1
        #define HAVE_IPSEC_MODE_BEET 1
        #define HAVE_IPSEC_DIR_FWD 1
        #define HAVE_IN6ADDR_ANY 1
        #define HAVE_IN6_PKTINFO 1
        #define HAVE_NETINET_IP6_H 1
        #define MONOLITHIC 1
        #define USE_IKEV1 1
        #define USE_IKEV2 1
        #define USE_BUILTIN_PRINTF 1
        #define DEBUG 1
        #define CHARON_UDP_PORT 0
        #define CHARON_NATT_PORT 0
        #define VERSION "6.0.0"
        #define DEV_RANDOM "/dev/random"
        #define DEV_URANDOM "/dev/urandom"
        EOF

        # Check what Android.common.mk looks like
        echo "=== Android.common.mk ==="
        cat Android.common.mk

    - name: Build strongSwan native libraries
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/27.3.13750724

        cd /tmp/ss-full/src/frontends/android/app/src/main/jni

        echo "=== Starting ndk-build ==="
        $ANDROID_NDK_ROOT/ndk-build \
          APP_ABI="arm64-v8a armeabi-v7a" \
          APP_PLATFORM=android-21 \
          NDK_PROJECT_PATH=/tmp/ss-full/src/frontends/android/app/src/main \
          NDK_APPLICATION_MK=/tmp/ss-full/src/frontends/android/app/src/main/jni/Application.mk \
          -j$(nproc) 2>&1 | tee /tmp/ndk_build.log | tail -50

        echo "=== Built .so files ==="
        find /tmp/ss-full/src/frontends/android/app/src/main/libs -name "*.so" 2>/dev/null || echo "No libs dir"
        find /tmp/ss-full/src/frontends/android/app/src/main/obj -name "*.so" 2>/dev/null || echo "No obj dir"

    - name: Copy project to repo
      run: |
        SS_ANDROID=/tmp/ss-full/src/frontends/android

        # Copy the Android project files
        cp $SS_ANDROID/build.gradle .
        cp $SS_ANDROID/settings.gradle .
        cp $SS_ANDROID/gradle.properties .
        cp -r $SS_ANDROID/gradle .
        cp $SS_ANDROID/gradlew .
        cp $SS_ANDROID/gradlew.bat .
        cp -r $SS_ANDROID/app .

        # Create local.properties
        echo "sdk.dir=$ANDROID_HOME" > local.properties

        chmod +x gradlew

        echo "=== Project files ==="
        ls -la

    - name: Add custom Java files
      run: |
        JAVA_DIR=app/src/main/java/org/strongswan/android

        # Add Crypto.java
        cat > $JAVA_DIR/utils/Crypto.java << 'EOF'
        package org.strongswan.android.utils;

        import android.util.Base64;
        import javax.crypto.Cipher;
        import javax.crypto.spec.IvParameterSpec;
        import javax.crypto.spec.SecretKeySpec;
        import java.security.MessageDigest;
        import java.util.Arrays;

        public class Crypto {
            private static final String MASTER_KEY = "IKEv2SecureProfileKey2025";

            public static String encrypt(String plainText) throws Exception {
                byte[] key = deriveKey(MASTER_KEY);
                byte[] iv = new byte[16];
                Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
                cipher.init(Cipher.ENCRYPT_MODE, new SecretKeySpec(key, "AES"), new IvParameterSpec(iv));
                return Base64.encodeToString(cipher.doFinal(plainText.getBytes("UTF-8")), Base64.NO_WRAP);
            }

            public static String decrypt(String encryptedText) throws Exception {
                byte[] key = deriveKey(MASTER_KEY);
                byte[] iv = new byte[16];
                Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
                cipher.init(Cipher.DECRYPT_MODE, new SecretKeySpec(key, "AES"), new IvParameterSpec(iv));
                return new String(cipher.doFinal(Base64.decode(encryptedText.trim(), Base64.DEFAULT)), "UTF-8");
            }

            private static byte[] deriveKey(String password) throws Exception {
                MessageDigest sha = MessageDigest.getInstance("SHA-256");
                return Arrays.copyOf(sha.digest(password.getBytes("UTF-8")), 16);
            }
        }
        EOF

    - name: Build APK
      run: |
        ./gradlew assembleDebug --stacktrace 2>&1 | tee build_output.txt || true
        echo "=== LAST 80 LINES ==="
        tail -80 build_output.txt

    - name: Check result
      run: |
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          echo "SUCCESS! APK built."
          ls -la app/build/outputs/apk/debug/app-debug.apk
        else
          echo "FAILED - no APK produced"
          echo "=== Full build log ==="
          cat build_output.txt
        fi

    - name: Save build log
      if: always()
      run: |
        cp build_output.txt BUILD_LOG.txt 2>/dev/null || true
        cp /tmp/ndk_build.log NDK_BUILD_LOG.txt 2>/dev/null || true

    - name: Commit
      if: always()
      run: |
        # Clean up large files that shouldn't be in git
        rm -rf app/src/main/jni/openssl 2>/dev/null || true
        rm -rf app/src/main/obj 2>/dev/null || true

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -A
        git commit -m "Build strongSwan Android with patches" || true
        git push || true

    - name: Upload APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: IKEv2-Client
        path: |
          app/build/outputs/apk/debug/app-debug.apk
          BUILD_LOG.txt
          NDK_BUILD_LOG.txt
        compression-level: 0
        if-no-files-found: warn
