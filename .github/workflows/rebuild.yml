name: Rebuild With StrongSwan

on:
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean repo
      run: |
        find . -maxdepth 1 -not -name '.git' -not -name '.github' -not -name '.' -exec rm -rf {} \;

    - name: Clone strongSwan source
      run: |
        git clone --depth 1 https://github.com/nicholass003/strongswan-android.git /tmp/ss-android || true
        
        if [ ! -d /tmp/ss-android/app ]; then
          echo "Trying official repo..."
          git clone --depth 1 https://github.com/nicholass003/strongswan-android-apk.git /tmp/ss-android || true
        fi
        
        if [ ! -d /tmp/ss-android/app ]; then
          echo "Trying strongSwan main repo..."
          git clone --depth 1 https://github.com/strongswan/strongswan.git /tmp/ss-main
          
          echo "=== Android frontend location ==="
          ls -la /tmp/ss-main/src/frontends/android/ 2>/dev/null
          ls -la /tmp/ss-main/src/frontends/android/app/ 2>/dev/null
          
          mkdir -p /tmp/ss-android
          cp -r /tmp/ss-main/src/frontends/android/* /tmp/ss-android/ 2>/dev/null || true
        fi

    - name: Explore structure
      run: |
        echo "========== TOP LEVEL ==========" > EXPLORATION.md
        ls -la /tmp/ss-android/ >> EXPLORATION.md 2>&1
        
        echo "" >> EXPLORATION.md
        echo "========== BUILD FILES ==========" >> EXPLORATION.md
        find /tmp/ss-android -maxdepth 3 -name "build.gradle" -o -name "build.gradle.kts" -o -name "settings.gradle" -o -name "settings.gradle.kts" -o -name "gradlew" -o -name "AndroidManifest.xml" -o -name "Android.mk" 2>/dev/null >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== JAVA FILES ==========" >> EXPLORATION.md
        find /tmp/ss-android -name "*.java" -type f 2>/dev/null >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== AIDL FILES ==========" >> EXPLORATION.md
        find /tmp/ss-android -name "*.aidl" -type f 2>/dev/null >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== JNI FILES ==========" >> EXPLORATION.md
        find /tmp/ss-android -name "*.mk" -type f 2>/dev/null >> EXPLORATION.md
        find /tmp/ss-android -name "*.c" -type f 2>/dev/null | head -20 >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== RES FILES ==========" >> EXPLORATION.md
        find /tmp/ss-android -path "*/res/layout/*" -type f 2>/dev/null >> EXPLORATION.md
        find /tmp/ss-android -path "*/res/values/*" -type f 2>/dev/null >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== FULL TREE (depth 5) ==========" >> EXPLORATION.md
        find /tmp/ss-android -maxdepth 5 -type f 2>/dev/null >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== MAIN REPO ANDROID DIR ==========" >> EXPLORATION.md
        find /tmp/ss-main/src/frontends/android -maxdepth 5 -type f 2>/dev/null >> EXPLORATION.md || true
        
        echo "" >> EXPLORATION.md
        echo "========== CHARONSVC CONTENT ==========" >> EXPLORATION.md
        find /tmp -name "CharonVpnService.java" -exec head -50 {} \; >> EXPLORATION.md 2>/dev/null || echo "Not found" >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== APP BUILD.GRADLE ==========" >> EXPLORATION.md
        find /tmp -path "*/android/app/build.gradle" -exec cat {} \; >> EXPLORATION.md 2>/dev/null || echo "Not found" >> EXPLORATION.md
        
        echo "" >> EXPLORATION.md
        echo "========== SETTINGS.GRADLE ==========" >> EXPLORATION.md
        find /tmp/ss-android -name "settings.gradle" -exec cat {} \; >> EXPLORATION.md 2>/dev/null
        find /tmp/ss-main/src/frontends/android -name "settings.gradle" -exec cat {} \; >> EXPLORATION.md 2>/dev/null || true
        
        echo "" >> EXPLORATION.md
        echo "========== ROOT BUILD.GRADLE ==========" >> EXPLORATION.md
        cat /tmp/ss-android/build.gradle >> EXPLORATION.md 2>/dev/null || true
        cat /tmp/ss-main/src/frontends/android/build.gradle >> EXPLORATION.md 2>/dev/null || true
        
        echo "" >> EXPLORATION.md
        echo "DONE" >> EXPLORATION.md

    - name: Commit results
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -A
        git commit -m "Explore strongSwan Android structure" || true
        git push || true
