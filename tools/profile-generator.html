<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKEv2 VPN Profile Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 8px;
            color: #60a5fa;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .card h2 {
            color: #60a5fa;
            margin-bottom: 16px;
            font-size: 18px;
        }
        .profile-entry {
            background: #0f172a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }
        .profile-entry .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .profile-entry .profile-number {
            font-weight: bold;
            color: #60a5fa;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
            font-weight: 500;
        }
        input, select, textarea {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 10px 12px;
            color: #e2e8f0;
            font-size: 14px;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #60a5fa;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: monospace;
            font-size: 12px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #22c55e; color: white; }
        .btn-success:hover { background: #16a34a; }
        .btn-danger { background: #ef4444; color: white; padding: 6px 12px; font-size: 12px; }
        .btn-secondary { background: #475569; color: white; }
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .passphrase-section {
            display: flex;
            gap: 12px;
            align-items: end;
        }
        .passphrase-section .form-group { flex: 1; }
        .output-section { display: none; }
        .output-section.visible { display: block; }
        .output-text {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            color: #86efac;
            user-select: all;
        }
        .qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            display: inline-block;
            margin: 16px 0;
        }
        .status-msg {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }
        .status-msg.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            color: #86efac;
        }
        .status-msg.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        .expiry-presets {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .expiry-presets button {
            padding: 4px 10px;
            font-size: 11px;
            background: #334155;
            color: #94a3b8;
            border: 1px solid #475569;
            border-radius: 4px;
            cursor: pointer;
        }
        .expiry-presets button:hover {
            background: #475569;
            color: #e2e8f0;
        }
        .profile-count-badge {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .passphrase-section { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>IKEv2 VPN Profile Generator</h1>
    <p class="subtitle">Create encrypted, time-limited VPN profiles</p>

    <div class="card">
        <h2>VPN Profiles <span class="profile-count-badge" id="profileCount">1 profile</span></h2>
        <div id="profilesContainer"></div>
        <div class="actions">
            <button class="btn btn-secondary" onclick="addProfile()">+ Add Another Profile</button>
        </div>
    </div>

    <div class="card">
        <h2>Encryption Settings</h2>
        <div class="passphrase-section">
            <div class="form-group">
                <label>Encryption Passphrase</label>
                <input type="password" id="passphrase" placeholder="Enter a strong passphrase">
            </div>
            <div class="form-group">
                <label>Confirm Passphrase</label>
                <input type="password" id="passphraseConfirm" placeholder="Confirm passphrase">
            </div>
        </div>
        <div class="actions">
            <button class="btn btn-success" onclick="encryptProfiles()">Encrypt and Generate</button>
        </div>
        <div id="statusMsg"></div>
    </div>

    <div class="card output-section" id="outputSection">
        <h2>Encrypted Output</h2>
        <label>Encrypted Data (copy this or scan QR):</label>
        <div class="output-text" id="encryptedOutput"></div>
        <div class="actions">
            <button class="btn btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
            <button class="btn btn-secondary" onclick="downloadAsFile()">Download as File</button>
        </div>
        <div style="margin-top: 20px;">
            <label>QR Code:</label><br>
            <div class="qr-container" id="qrContainer">
                <canvas id="qrCanvas"></canvas>
            </div>
            <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">
                Note: QR codes have a data limit of about 4KB. For many profiles, use paste instead.
            </p>
        </div>
    </div>
</div>

<script>
    // Inline QR Code generator â€” no external library needed
    var QRCode = (function() {
        // QR Code Generator for JavaScript
        // Copyright (c) 2009 Kazuhiko Arase - MIT License
        // Adapted for inline use

        function QR8bitByte(data) { this.data = data; }
        QR8bitByte.prototype = {
            getLength: function() { return this.data.length; },
            write: function(buffer) {
                for (var i = 0; i < this.data.length; i++) {
                    buffer.put(this.data.charCodeAt(i), 8);
                }
            }
        };

        function QRCode(typeNumber, errorCorrectLevel) {
            this.typeNumber = typeNumber;
            this.errorCorrectLevel = errorCorrectLevel;
            this.modules = null;
            this.moduleCount = 0;
            this.dataCache = null;
            this.dataList = [];
        }

        QRCode.prototype = {
            addData: function(data) { this.dataList.push(new QR8bitByte(data)); this.dataCache = null; },
            getModuleCount: function() { return this.moduleCount; },
            isDark: function(row, col) {
                if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) throw new Error(row + "," + col);
                return this.modules[row][col];
            },
            make: function() {
                if (this.typeNumber < 1) {
                    var typeNumber = 1;
                    for (typeNumber = 1; typeNumber < 40; typeNumber++) {
                        var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, this.errorCorrectLevel);
                        var buffer = new QRBitBuffer();
                        var totalDataCount = 0;
                        for (var i = 0; i < rsBlocks.length; i++) totalDataCount += rsBlocks[i].dataCount;
                        for (var i = 0; i < this.dataList.length; i++) {
                            var data = this.dataList[i];
                            buffer.put(4, 4);
                            buffer.put(data.getLength(), QRUtil.getLengthInBits(4, typeNumber));
                            data.write(buffer);
                        }
                        if (buffer.getLengthInBits() <= totalDataCount * 8) break;
                    }
                    this.typeNumber = typeNumber;
                }
                this.moduleCount = this.typeNumber * 4 + 17;
                this.modules = new Array(this.moduleCount);
                for (var row = 0; row < this.moduleCount; row++) {
                    this.modules[row] = new Array(this.moduleCount);
                    for (var col = 0; col < this.moduleCount; col++) this.modules[row][col] = null;
                }
                this.setupPositionProbePattern(0, 0);
                this.setupPositionProbePattern(this.moduleCount - 7, 0);
                this.setupPositionProbePattern(0, this.moduleCount - 7);
                this.setupPositionAdjustPattern();
                this.setupTimingPattern();
                this.setupTypeInfo(false, 0);
                if (this.typeNumber >= 7) this.setupTypeNumber(false);
                if (this.dataCache == null) this.dataCache = QRCode.createData(this.typeNumber, this.errorCorrectLevel, this.dataList);
                this.mapData(this.dataCache, 0);
            },
            setupPositionProbePattern: function(row, col) {
                for (var r = -1; r <= 7; r++) {
                    if (row + r <= -1 || this.moduleCount <= row + r) continue;
                    for (var c = -1; c <= 7; c++) {
                        if (col + c <= -1 || this.moduleCount <= col + c) continue;
                        if ((0 <= r && r <= 6 && (c == 0 || c == 6)) || (0 <= c && c <= 6 && (r == 0 || r == 6)) || (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
                            this.modules[row + r][col + c] = true;
                        } else {
                            this.modules[row + r][col + c] = false;
                        }
                    }
                }
            },
            setupPositionAdjustPattern: function() {
                var pos = QRUtil.getPatternPosition(this.typeNumber);
                for (var i = 0; i < pos.length; i++) {
                    for (var j = 0; j < pos.length; j++) {
                        var row = pos[i]; var col = pos[j];
                        if (this.modules[row][col] != null) continue;
                        for (var r = -2; r <= 2; r++) {
                            for (var c = -2; c <= 2; c++) {
                                if (r == -2 || r == 2 || c == -2 || c == 2 || (r == 0 && c == 0)) this.modules[row + r][col + c] = true;
                                else this.modules[row + r][col + c] = false;
                            }
                        }
                    }
                }
            },
            setupTimingPattern: function() {
                for (var r = 8; r < this.moduleCount - 8; r++) {
                    if (this.modules[r][6] != null) continue;
                    this.modules[r][6] = (r % 2 == 0);
                }
                for (var c = 8; c < this.moduleCount - 8; c++) {
                    if (this.modules[6][c] != null) continue;
                    this.modules[6][c] = (c % 2 == 0);
                }
            },
            setupTypeInfo: function(test, maskPattern) {
                var data = (this.errorCorrectLevel << 3) | maskPattern;
                var bits = QRUtil.getBCHTypeInfo(data);
                for (var i = 0; i < 15; i++) {
                    var mod = (!test && ((bits >> i) & 1) == 1);
                    if (i < 6) this.modules[i][8] = mod;
                    else if (i < 8) this.modules[i + 1][8] = mod;
                    else this.modules[this.moduleCount - 15 + i][8] = mod;
                }
                for (var i = 0; i < 15; i++) {
                    var mod = (!test && ((bits >> i) & 1) == 1);
                    if (i < 8) this.modules[8][this.moduleCount - i - 1] = mod;
                    else if (i < 9) this.modules[8][15 - i - 1 + 1] = mod;
                    else this.modules[8][15 - i - 1] = mod;
                }
                this.modules[this.moduleCount - 8][8] = (!test);
            },
            setupTypeNumber: function(test) {
                var bits = QRUtil.getBCHTypeNumber(this.typeNumber);
                for (var i = 0; i < 18; i++) {
                    var mod = (!test && ((bits >> i) & 1) == 1);
                    this.modules[Math.floor(i / 3)][i % 3 + this.moduleCount - 8 - 3] = mod;
                }
                for (var i = 0; i < 18; i++) {
                    var mod = (!test && ((bits >> i) & 1) == 1);
                    this.modules[i % 3 + this.moduleCount - 8 - 3][Math.floor(i / 3)] = mod;
                }
            },
            mapData: function(data, maskPattern) {
                var inc = -1; var row = this.moduleCount - 1; var bitIndex = 7; var byteIndex = 0;
                for (var col = this.moduleCount - 1; col > 0; col -= 2) {
                    if (col == 6) col--;
                    while (true) {
                        for (var c = 0; c < 2; c++) {
                            if (this.modules[row][col - c] == null) {
                                var dark = false;
                                if (byteIndex < data.length) dark = (((data[byteIndex] >>> bitIndex) & 1) == 1);
                                var mask = QRUtil.getMask(maskPattern, row, col - c);
                                if (mask) dark = !dark;
                                this.modules[row][col - c] = dark;
                                bitIndex--;
                                if (bitIndex == -1) { byteIndex++; bitIndex = 7; }
                            }
                        }
                        row += inc;
                        if (row < 0 || this.moduleCount <= row) { row -= inc; inc = -inc; break; }
                    }
                }
            }
        };

        QRCode.createData = function(typeNumber, errorCorrectLevel, dataList) {
            var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, errorCorrectLevel);
            var buffer = new QRBitBuffer();
            for (var i = 0; i < dataList.length; i++) {
                var data = dataList[i];
                buffer.put(4, 4);
                buffer.put(data.getLength(), QRUtil.getLengthInBits(4, typeNumber));
                data.write(buffer);
            }
            var totalDataCount = 0;
            for (var i = 0; i < rsBlocks.length; i++) totalDataCount += rsBlocks[i].dataCount;
            if (buffer.getLengthInBits() > totalDataCount * 8) throw new Error("code length overflow");
            if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) buffer.put(0, 4);
            while (buffer.getLengthInBits() % 8 != 0) buffer.putBit(false);
            while (true) {
                if (buffer.getLengthInBits() >= totalDataCount * 8) break;
                buffer.put(0xEC, 8);
                if (buffer.getLengthInBits() >= totalDataCount * 8) break;
                buffer.put(0x11, 8);
            }
            return QRCode.createBytes(buffer, rsBlocks);
        };

        QRCode.createBytes = function(buffer, rsBlocks) {
            var offset = 0; var maxDcCount = 0; var maxEcCount = 0;
            var dcdata = new Array(rsBlocks.length); var ecdata = new Array(rsBlocks.length);
            for (var r = 0; r < rsBlocks.length; r++) {
                var dcCount = rsBlocks[r].dataCount; var ecCount = rsBlocks[r].totalCount - dcCount;
                maxDcCount = Math.max(maxDcCount, dcCount); maxEcCount = Math.max(maxEcCount, ecCount);
                dcdata[r] = new Array(dcCount);
                for (var i = 0; i < dcdata[r].length; i++) dcdata[r][i] = 0xff & buffer.buffer[i + offset];
                offset += dcCount;
                var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount);
                var rawPoly = new QRPolynomial(dcdata[r], rsPoly.getLength() - 1);
                var modPoly = rawPoly.mod(rsPoly);
                ecdata[r] = new Array(rsPoly.getLength() - 1);
                for (var i = 0; i < ecdata[r].length; i++) {
                    var modIndex = i + modPoly.getLength() - ecdata[r].length;
                    ecdata[r][i] = (modIndex >= 0) ? modPoly.get(modIndex) : 0;
                }
            }
            var totalCodeCount = 0;
            for (var i = 0; i < rsBlocks.length; i++) totalCodeCount += rsBlocks[i].totalCount;
            var data = new Array(totalCodeCount); var index = 0;
            for (var i = 0; i < maxDcCount; i++)
                for (var r = 0; r < rsBlocks.length; r++)
                    if (i < dcdata[r].length) data[index++] = dcdata[r][i];
            for (var i = 0; i < maxEcCount; i++)
                for (var r = 0; r < rsBlocks.length; r++)
                    if (i < ecdata[r].length) data[index++] = ecdata[r][i];
            return data;
        };

        var QRUtil = {
            PATTERN_POSITION_TABLE: [[], [6, 18], [6, 22], [6, 26], [6, 30], [6, 34], [6, 22, 38], [6, 24, 42], [6, 26, 46], [6, 28, 50], [6, 30, 54], [6, 32, 58], [6, 34, 62], [6, 26, 46, 66], [6, 26, 48, 70], [6, 26, 50, 74], [6, 30, 54, 78], [6, 30, 56, 82], [6, 30, 58, 86], [6, 34, 62, 90], [6, 28, 50, 72, 94], [6, 26, 50, 74, 98], [6, 30, 54, 78, 102], [6, 28, 54, 80, 106], [6, 32, 58, 84, 110], [6, 30, 58, 86, 114], [6, 34, 62, 90, 118], [6, 26, 50, 74, 98, 122], [6, 30, 54, 78, 102, 126], [6, 26, 52, 78, 104, 130], [6, 30, 56, 82, 108, 134], [6, 34, 60, 86, 112, 138], [6, 30, 58, 86, 114, 142], [6, 34, 62, 90, 118, 146], [6, 30, 54, 78, 102, 126, 150], [6, 24, 50, 76, 102, 128, 154], [6, 28, 54, 80, 106, 132, 158], [6, 32, 58, 84, 110, 136, 162], [6, 26, 54, 82, 110, 138, 166], [6, 30, 58, 86, 114, 142, 170]],
            G15: (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0),
            G18: (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0),
            G15_MASK: (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1),
            getBCHTypeInfo: function(data) {
                var d = data << 10;
                while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15) >= 0)
                    d ^= (QRUtil.G15 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G15)));
                return ((data << 10) | d) ^ QRUtil.G15_MASK;
            },
            getBCHTypeNumber: function(data) {
                var d = data << 12;
                while (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18) >= 0)
                    d ^= (QRUtil.G18 << (QRUtil.getBCHDigit(d) - QRUtil.getBCHDigit(QRUtil.G18)));
                return (data << 12) | d;
            },
            getBCHDigit: function(data) {
                var digit = 0;
                while (data != 0) { digit++; data >>>= 1; }
                return digit;
            },
            getPatternPosition: function(typeNumber) { return QRUtil.PATTERN_POSITION_TABLE[typeNumber - 1]; },
            getMask: function(maskPattern, i, j) {
                switch (maskPattern) {
                    case 0: return (i + j) % 2 == 0;
                    case 1: return i % 2 == 0;
                    case 2: return j % 3 == 0;
                    case 3: return (i + j) % 3 == 0;
                    case 4: return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;
                    case 5: return (i * j) % 2 + (i * j) % 3 == 0;
                    case 6: return ((i * j) % 2 + (i * j) % 3) % 2 == 0;
                    case 7: return ((i * j) % 3 + (i + j) % 2) % 2 == 0;
                }
            },
            getErrorCorrectPolynomial: function(errorCorrectLength) {
                var a = new QRPolynomial([1], 0);
                for (var i = 0; i < errorCorrectLength; i++) a = a.multiply(new QRPolynomial([1, QRMath.gexp(i)], 0));
                return a;
            },
            getLengthInBits: function(mode, type) {
                if (1 <= type && type < 10) return 8;
                else if (type < 27) return 16;
                else if (type < 41) return 16;
            }
        };

        var QRMath = {
            glog: function(n) { if (n < 1) throw new Error("glog(" + n + ")"); return QRMath.LOG_TABLE[n]; },
            gexp: function(n) { while (n < 0) n += 255; while (n >= 256) n -= 255; return QRMath.EXP_TABLE[n]; },
            EXP_TABLE: new Array(256), LOG_TABLE: new Array(256)
        };
        for (var i = 0; i < 8; i++) QRMath.EXP_TABLE[i] = 1 << i;
        for (var i = 8; i < 256; i++) QRMath.EXP_TABLE[i] = QRMath.EXP_TABLE[i - 4] ^ QRMath.EXP_TABLE[i - 5] ^ QRMath.EXP_TABLE[i - 6] ^ QRMath.EXP_TABLE[i - 8];
        for (var i = 0; i < 255; i++) QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]] = i;

        function QRPolynomial(num, shift) {
            if (num.length == undefined) throw new Error(num.length + "/" + shift);
            var offset = 0;
            while (offset < num.length && num[offset] == 0) offset++;
            this.num = new Array(num.length - offset + shift);
            for (var i = 0; i < num.length - offset; i++) this.num[i] = num[i + offset];
        }
        QRPolynomial.prototype = {
            get: function(index) { return this.num[index]; },
            getLength: function() { return this.num.length; },
            multiply: function(e) {
                var num = new Array(this.getLength() + e.getLength() - 1);
                for (var i = 0; i < this.getLength(); i++)
                    for (var j = 0; j < e.getLength(); j++)
                        num[i + j] ^= QRMath.gexp(QRMath.glog(this.get(i)) + QRMath.glog(e.get(j)));
                return new QRPolynomial(num, 0);
            },
            mod: function(e) {
                if (this.getLength() - e.getLength() < 0) return this;
                var ratio = QRMath.glog(this.get(0)) - QRMath.glog(e.get(0));
                var num = new Array(this.getLength());
                for (var i = 0; i < this.getLength(); i++) num[i] = this.get(i);
                for (var i = 0; i < e.getLength(); i++) num[i] ^= QRMath.gexp(QRMath.glog(e.get(i)) + ratio);
                return new QRPolynomial(num, 0).mod(e);
            }
        };

        var QRRSBlock = {
            RS_BLOCK_TABLE: [
                [1, 26, 19], [1, 26, 16], [1, 26, 13], [1, 26, 9],
                [1, 44, 34], [1, 44, 28], [1, 44, 22], [1, 44, 16],
                [1, 70, 55], [1, 70, 44], [2, 35, 17], [2, 35, 13],
                [1, 100, 80], [2, 50, 32], [2, 50, 24], [4, 25, 9],
                [1, 134, 108], [2, 67, 43], [2, 33, 15, 2, 34, 16], [2, 33, 11, 2, 34, 12],
                [2, 86, 68], [4, 43, 27], [4, 43, 19], [4, 43, 15],
                [2, 98, 78], [4, 49, 31], [2, 32, 14, 4, 33, 15], [4, 39, 13, 1, 40, 14],
                [2, 121, 97], [2, 60, 38, 2, 61, 39], [4, 40, 18, 2, 41, 19], [4, 40, 14, 2, 41, 15],
                [2, 146, 116], [3, 58, 36, 2, 59, 37], [4, 36, 16, 4, 37, 17], [4, 36, 12, 4, 37, 13],
                [2, 86, 68, 2, 87, 69], [4, 69, 43, 1, 70, 44], [6, 43, 19, 2, 44, 20], [6, 43, 15, 2, 44, 16],
                [4, 101, 81], [1, 80, 50, 4, 81, 51], [4, 50, 22, 4, 51, 23], [3, 36, 12, 8, 37, 13],
                [2, 116, 92, 2, 117, 93], [6, 58, 36, 2, 59, 37], [4, 46, 20, 6, 47, 21], [7, 42, 14, 4, 43, 15],
                [4, 133, 107], [8, 59, 37, 1, 60, 38], [8, 44, 20, 4, 45, 21], [12, 33, 11, 4, 34, 12],
                [3, 145, 115, 1, 146, 116], [4, 64, 40, 5, 65, 41], [11, 36, 16, 5, 37, 17], [11, 36, 12, 5, 37, 13],
                [5, 109, 87, 1, 110, 88], [5, 65, 41, 5, 66, 42], [5, 54, 24, 7, 55, 25], [11, 36, 12, 7, 37, 13],
                [5, 122, 98, 1, 123, 99], [7, 73, 45, 3, 74, 46], [15, 43, 19, 2, 44, 20], [3, 45, 15, 13, 46, 16],
                [1, 135, 107, 5, 136, 108], [10, 74, 46, 1, 75, 47], [1, 50, 22, 15, 51, 23], [2, 42, 14, 17, 43, 15],
                [5, 150, 120, 1, 151, 121], [9, 69, 43, 4, 70, 44], [17, 50, 22, 1, 51, 23], [2, 42, 14, 19, 43, 15],
                [3, 141, 113, 4, 142, 114], [3, 70, 44, 11, 71, 45], [17, 47, 21, 4, 48, 22], [9, 39, 13, 16, 40, 14],
                [3, 135, 107, 5, 136, 108], [3, 67, 41, 13, 68, 42], [15, 54, 24, 5, 55, 25], [15, 43, 15, 10, 44, 16],
                [4, 144, 116, 4, 145, 117], [17, 68, 42], [17, 50, 22, 6, 51, 23], [19, 46, 16, 6, 47, 17],
                [2, 139, 111, 7, 140, 112], [17, 74, 46], [7, 54, 24, 16, 55, 25], [34, 37, 13],
                [4, 151, 121, 5, 152, 122], [4, 75, 47, 14, 76, 48], [11, 54, 24, 14, 55, 25], [16, 45, 15, 14, 46, 16],
                [6, 147, 117, 4, 148, 118], [6, 73, 45, 14, 74, 46], [11, 54, 24, 16, 55, 25], [30, 46, 16, 2, 47, 17],
                [8, 132, 106, 4, 133, 107], [8, 75, 47, 13, 76, 48], [7, 54, 24, 22, 55, 25], [22, 45, 15, 13, 46, 16],
                [10, 142, 114, 2, 143, 115], [19, 74, 46, 4, 75, 47], [28, 50, 22, 6, 51, 23], [33, 46, 16, 4, 47, 17],
                [8, 152, 122, 4, 153, 123], [22, 73, 45, 3, 74, 46], [8, 53, 23, 26, 54, 24], [12, 45, 15, 28, 46, 16],
                [3, 147, 117, 10, 148, 118], [3, 73, 45, 23, 74, 46], [4, 54, 24, 31, 55, 25], [11, 45, 15, 31, 46, 16],
                [7, 146, 116, 7, 147, 117], [21, 73, 45, 7, 74, 46], [1, 53, 23, 37, 54, 24], [19, 45, 15, 26, 46, 16],
                [5, 145, 115, 10, 146, 116], [19, 75, 47, 10, 76, 48], [15, 54, 24, 25, 55, 25], [23, 45, 15, 25, 46, 16],
                [13, 145, 115, 3, 146, 116], [2, 74, 46, 29, 75, 47], [42, 54, 24, 1, 55, 25], [23, 45, 15, 28, 46, 16],
                [17, 145, 115], [10, 74, 46, 23, 75, 47], [10, 54, 24, 35, 55, 25], [19, 45, 15, 35, 46, 16],
                [17, 145, 115, 1, 146, 116], [14, 74, 46, 21, 75, 47], [29, 54, 24, 19, 55, 25], [11, 45, 15, 46, 46, 16],
                [13, 145, 115, 6, 146, 116], [14, 74, 46, 23, 75, 47], [44, 54, 24, 7, 55, 25], [59, 46, 16, 1, 47, 17],
                [12, 151, 121, 7, 152, 122], [12, 75, 47, 26, 76, 48], [39, 54, 24, 14, 55, 25], [22, 45, 15, 41, 46, 16],
                [6, 151, 121, 14, 152, 122], [6, 75, 47, 34, 76, 48], [46, 54, 24, 10, 55, 25], [2, 45, 15, 64, 46, 16],
                [17, 152, 122, 4, 153, 123], [29, 74, 46, 14, 75, 47], [49, 54, 24, 10, 55, 25], [24, 45, 15, 46, 46, 16],
                [4, 152, 122, 18, 153, 123], [13, 74, 46, 32, 75, 47], [48, 54, 24, 14, 55, 25], [42, 45, 15, 32, 46, 16],
                [20, 147, 117, 4, 148, 118], [40, 75, 47, 7, 76, 48], [43, 54, 24, 22, 55, 25], [10, 45, 15, 67, 46, 16],
                [19, 148, 118, 6, 149, 119], [18, 75, 47, 31, 76, 48], [34, 54, 24, 34, 55, 25], [20, 45, 15, 61, 46, 16]
            ],
            getRSBlocks: function(typeNumber, errorCorrectLevel) {
                var rsBlock = QRRSBlock.getRsBlockTable(typeNumber, errorCorrectLevel);
                var list = [];
                for (var i = 0; i < rsBlock.length; i += 3) {
                    var count = rsBlock[i]; var totalCount = rsBlock[i + 1]; var dataCount = rsBlock[i + 2];
                    for (var j = 0; j < count; j++) list.push({totalCount: totalCount, dataCount: dataCount});
                }
                return list;
            },
            getRsBlockTable: function(typeNumber, errorCorrectLevel) {
                switch (errorCorrectLevel) {
                    case 1: return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 0];
                    case 0: return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 1];
                    case 3: return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 2];
                    case 2: return QRRSBlock.RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 3];
                }
            }
        };

        function QRBitBuffer() { this.buffer = []; this.length = 0; }
        QRBitBuffer.prototype = {
            get: function(index) { return ((this.buffer[Math.floor(index / 8)] >>> (7 - index % 8)) & 1) == 1; },
            put: function(num, length) { for (var i = 0; i < length; i++) this.putBit(((num >>> (length - i - 1)) & 1) == 1); },
            getLengthInBits: function() { return this.length; },
            putBit: function(bit) {
                var bufIndex = Math.floor(this.length / 8);
                if (this.buffer.length <= bufIndex) this.buffer.push(0);
                if (bit) this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
                this.length++;
            }
        };

        return QRCode;
    })();

    // ========== PROFILE GENERATOR CODE ==========

    let profileCounter = 0;

    window.addEventListener('DOMContentLoaded', function() { addProfile(); });

    function addProfile() {
        profileCounter++;
        var container = document.getElementById('profilesContainer');
        var id = profileCounter;
        var defaultExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000);
        var expiryStr = formatDateForInput(defaultExpiry);

        var html = '<div class="profile-entry" id="profile-' + id + '">' +
            '<div class="profile-header">' +
            '<span class="profile-number">Profile #' + id + '</span>' +
            (profileCounter > 1 ? '<button class="btn btn-danger" onclick="removeProfile(' + id + ')">Remove</button>' : '') +
            '</div>' +
            '<div class="form-grid">' +
            '<div class="form-group"><label>Profile Name *</label><input type="text" id="name-' + id + '" placeholder="e.g., US Server 1"></div>' +
            '<div class="form-group"><label>Server Address *</label><input type="text" id="server-' + id + '" placeholder="e.g., vpn.example.com"></div>' +
            '<div class="form-group"><label>Remote ID</label><input type="text" id="remoteId-' + id + '" placeholder="Usually same as server"></div>' +
            '<div class="form-group"><label>Auth Method</label><select id="authMethod-' + id + '"><option value="eap-mschapv2">EAP-MSCHAPv2</option><option value="psk">Pre-Shared Key</option></select></div>' +
            '<div class="form-group"><label>Username *</label><input type="text" id="username-' + id + '" placeholder="VPN username"></div>' +
            '<div class="form-group"><label>Password *</label><input type="password" id="password-' + id + '" placeholder="VPN password"></div>' +
            '<div class="form-group"><label>Expiry (UTC) *</label><input type="datetime-local" id="expiry-' + id + '" value="' + expiryStr + '">' +
            '<div class="expiry-presets">' +
            '<button onclick="setExpiry(' + id + ', 30)">30m</button>' +
            '<button onclick="setExpiry(' + id + ', 60)">1h</button>' +
            '<button onclick="setExpiry(' + id + ', 360)">6h</button>' +
            '<button onclick="setExpiry(' + id + ', 1440)">24h</button>' +
            '<button onclick="setExpiry(' + id + ', 4320)">3d</button>' +
            '<button onclick="setExpiry(' + id + ', 10080)">7d</button>' +
            '<button onclick="setExpiry(' + id + ', 43200)">30d</button>' +
            '</div></div>' +
            '<div class="form-group"><label>MTU</label><input type="number" id="mtu-' + id + '" value="1400"></div>' +
            '<div class="form-group"><label>PSK (if PSK auth)</label><input type="text" id="psk-' + id + '" placeholder="Only for PSK auth"></div>' +
            '<div class="form-group full-width"><label>CA Certificate (PEM, optional)</label><textarea id="caCert-' + id + '" placeholder="-----BEGIN CERTIFICATE-----"></textarea></div>' +
            '</div></div>';

        container.insertAdjacentHTML('beforeend', html);
        updateProfileCount();
    }

    function removeProfile(id) {
        var el = document.getElementById('profile-' + id);
        if (el) { el.remove(); updateProfileCount(); }
    }

    function updateProfileCount() {
        var count = document.querySelectorAll('.profile-entry').length;
        document.getElementById('profileCount').textContent = count + ' profile' + (count !== 1 ? 's' : '');
    }

    function formatDateForInput(date) {
        var p = function(n) { return String(n).padStart(2, '0'); };
        return date.getFullYear() + '-' + p(date.getMonth() + 1) + '-' + p(date.getDate()) + 'T' + p(date.getHours()) + ':' + p(date.getMinutes());
    }

    function setExpiry(id, minutes) {
        var expiry = new Date(Date.now() + minutes * 60 * 1000);
        document.getElementById('expiry-' + id).value = formatDateForInput(expiry);
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0;
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    }

    function collectProfiles() {
        var entries = document.querySelectorAll('.profile-entry');
        var profiles = [];
        entries.forEach(function(entry) {
            var id = entry.id.split('-')[1];
            var name = document.getElementById('name-' + id).value.trim();
            var server = document.getElementById('server-' + id).value.trim();
            var remoteId = document.getElementById('remoteId-' + id).value.trim() || server;
            var authMethod = document.getElementById('authMethod-' + id).value;
            var username = document.getElementById('username-' + id).value.trim();
            var password = document.getElementById('password-' + id).value;
            var expiryInput = document.getElementById('expiry-' + id).value;
            var mtu = parseInt(document.getElementById('mtu-' + id).value) || 1400;
            var psk = document.getElementById('psk-' + id).value.trim();
            var caCert = document.getElementById('caCert-' + id).value.trim();
            if (!name || !server || !username || !password || !expiryInput) throw new Error('Profile #' + id + ': All required fields must be filled.');
            var expiryDate = new Date(expiryInput);
            profiles.push({
                id: generateUUID(), name: name, server: server, remote_id: remoteId,
                auth_method: authMethod, username: username, password: password,
                expires_at: expiryDate.toISOString().replace(/\.\d{3}Z$/, 'Z'),
                mtu: mtu, psk: psk || null, ca_cert: caCert || null,
                split_tunneling: false, allowed_apps: null
            });
        });
        return profiles;
    }

    async function deriveKey(passphrase) {
        var encoder = new TextEncoder();
        var hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(passphrase));
        return crypto.subtle.importKey('raw', hashBuffer, { name: 'AES-GCM' }, false, ['encrypt']);
    }

    async function encryptProfiles() {
        var statusEl = document.getElementById('statusMsg');
        try {
            var passphrase = document.getElementById('passphrase').value;
            var confirm = document.getElementById('passphraseConfirm').value;
            if (!passphrase) throw new Error('Passphrase required');
            if (passphrase !== confirm) throw new Error('Passphrases do not match');
            if (passphrase.length < 4) throw new Error('Passphrase too short (min 4 chars)');
            var profiles = collectProfiles();
            var payload = JSON.stringify({ profiles: profiles });
            var key = await deriveKey(passphrase);
            var iv = crypto.getRandomValues(new Uint8Array(12));
            var plaintext = new TextEncoder().encode(payload);
            var ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, plaintext);
            var combined = new Uint8Array(iv.length + ciphertext.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(ciphertext), iv.length);
            var base64 = btoa(String.fromCharCode.apply(null, combined));
            document.getElementById('encryptedOutput').textContent = base64;
            document.getElementById('outputSection').classList.add('visible');
            generateQR(base64);
            statusEl.className = 'status-msg success';
            statusEl.textContent = 'Encrypted ' + profiles.length + ' profile(s). Size: ' + base64.length + ' chars.';
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            statusEl.className = 'status-msg error';
            statusEl.textContent = 'Error: ' + error.message;
        }
    }

    function generateQR(data) {
        var container = document.getElementById('qrContainer');
        if (data.length > 2953) {
            container.innerHTML = '<p style="color:#666;padding:20px;">Data too large for QR (' + data.length + ' chars). Use copy/paste.</p>';
            return;
        }
        try {
            var qr = new QRCode(0, 1);
            qr.addData(data);
            qr.make();
            var size = qr.getModuleCount();
            var scale = Math.max(2, Math.floor(300 / size));
            var canvas = document.createElement('canvas');
            canvas.width = size * scale;
            canvas.height = size * scale;
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000000';
            for (var row = 0; row < size; row++) {
                for (var col = 0; col < size; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(col * scale, row * scale, scale, scale);
                    }
                }
            }
            container.innerHTML = '';
            container.appendChild(canvas);
        } catch (e) {
            container.innerHTML = '<p style="color:#e74c3c;">QR generation failed: ' + e.message + '. Use copy/paste.</p>';
        }
    }

    function copyToClipboard() {
        var text = document.getElementById('encryptedOutput').textContent;
        navigator.clipboard.writeText(text).then(function() {
            alert('Copied to clipboard!');
        }).catch(function() {
            var ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            alert('Copied!');
        });
    }

    function downloadAsFile() {
        var text = document.getElementById('encryptedOutput').textContent;
        var blob = new Blob([text], { type: 'text/plain' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'vpn-profiles-' + new Date().toISOString().slice(0, 10) + '.encrypted';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
